## 一、数据库
### 1.铁塔设备类型映射表
主键|内部设备类型|铁塔设备类型
--|--|--
pk|type|cntb_type

### 2.铁塔数据点模板表
主键|铁塔设备类型|铁塔信号ID|类型|是否简易信号点|内部信号ID
--|--|--|--|--|--
pk|cntb_type|cntb_id|type|simpleEnable|id

### 3.铁塔告警点模板表(需要存储“告警等级”与“告警描述”，告警描述为模板，需根据触发值进行拼接后上报)
主键|铁塔设备类型|铁塔信号ID|类型|是否简易信号点|告警等级|告警描述|内部告警ID
--|--|--|--|--|--|--|--
pk|cntb_type|cntb_id|type|simpleEnable|alarmLevel|alarmDesc|id

### 4.运营商名称字典表(用于保存 CT：电信，CM：移动，CU：联通)
主键|内部上报类型|铁塔上报类型
--|--|--
pk|type|cntb_type

### 5.铁塔站点表
主键|FSUID|SN|站点名称|地址|详情|状态|字典表模式|VPN信息(用于判断注册报文中上报的IP)|是否接触绑定|解绑时间
--|--|--|--|--|--|--|--|--|--|--
pk|fsuid|sn|name|address|desc|status|dictMode|vpnName|disabled|disabledTime

### 6.站点参数表(绑定时生成一份默认的配置)
主键|站点表主键(外键)|心跳间隔|心跳超时次数|注册上限(未使用)|注册间隔(秒)|告警间隔|告警上报上限|
--|--|--|--|--|--|--|--
pk|station_pk|heartbeatInterval|heartbeatTimeoutLimit|loginLimit|loginInterval|alarmInterval|alarmReportLimit

### 7.站点设备表(该表内容是由程序自动匹配，绑定时写入deviceId，内部服务上报设备信息后补充port, type, resNo)
主键|站点表主键(外键)|铁塔设备ID|适配层端口|内部设备类型|资源编号
--|--|--|--|--|--
pk|station_pk|deviceId|port|type|resNo

### 8.历史数据表(每隔一定时间，将redis中所有站点下所有设备的数据信息存入数据库；主动获取数据时需提供SN、设备端口号、设备类型与资源编号)
主键|FSUID|铁塔设备ID|铁塔信号ID|值|记录时间
--|--|--|--|--|--
pk|fsuid|deviceId|cntb_id|value|recordTime

### 9.告警表
主键|告警序列号|FSUID|铁塔设备ID|告警时间|恢复时间|告警等级|告警描述|触发值|开始告警上报时间|结束告警上报时间|开始告警是否上报成功|结束告警是否上报成功
--|--|--|--|--|--|--|--|--|--|--|--|--
pk|serialNo|fsuid|deviceId|alarmTime|recoverTime|level|desc|eventValue|beginAlarmReportTime|endAlarmReportTime|startReported|endReported

### 10.vpn对照表
主键|VPN名称(用户绑定的vpn名称)|服务器自身vpn名称(用于获取对应IP)|铁塔注册机IP|铁塔注册机端口
--|--|--|--|--|--
pk|vpnName|localName|loginIp|loginPort
	
## 二、redis
### 1.终端在线记录(该记录存在说明终端在线)
***SN***|FSUID|平台IP|平台端口|铁塔是否在线|心跳间隔|超时心跳次数|最后一次收到铁塔报文时间|上次注册时间|注册间隔|告警间隔|告警上报次数上限|注册机IP|注册机端口|本地VPN名称|上报告警IP(该IP为注册成功时铁塔下发)
--|--|--|--|--|--|--|--|--|--|--|--|--|--|--|--
***sn***|fsuid|ip|port|online|heartbeatInterval|heartbeatTimeoutLimit|lastTimeRecvTowerMsg|lastTimeLogin|loginInterval|alarmInterval|alarmReportLimit|loginIp|loginPort|localName|alarmIp

### 2.铁塔在线记录(该记录存在说明铁塔在线，提供通过FSUID查找SN功能)
***FSUID***|SN
--|--
***fsuid***|sn

### 3.告警记录(redis中的告警均为未上报告警)
***告警序列号***|FSUID|铁塔设备ID|告警时间|恢复时间|告警等级|告警描述|触发值|开始告警上报时间|结束告警上报时间|开始告警是否上报成功|结束告警是否上报成功|上报次数
--|--|--|--|--|--|--|--|--|--|--|--|--
***serialNo***|fsuid|deviceId|alarmTime|recoverTime|level|desc|eventValue|beginAlarmReportTime|endAlarmReportTime|startReported|endReported|reportCount

### 4.实时数据记录
***FSUID***|铁塔设备ID|铁塔信号ID|值
--|--|--|--
***fsuid***|deviceId|cntb_id|value

### 5.服务器VPNIP记录
***本地VPN名称***|VPN自动分配的IP
--|--
***localName***|ip

6.问题
>若redis崩溃，则需从数据库中取出startReported或endReported为false的告警信息，存入redis中(如何检测redis崩溃？)

>当redis或数据库其中一方在更新时发生错误，如何保证两边数据一致性

## 三、服务启动时
### 1.redis与数据库同步
>需将数据库中startReported == false || endReported == false的告警信息，存入redis中

### 2.监控线程
>启动VPN监控线程(检测VPN连接是否存在，自动重拨，同时存在多个VPN，通过localName区分，连接后读取ip，存入redis)

## 四、定时器(存在多个服务时，定时器会不会导致任务重复执行？)
### 1.间隔一定时间，需判断是否存在平台在线铁塔离线的设备，并向铁塔注册(新增判断铁塔离线功能)
* 获取redis中 lastTimeRecvTowerMsg + heartbeatInterval * heartbeatTimeoutLimit > now 的记录
	* 若存在，online = false 并将redis中的铁塔在线记录删除
* 获取redis中 (online == false && localName对应ip存在 && now > lastTimeLogin + loginInterval) 的记录
	* 若存在，则获取注册所需信息，发送注册报文，lastTimeLogin = now(信息来源：平台，数据库，服务器ip)
		* 若注册成功，online = true，在redis中保存回复报文中的SCIP(即alarmIp)，新增铁塔在线记录
* 注册所需信息：(部分信息需主动获取 ***interface***)
	* UserName：
	* PaSCword：
	* FsuId：(SN与FSUID绑定时导入)
	* IP：(上报CNTB网关的IP)
	* MacId：无线模块的MAC地址(使用IMEI)(上报)
	* ImsiId：IMSI卡号(上报)
	* NetworkType：当前网络制式(2G、3G、4G)(上报)
	* Carrier：运营商名称(枚举值，CT：电信，CM：移动，CU：联通)(上报后自行匹配)
	* NMVendor：上网模块厂商名称(上报)
	* NMType：上网模块型号(上报)
	* Reg_Mode：注册模式(枚举值，1：原有注册模块，2：新的注册械)，可为空，为空表示采用原有的注册模式 固定为2
	* FSUVendor：FSU的厂家名称(TDYY)
	* LockedNetworkType：已锁定网络制式(AUTO)
	* FSUType：FSU的型号(上报)
	* FSUClass：FSU的应用类型(枚举值)(SN与FSUID绑定时导入)
	* Version：FSU的软件版本(上报)
	* DictVersion：信号量字典版本(枚举值，1：标准版，适用3/4G信号的基站；2：精减版，适用2G信号的基站，默认1)
	* DeviceList：(SN与FSUID绑定时导入)

### 2.间隔一定时间，需判断redis中是否存在未上报告警
* 判断时间，若为0点，将redis中所有告警上报次数置为0
	* 0点时，新增标志位判断，若标志位为false，则次数置0，标志位置true
	* 非0点且标志位为true时，置标志位为false
* 从redis中查找 startReported == false && reportCount >= 0 的告警信息
	* 根据beginAlarmReportTime与alarmInterval判断是否上报告警
		* 若上报，则更新数据库与redis中的beginAlarmReportTime
			* 若上报成功，更新数据库与redis中的startReported为true，redis中reportCount变更为0
			* 若上报失败
			~~~
				++reportCount; 
				if (reportCount >= alarmReportLimit) 
					reportCount = -1
			~~~
* 从redis中查找 startReported == true && endReported == false && reportCount >= 0 的告警信息
	* 根据endAlarmReportTime与alarmInterval判断是否上报告警
		* 若上报，则更新数据库与redis中的endAlarmReportTime
			* 若上报成功，更新数据库与redis中的endReported为true，删除redis中该告警信息
			* 若上报失败，则不进行更新
			~~~
				* ++reportCount; 
				* if (reportCount >= alarmReportLimit) 
					* reportCount = -1
			~~~
* 告警信息：
	* SerialNo：告警序列号
	* Id：监控点ID
	* FSUID：
	* FsuCode：
	* DeviceId：
	* DeviceCode：
	* AlarmTime：告警时间，YYYY-MM-DD<SPACE键>hh:mm:ss(采用24小时的时间制式)
	* AlarmLevel：告警级别
	* AlarmFlag：告警标志
	* AlarmDesc：告警的事件描述

### 3.间隔一定时间，定时将redis中的实时数据存入数据库历史数据表中
* 获取redis中所有数据信息，将fsuid、deviceId、cntb_id、value和now存入数据库历史数据表中
	
## 五、铁塔下发
### 1.心跳包测试(1701)
* 从redis中获取FSUID对应的SN
	* 若不存在，则不回复
* 判断FSU是否在线
	* 若不在线，则不回复
* 更新redis中 lastTimeRecvTowerMsg = now
	* 将FSUID转为SN，找到CPUUsage与MEMUsage对应设备的port、type、resNo，信号点信息
	* 内部服务获取CPUUsage与MEMUsage信息(***interface***)
		* 获取成功，则回复成功信息
		* 获取失败，删除redis中的对应记录
* 所需信息：
	* CPUUsage：CPU使用率
	* MEMUsage：内存使用率
		
### 2.时间同步(1301)
* 从redis中获取FSUID对应的SN
	* 若不存在，则不回复
* 判断FSU是否在线
	* 若不在线，则不回复
* 更新redis中 lastTimeRecvTowerMsg = now
* 回复成功
	
### 3.监控点数据获取(401)
* 从redis中获取FSUID对应的SN
	* 若不存在，则不回复
* 判断FSU是否在线
	* 若不在线，则不回复
* 更新redis中 lastTimeRecvTowerMsg = now
* 从redis中取出指定设备的数据信息返回给铁塔
* 所需信息：
	* DeviceId：
	* Id：监控点ID
	* Type：数据类型
	* MeasuredVal：实测值
	* SetupVal：设置值(默认填空)
	* Status：状态(默认填0)
	
### 4.写监控点设置(1001)(***interface***)
* 从redis中获取FSUID对应的SN
	* 若不存在，则不回复
* 判断FSU是否在线
	* 若不在线，则不回复
* 更新redis中 lastTimeRecvTowerMsg = now
* 通过SN与铁塔下发设备ID获取对应设备信息、通过SignalID获取对应内部信号点ID
	* 获取失败，则该点设置失败
* 通过接口进行设置
* 根据设置结果进行回复
	
### 5.获取监控点门限(1901)(***interface***)
* 从redis中获取FSUID对应的SN
	* 若不存在，则不回复
* 判断FSU是否在线
	* 若不在线，则不回复
* 更新redis中 lastTimeRecvTowerMsg = now
* 通过铁塔设备ID获取对应的内部设备ID
* 通过铁塔门限ID获取对应的内部告警点ID
* 通过接口获取告警点门限值
* 根据获取结果进行回复
* 所需信息：
	* DeviceId：
	* Id：门限点ID
	* Type：数据类型
	* Threshold：门限值
	* AbsoluteVal：绝对阈值(可填空)
	* RelativeVal：相对阈值(可填空)
	* Status：状态(默认填0)
	
### 6.设置监控点门限(2001)(***interface***)
* 从redis中获取FSUID对应的SN
	* 若不存在，则不回复
* 判断FSU是否在线
	* 若不在线，则不回复
* 更新redis中 lastTimeRecvTowerMsg = now
* 通过SN与铁塔下发设备ID获取对应设备信息、获取对应内部告警点ID
	* 获取失败，则该点设置失败
* 通过接口进行设置
* 根据设置结果进行回复
	
### 7.监控点历史数据(403)
* 从redis中获取FSUID对应的SN
	* 若不存在，则不回复
* 判断FSU是否在线
	* 若不在线，则不回复
* 更新redis中 lastTimeRecvTowerMsg = now
* 从历史数据表中取出指定设备指定时间内的数据信息返回给铁塔
* 所需信息：
	* DeviceId：
	* Id：监控点ID
	* Type：数据类型
	* MeasuredVal：实测值
	* SetupVal：设置值(默认填空)
	* Status：状态(默认填0)
	* RecordTime：记录时间

## 六、内部服务上报
### 1.注册接口(101)(***interface***)
* 接收内部服务上报SN
* 判断该SN是否存在
	* 若redis中不存在，在数据库中查找SN为绑定状态的对应记录
		* 若数据库中存在，则将其新增到redis中，online = false(铁塔平台离线)
		* 若数据库中不存在，结束处理流程，向平台返回失败0
* 将上报的设备信息与铁塔设备ID进行绑定，更新数据库
		
### 2.告警上报(501)(当终端离线或铁塔离线时，不会上报告警；当终端未绑定时，不会保存告警)(***interface***)
* 接收告警信息，根据告警点id在告警模板表中查找告警等级，根据触发值拼接告警描述，判断告警类型
	* 若为start，则数据库与redis中新增告警，recoverTime、beginAlarmReportTime, endAlarmReportTime为空，startReported, endReported为false，redis中多存一个告警上报失败次数(reportCount)
	* 若为end，则根据serialNo在数据库与redis中找到对应start告警信息，写入recoverTime

### 3.数据上报(***interface***)
* 接收数据上报信息，判断该SN是否存在
	* 若数据库中不存在SN绑定记录，返回0
	* 若数据库中存在绑定记录，redis中不存在，返回0
* 根据上报的设备与信号点，匹配对应的铁塔设备ID与铁塔信号点
	* 若匹配失败，则不更新数据
	* 若匹配成功，则更新redis中对应点数据

### 4.SN绑定(***interface***)
* 需绑定信息：
	* fsuid：
	* sn：
	* deviceList：
	* name：站点名称
	* address：站点地址
	* desc：站点描述
	* status：站点状态(测试态，交维态，不保存，需显示时获取 ***interface***)
	* dictMode：信号字典表模式
	* loginIp：铁塔注册服务器IP
	* loginPort：铁塔注册服务器端口
	* heartbeatInterval：铁塔平台心跳周期(秒)
	* heartbeatTimeoutLimit：心跳超时次数上限
	* loginLimit：注册次数上限
	* loginInterval：注册间隔(秒)
	* alarmReportLimit：单条告警上报次数上限
	* alarmReportInterval：告警上报间隔(秒)
* 绑定流程：
	* 判端FSUID是否已绑定SN
		* 若存在，且绑定SN与输入SN相同，则更新该条记录对应的信息
			* 若redis中存在对应记录，更新redis中的localName和loginInterval
		* 若存在，且绑定SN与输入SN不同，则将该条绑定状态置为解绑，并记录解绑时间，从redis中删除对应记录，然后进入新增流程
		* 若不存在，则新增记录，新增对应导入信息
			* 在数据库中新增记录

### 5.SN解绑(***interface***)
* 判断SN是否已绑定FSUID
	* 若未绑定，则回复成功
	* 若已绑定，则将数据库中解绑标志位置1，记录解绑时间
	* 若redis存在记录，则删除

## 七、接口
### 1.与内部服务接口
* 注册时获取所需信息，参见4.1 
* 铁塔下发心跳时，获取CPUUsage与MEMUsage信息，参见5.1
* 写监控点设置，参见5.4
* 获取监控点门限，参见5.5
* 设置监控点门限，参见5.6
* 注册接口，参见6.1
* 告警上报，参见6.2
* 数据上报，参见6.3
* SN绑定，参见6.4
* 获取站点状态，参见6.4
* SN解绑，参见6.5