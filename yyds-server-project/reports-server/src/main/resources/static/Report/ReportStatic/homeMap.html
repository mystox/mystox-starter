<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript" src="http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils.js"></script>
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title></title>
  <style>
  html, body, .alarm-map {
    width:100%;
    height:100%;
    margin: 0;
    background-color:#000037 !important;
  }
  #location {
    position:absolute;
    top:10px;
    left:10px;
    pointer-events:none;
    font-size:36px;
    color:#fff;
  }
  #site-detail {
    display:none;
    position:fixed;
    width:300px;
    padding:10px;
    border-radius:4px;
    z-index:1000;
    background-color:rgba(0,0,0,0.5);
    color:#fff;
  }
  .alarm-icon {
    width:40px;
    height:40px;
    position:absolute;
    cursor:pointer;
  }
  .alarm-icon:before {
    content:" ";
    position:absolute;
    z-index:-1;
    margin-left:-12.5%;
    margin-top:-12.5%;
    left:50%;
    top:50%;
    width:25%;
    height:25%;
    border-radius:50%;
  }
  .alarm-icon:after {
    content:" ";
    position:absolute;
    z-index:-1;
    width:10px;
    height:10px;
    border-radius:50%;
    box-shadow:0 0 10px rgba(0,0,0,0.3) inset;
    -webkit-animation-name:"ripple";
    -webkit-animation-duration:1s;
    -webkit-animation-timing-function:ease;
    -webkit-animation-delay:0s;
    -webkit-animation-iteration-count:infinite;
    -webkit-animation-direction:normal;
  }
  .alarm-icon.level0:after { content:none; }
  .alarm-icon.level0:before { background-color:#38c2ff; }
  .sigle-site { cursor:pointer; }
  .sigle-site .alarm-icon {
    margin-left:-15px;
    margin-top:-15px;
  }
  .sigle-site .name {
    position:absolute;
    top:8px;
    color:#fff;
    left:-495px;
    width:1000px;
    text-align:center;
    display:none;
    pointer-events:none;
  }
  .sigle-site:hover .name { display:block; }
  @keyframes ripple {
    0% {
      left:50%;
      top:50%;
      opcity:75;
      width:0;
      height:0;
    }
    100% {
      left:0;
      top:0;
      opacity:0;
      width:100%;
      height:100%;
    }
  }
  .alarm-icon.level1:before { background-color:#ff002a; }
  .alarm-icon.level1:after { background-color:#ff002a; }
  .alarm-icon.level2:before { background-color:#fc7e0c; }
  .alarm-icon.level2:after { background-color:#fc7e0c; }
  .alarm-icon.level3:before { background-color:#efd044; }
  .alarm-icon.level3:after { background-color:#efd044; }
  .alarm-icon.level4:before { background-color:#38c2ff; }
  .alarm-icon.level4:after { background-color:#38c2ff; }
  </style>
</head>
<body>
  <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Zex6o5pzxTxYqtx9MGM6Z97u"></script>
  <script src="./chinaGeoJson.js"></script>
  <script src="./chinaTree.js"></script>
  <script src="./homeMap.js"></script>
  <script src="./TextIconOverlay.js"></script>
  <script src="./MarkerClusterer.js"></script>


  <script>
var isResized = false;
var MAP = {
  getCoordinate: function getCoordinate() {
    var _this2 = this;

    // reportService.getCoordinateList(function(data) {
    (function () {
      var data = [{
        "site": {
          "strId": "5b3ed360563e7607d37bdc86",
          "name": "八拜西南",
          "phone": null,
          "company": null
        },
        "longitude": 120.786233,
        "latitude": 30.737429,
        "level1": 0,
        "level2": 3,
        "level3": 2,
        "level4": 0
      }];
      _this2.alarmData = data; // 如果是上一次操作时的Id则会找不到Dom，直接return。其他图表一样。

      if (!document.getElementById(_this2.alarmMapId)) {
        return;
      }

      setTimeout(function () {
        _this2.renderMap();
      }, 300);
    })();

    var locateTimeout = null;
    setTimeout(function () {
      _this2.map = createHomeMap({
        alarmMapId: _this2.alarmMapId,
        locateCallback: function locateCallback(tier) {
          var _this3 = this;

          if (locateTimeout) {
            clearTimeout(locateTimeout);
          }

          locateTimeout = setTimeout(function () {
            _this3.curTier = tier; // renderAllModuleWithTier($scope.curTier);

            locateTimeout = null;
          }, 50);
        }
      }); // **********
      // $(".center")[0].addEventListener("wheel", function(e) {
      //   e.stopPropagation();
      // });
    }, 0);
  },
  // scloud 抄过来的方法
  renderMap: function renderMap() {
    var _this4 = this;

    var data = this.alarmData;
    var option = {
      alarm: [1, 1, 1, 1, 1]
    };
    ;

    function Marker(point, mouseoverText, alarmLevel, site) {
      this._point = point;
      this._overText = mouseoverText;
      this.site = site;
      this.topAlarm = alarmLevel;
    }

    Marker.prototype = Object.assign(new BMap.Overlay(), {
      getPosition: function getPosition() {
        return this._point;
      },
      getMap: function getMap() {
        return this._map;
      },
      initialize: function initialize(map) {
        this._map = map;

        var _div = document.createElement('div');

        _div.innerHTML = '<div style="position:absolute;width:20px;height:20px;" class="sigle-site">' + '<div style="pointer-events:none" class="alarm-icon level' + this.topAlarm + '"></div>' + "</div>";

        var _this = this;

        var div = this._div = _div;
        div.addEventListener("mouseenter", function (e) {
          div.isHide = false;
          var detail = _this.detail;

          function updateView() {
            document.getElementById("site-detail").innerHTML = "基站编号：" + (detail.baseStationNumber || "") + " <br/>" + "站点名称：" + detail.name + " <br/>" + "站点状态：FSU " + (detail.fsuState ? "在线" : "离线") + " <br/>" + "告警数量：" + detail.alarmNum + " <br/>" + "经纬度：" + (detail.coordinate || "-") + " <br/>" + "站点地址：" + (detail.address || "-") + "";
            document.getElementById("site-detail").setAttribute('style', "\n                  left: ".concat(isResized ? (e.pageX - 0) / 1.3 + 10 : e.offsetX + e.pageX, "px;\n                  top: ").concat(isResized ? (e.pageY - 56) / 1.3 + 10 : e.offsetY + e.pageY - document.getElementById("site-detail").offsetHeight, "px;\n                  display: ").concat(div.isHide ? 'none' : 'block', ";\n                "));
          }

          if (!_this.detail) {
            (function () {
              _this.detail = detail = data;
              updateView();
            })();
          } else {
            updateView();
          }
        });
        div.addEventListener("mouseleave", function () {
          div.isHide = true;
          document.getElementById("site-detail").setAttribute('style', 'display:none;');
        }); // div.addEventListener("click", function() {
        //   $scope.go("scene/site", {
        //     siteIdList: [_this.site.site.strId],
        //     tier: $scope.curTier
        //   });
        // });

        div.addEventListener("mousemove", function (e) {
          e.stopPropagation();
        });
        map.getPanes().labelPane.appendChild(div);
        return div;
      },
      draw: function draw() {
        var map = this._map;
        var pixel = map.pointToOverlayPixel(this._point);
        this._div.style.top = pixel.y - 10 + "px";
        this._div.style.left = pixel.x - 10 + "px";
        this._div.style.position = 'absolute';
      }
    });

    if (this.points) {
      this.points.dispose();
    }

    var markers = [];
    var pt = null;
    var i = 0;
    data.filter(function (v) {
      return v.longitude && v.latitude && (option.alarm[0] || option.alarm[1] && v.level1 || option.alarm[2] && v.level2 || option.alarm[3] && v.level3 || option.alarm[4] && v.level4);
    }).forEach(function (v) {
      pt = new BMap.Point(v.longitude, v.latitude);
      var mark = new Marker(pt, v.site.name, v.level1 && option.alarm[1] ? 1 : v.level2 && option.alarm[2] ? 2 : v.level3 && option.alarm[3] ? 3 : v.level4 && option.alarm[4] ? 4 : 0, v); // mark = new BMap.Marker(pt)

      mark._domElement = document.createElement("div");
      mark._domElement.className = "alarm-icon level3";
      markers.push(mark);
    }); //最简单的用法，生成一个marker数组，然后调用markerClusterer类即可。

    this.points = new BMapLib.MarkerClusterer(this.map, {
      markers: markers,
      minClusterSize: 2,
      maxZoom: 15,
      isAverageCenter: true,
      styles: new Array(20).fill('').map(function (v, i) {
        var size = [70, 90, 110, 130, 150][i % 5];
        return {
          size: new BMap.Size(size, size),
          textColor: '#051d4c'
        };
      })
    });
    setTimeout(function () {
      _this4.points._redraw();
    }, 500);
  }
};
setTimeout(function () {
  var timestamp = Math.floor(new Date().getTime() / 1000);
  var alarmMapId = 'alarmMap' + timestamp;
  document.querySelector('.alarm-map').setAttribute('id', alarmMapId);
  MAP.alarmMapId = alarmMapId;
  MAP.getCoordinate();
}, 50);
 </script>

  <div class="alarm-map"></div>
  <div id="location"></div>
  <div id="site-detail"></div>

</body>
</html>