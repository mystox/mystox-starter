scloudApp.controller("alarmListController",["$scope","$rootScope","$stateParams","treeService","alarmService","alarmFilterService","deviceService","signalService","workService",function(e,a,t,r,i,n,o,l,u){function s(){e.isSelectAll=!1,e.isLoading=!0,e.isLoadingChart=!0,i.getAlarmList(e.paginationConf,e.alarmQuery,function(a){e.openDetailIndex=null,e.alarmList=a.list,e.paginationConf.totalItems=a.count,e.isLoading=!1},function(){e.isLoading=!1}),i.getAlarmListChart(e.alarmQuery,function(a){e.alarmNameList=m(a.nameList),d(a.tierList),p(a.levelList),e.isLoadingChart=!1})}function c(){e.isSelectAll2=!1,e.isLoading2=!0,i.getAlarmList(e.paginationConf2,e.alarmChartQuery,function(a){e.isLoading2=!1,e.openDetailIndex2=null,e.alarmList2=a.list,e.paginationConf2.totalItems=a.count},function(){e.isLoading2=!1})}function m(e){var a=0;e[0]&&(a=e[0].value);for(var t=0;t<5;t++)e[t]?e[t].percent=100*e[t].value/a:e[t]={percent:0,value:0,key:null};return e}function d(a){e.alarmTierList=a;for(var t=[],r=[],i=[],n=0;n<5;n++)a[n]?(t.push(a[n].key),r.push(a[n].value),i.push(a[n].value)):(t.push("-"),r.push(0),i.push(0));var o={id:"alarmTierTop5",xAxis:{data:t},series:{data:r,pinData:i},callback:e.queryByArea};chart.alarmTierTop5(o)}function p(t){for(var r=0,i=0;i<t.length;i++)r+=t[i].value;0===r&&(r=1);for(var n=[],i=0;i<t.length;i++)n.push({name:t[i].key,value:t[i].value,else:r-t[i].value});var o={id:"alarmLevel",color:a.CONST.alarmColorList,series:n,callback:e.queryByAlarmLevel};chart.alarmLevel(o)}$state&&($state=window.$state),t&&(t=window.$stateParams),e.CURRENT_ALARM=a.CONST.alarmStateList[0].key,e.HISTORY_ALARM=a.CONST.alarmStateList[1].key,e.tabPage=a.util.tabPage.getInstance(["告警统计","告警列表"]),e.treeService=r,e.alarmQuery={alarmLevel:t.alarmLevel,checkedState:t.checkedState,deviceCode:t.deviceCode,alarmState:t.alarmState||e.CURRENT_ALARM},"list"===t.startView&&(e.tabPage.currentIndex=1),e.alarmChartQuery={alarmName:null,siteIds:null,siteCode:null,alarmLevel:null},e.isLoading=!1,e.isLoading2=!1,e.eliminateAlarm={form:{},obj:{},toModal:null,execute:null,clear:null},e.batchOperation={form:{},obj:{},toModal:null,execute:null,clear:null},e.paginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.paginationConf2={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",s),e.$watch("paginationConf2.currentPage + paginationConf2.itemsPerPage",c),e.searchKey={online:!0,offline:!0,keyword:""},e.getNodesByParamFuzzy=function(){setTimeout(function(){e.zTree.getNodesByParamFuzzy(e.searchKey,"areaTree","checkboxSiteTree")},10)},e.query=function(){e.alarmQuery.tierCodes=e.alarmQuery.siteIds=e.alarmQuery.siteIds2=void 0;var t=r.getCheckedTierCodesAndSiteIds("areaTree",e.zTree.zNodes);if(t.siteIds.length>0&&(e.alarmQuery.siteIds2=t.siteIds),e.alarmQuery.tierCodes=t.codes,0===e.alarmQuery.tierCodes.length&&(e.alarmQuery.siteIds=e.alarmQuery.siteIds2,e.alarmQuery.siteIds2=void 0),!(e.alarmQuery.siteIds&&0!==e.alarmQuery.siteIds.length||e.alarmQuery.tierCodes&&0!==e.alarmQuery.tierCodes.length||e.alarmQuery.siteIds2&&0!==e.alarmQuery.siteIds2.length))return void a.notify({type:"warn",text:"请选择站点"});s()},e.reset=function(){e.alarmQuery={alarmState:e.CURRENT_ALARM},e.query()},e.exportAlarmList=function(){e.isExportAlarmListLoading=!0,i.exportAlarmList(e.paginationConf,e.alarmQuery,function(){e.isExportAlarmListLoading=!1,e.exportAlarmList.have=!1})},e.exportAlarmList.have=!0,e.exportAlarmList2=function(){e.isExportAlarmListLoading2=!0,i.exportAlarmList(e.paginationConf2,e.alarmChartQuery,function(){e.isExportAlarmListLoading2=!1,e.exportAlarmList2.have=!1})},e.exportAlarmList2.have=!0,e.query2=function(){e.isQueryFromChart=!0,c()},e.queryByAlarmLevel=function(t){e.alarmChartQuery=angular.copy(e.alarmQuery);for(var r=a.CONST.alarmLevelList,i=0;i<r.length;i++)if(t===r[i].value){e.alarmChartQuery.alarmLevel=r[i].key;break}e.query2()},e.queryByAlarmName=function(a){null!==a&&(e.alarmChartQuery=angular.copy(e.alarmQuery),e.alarmChartQuery.alarmName=a,e.query2())},e.queryByArea=function(a){e.alarmChartQuery=angular.copy(e.alarmQuery);for(var t=e.alarmTierList,r=0;r<t.length;r++)if(t[r].key===a){t[r].siteId?e.alarmChartQuery.siteIda=[t[r].siteId]:e.alarmChartQuery.tierCodes=t[r].tierlist,e.alarmChartQuery.siteCode=t[r].siteCode;break}e.isQueryFromChartArea=!0,e.query2()},e.openDetailTab=function(a){e.openDetailIndex===a?e.openDetailIndex=null:e.openDetailIndex=a},e.openDetailTab2=function(a){e.openDetailIndex2===a?e.openDetailIndex2=null:e.openDetailIndex2=a},e.checkAlarm=function(e,a){a.stopPropagation(),i.checkAlarm(e.id,function(){s(),c()})},e.eliminateAlarm.toModal=function(a,t){e.currentEliminateAlarm=a,$("#eliminateAlarmModal").modal("show"),t.stopPropagation()},e.eliminateAlarm.execute=function(){e.eliminateAlarm.clear(),i.eliminateAlarm(e.currentEliminateAlarm.id,function(){s(),c()})},e.eliminateAlarm.clear=function(){$("#eliminateAlarmModal").modal("hide")},e.focusAlarm=function(e,a){a.stopPropagation(),l.addFocus(e,function(){s(),c()})},e.removeFocus=function(e,a){a.stopPropagation(),l.removeFocus(e,function(){s(),c()})},e.selectAll=function(a){for(var t=0;t<e.alarmList.length;t++)e.alarmList[t].isSelected=a},e.selectAll2=function(a){for(var t=0;t<e.alarmList2.length;t++)e.alarmList2[t].isSelected=a},e.batchOperation.toModal=function(t,r){"focus"===t?e.batchOperation.title="关注":"check"===t?e.batchOperation.title="确认":"clear"===t&&(e.batchOperation.title="消除");var i=null,n=null;if(e.isQueryFromChart?(i=e.alarmList2,n=e.paginationConf2):(i=e.alarmList,n=e.paginationConf),"selected"===r){for(var o=[],l=[],u=0;u<i.length;u++)i[u].isSelected&&(o.push(i[u].alarm.id),l.push(i[u].alarm.signal.strId));if("check"===t&&e.alarmList.filter(function(e){return e.isSelected}).some(function(e){return e.alarm.tCheck}))return void a.notify({type:"warning",text:"已确认的告警不能再次确认"});if("clear"===t&&e.alarmList.filter(function(e){return e.isSelected}).some(function(e){return!e.alarm.tCheck}))return void a.notify({type:"warning",text:"告警必须先确认再清除"});if(o.length<1||l.length<1)return void a.notify({type:"warn",text:"请先勾选告警"});e.batchOperation.obj.alarmIdList=o,e.batchOperation.obj.signalIdList=l,e.batchOperation.obj.count=o.length}else"all"===r&&(e.batchOperation.obj.count=n.totalItems);e.batchOperation.obj.updateType=t,e.batchOperation.obj.range=r,$("#batchOperationModal").modal("show")},e.batchOperation.execute=function(){var a=e.batchOperation.obj.range,t=e.batchOperation.obj.updateType;if("selected"===a){var r;r="focus"===t?e.batchOperation.obj.signalIdList:e.batchOperation.obj.alarmIdList,i.updateAlarmInBatch(t,r,this.checkIdea,function(){s(),c()})}else if("all"===a){var n=e.isQueryFromChart?e.alarmChartQuery:e.alarmQuery;i.updateAlarmWithQueryInBatch(t,n,this.checkIdea,function(){s(),c()})}e.batchOperation.clear()},e.batchOperation.clear=function(){delete e.batchOperation.checkIdea,e.batchOperation.obj={},$("#batchOperationModal").modal("hide")},e.exportPdf=function(){e.isExportPdfLoading=!0,i.exportPdf(e.paginationConf,e.alarmQuery,function(){e.isExportPdfLoading=!1,e.exportPdf.have=!1})},e.exportPdf.have=!0,e.deployWork=function(e){u.deployWork(e.alarm.id,function(){c(),s()})},function(){e.treeLoading=!0,r.getSiteMapTree({},function(a){if(e.treeLoading=!1,e.zTree=r.createZTree(a),r.initTree(e.zTree.zNodes,"areaTree","checkboxSiteTree"),t.siteId){var i=$.fn.zTree.getZTreeObj("areaTree"),n=i.getNodesByFilter(function(e){return e.id===t.siteId},!0);i.checkNode(n,!0,!0,!0),i.expandNode(n.getParentNode())}else r.checkedAllNodes("areaTree",!0);e.query()})}(),function(){o.getDeviceTypeList(null,function(a){for(var t=[],r=0;r<a.length;r++)t.push({code:a[r].code,typeName:a[r].typeName});e.deviceTypeList=a})}(),function(){n.getInUseFilter(function(a){e.currentAlarmFilterRuleName=a&&a.name})}()}]);