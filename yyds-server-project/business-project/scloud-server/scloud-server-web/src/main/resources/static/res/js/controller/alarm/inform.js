scloudApp.controller("alarmInformController",["$scope","$rootScope","treeService","deviceService","alarmInformService","signalService",function(e,i,a,t,n,l){function s(){e.isLoading=!0,n.getAlarmInformList(e.paginationConf,function(i){e.isLoading=!1,e.alarmInfoList=i.list,e.paginationConf.totalItems=i.count})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.paginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",s),e.addInform={obj:{},form:{},checkInvalid:function(){if(this.show){this.timeError0=this.timeError1=this.timeError2=!1;var a=["msg","email","app"],t=!0;return a.every(function(i){return!e.addInform.obj[i+"Enable"]})&&!this.obj.strategyEnabled&&(t=!1),a.forEach(function(e,a){var n=this.obj;n[e+"Enable"]&&(n[e+"DayList"].every(function(e){return!e})&&(t=!1),n[e+"BeginTime"]&&n[e+"EndTime"]||(t=!1),n[e+"IfLevel"]||n[e+"IfAlarm"]||(t=!1)),n[e+"BeginTime"]&&n[e+"EndTime"]&&i.util.time2Int(n[e+"BeginTime"])>i.util.time2Int(n[e+"EndTime"])&&(t=!1,this["timeError"+a]=!0)}.bind(this)),this.obj.strategyEnabled&&(this.obj.alarmShield||this.obj.alarmFilter||this.obj.alarmRedefine||(t=!1)),!t}},load:function(e){this.obj=e,this.status="modify"},toModal:function(i){this.show=!0,this.reserved=i,this.obj=$.extend({msgDayList:[],emailDayList:[],appDayList:[],sendPeriod:"每周"},this.obj,i);var a=["msg","email","app"];i.content&&(a.forEach(function(a){var t=this.obj;t[a+"Enable"]=Number(t[a+"Enable"]),t[a+"DayList"]=new Array(7);for(var n=0;n<t[a+"DayList"].length;n++)t[a+"DayList"][i[a+"DayList"][n]]=!0;i[a+"LevelList"]&&i[a+"LevelList"].length&&(t[a+"LevelList"]=$.extend([],i[a+"LevelList"]),t[a+"IfLevel"]=!0),i[a+"SignalCodeList"]&&i[a+"SignalCodeList"].length&&(t[a+"SignalCodeList"]=$.extend([],i[a+"SignalCodeList"]),t[a+"IfAlarm"]=!0);var l=!0;e[a+"SignalList"].children.forEach(function(e){var i=!0;e.children.forEach(function(n){n.value=t[a+"SignalCodeList"].indexOf(e.signal.code+n.signal.code)>-1,n.value||(l=i=!1)}),e.value=i}),e[a+"SignalList"].value=l,e[a+"SignalList"].update=!0,l=!0,e[a+"AlarmLevelList"]&&(e[a+"AlarmLevelList"]&&e[a+"AlarmLevelList"].children.forEach(function(e){e.value=t[a+"LevelList"].indexOf(e.level)>-1,e.value||(l=!1)}),e[a+"AlarmLevelList"].value=l,e[a+"AlarmLevelList"].update=!0)}.bind(this)),this.obj.alarmShield=Number(this.obj.alarmShield),this.obj.alarmFilter=Number(this.obj.alarmFilter),this.obj.alarmRedefine=Number(this.obj.alarmRedefine),this.obj.strategyEnabled=Number(this.obj.strategyEnabled)),$("#addInformModal").modal("show")},execute:function(){var i=this.obj,a=["msg","email","app"],t={msg:"短信",email:"告警邮件",app:"APP推送"};i.content=[],i.msgLevelList=this.obj.msgIfLevel?[1]:[],a.forEach(function(a){var n=[];this.obj[a+"Enable"]=1&this.obj[a+"Enable"],this.obj[a+"SignalCodeList"]=n,e[a+"SignalList"].children.forEach(function(e){e.children.forEach(function(i){i.value&&n.push(e.signal.code+i.signal.code)})}),"msg"!==a&&(this.obj[a+"LevelList"]=e[a+"AlarmLevelList"].children.filter(function(e){return e.value}).map(function(e){return e.level})),this.obj[a+"LevelList"]=this.obj[a+"IfLevel"]?this.obj[a+"LevelList"]||[]:[],this.obj[a+"SignalCodeList"]=this.obj[a+"IfAlarm"]?this.obj[a+"SignalCodeList"]||[]:[],delete this.obj[a+"IfLevel"],delete this.obj[a+"IfAlarm"],this.obj[a+"DayList"]=this.obj[a+"DayList"].map(function(e,i){return e?i:-1}).filter(function(e){return e>-1}),this.obj[a+"Enable"]&&i.content.push(t[a])}.bind(this)),i.alarmShield=1&i.alarmShield,i.alarmFilter=1&i.alarmFilter,i.alarmRedefine=1&i.alarmRedefine,i.strategyEnabled=1&i.strategyEnabled,i.strategyEnabled&&i.content.push("告警策略邮件"),this.clear()},clear:function(){function i(e){e.value=!1,e.children&&e.children.forEach(function(e){i(e)})}this.show=!1,$("#addInformModal").modal("hide"),i(e.msgSignalList),e.msgSignalList.update=!0,i(e.emailSignalList),e.emailSignalList.update=!0,i(e.appSignalList),e.appSignalList.update=!0,i(e.emailAlarmLevelList),e.emailAlarmLevelList.update=!0,i(e.appAlarmLevelList),e.appAlarmLevelList.update=!0},commit:function(){var i="modify"===this.status?"modifyAlarmInform":"addAlarmInform";n[i](this.obj,function(){e.addInform.reset(),s()})},reset:function(){this.obj={},this.status=""}},e.deleteInform={obj:{},toModal:function(i){this.obj=i,delete this.inUse,$("#deleteInformModal").modal("show"),n.checkRuleInUse(i.id,function(i){e.deleteInform.inUse=i})},execute:function(){n.deleteAlarmInform({id:this.obj.id},function(){s(),e.deleteInform.clear()})},clear:function(){$("#deleteInformModal").modal("hide"),this.obj={}}},function(){e.msgSignalList=[],e.emailSignalList=[],e.appSignalList=[],e.emailAlarmLevelList=[],e.appAlarmLevelList=[],l.getDeviceTypeListBySignalType(0,function(i){var a=[],t=[];i.forEach(function(e){var i={signal:e,name:e.typeName},n=$.extend({},i);a.push(n),n.children=[];var l=$.extend({},i);t.push(l),l.children=[],e.signalTypeList.forEach(function(e){if("0"===e.code[0]){var i={signal:e,name:e.typeName,children:[]};n.children.push($.extend({},i)),l.children.push($.extend({},i))}})}),e.emailSignalList={name:"全部",children:a},e.appSignalList={name:"全部",children:t},e.msgSignalList={name:"全部",children:[{name:"开关电源",signal:{code:"006"},children:[{name:"交流输入XX停电告警",signal:{code:"016"}},{name:" 一级低压脱离告警",signal:{code:"030"}},{name:"二级低压脱离告警",signal:{code:"031"}}]},{name:"智能电表（交流）",signal:{code:"016"},children:[{name:"交流输入停电告警",signal:{code:"001"}}]},{name:"温湿度传感器",signal:{code:"183"},children:[{name:"温度超高告警",signal:{code:"005"}}]}]},["emailSignalList","appSignalList","msgSignalList"].forEach(function(i){e[i].children.push({name:"FSU",signal:{code:"001"},children:[{name:"FSU离线告警",signal:{code:"001"}}]})}),e.emailAlarmLevelList={name:"全部",children:[{name:"一级告警",level:"1"},{name:"二级告警",level:"2"},{name:"三级告警",level:"3"},{name:"四级告警",level:"4"}]},e.appAlarmLevelList={name:"全部",children:[{name:"一级告警",level:"1"},{name:"二级告警",level:"2"},{name:"三级告警",level:"3"},{name:"四级告警",level:"4"}]}})}()}]);