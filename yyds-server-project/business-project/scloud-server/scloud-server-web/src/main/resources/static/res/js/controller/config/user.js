scloudApp.controller("configUserController",["$scope","$rootScope","userService","verifyCodeService","fileUploadService","privilegeService","treeService",function(e,t,i,a,r,s,n){function o(){if(!n.getCheckedNode("modalTree"))return void t.notify({type:"warn",text:"请选择一个站点"});e.addUser.user.siteTire=n.getCheckedTierCodes("modalTree")[0],e.addUser.user.siteTireName=n.getParentName(n.getCheckedNode("modalTree"),[]),e.toggleNavTree2(!0),!e.$$phase&&e.$apply()}function d(){e.isLoading=!0,e.userQuery.siteTireList=n.getCheckedTierCodes("areaTree"),i.getMaintainerList(e.userQuery,{pageSize:e.paginationConf.itemsPerPage,currentPage:e.paginationConf.currentPage},function(t){e.userList=t.list,e.isLoading=!1,e.paginationConf.totalItems=t.count})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.isLoading=!1,e.paginationConf={currentPage:1,itemsPerPage:15,pagesLength:9},e.userQuery={},e.userStatus=["在职","离职"],e.getNodesByParamFuzzy2=function(t,i,a){e.modalTree.getNodesByParamFuzzy(t,i,a,o)},e.query=function(){d()},e.reset=function(){e.userQuery=e.userQuery.__get("siteTireList")},e.exportMaintainerList=function(){i.exportMaintainerList(e.userQuery)},e.addUser={status:"",title:"",user:{},toModal:function(e,t){if(!this.status){this.status=e,this.title={add:"增加",modify:"修改",detail:"详情"}[e];var a=this,r=function(){a.user.authDate&&(a.user.authDate=new Date(t.authDate).Format("yyyy/MM/dd hh:mm:ss")),a.user.authExpireDate&&(a.user.authExpireDate=new Date(t.authExpireDate).Format("yyyy/MM/dd hh:mm:ss")),a.user.hiredate&&(a.user.hiredate=new Date(t.hiredate).Format("yyyy/MM/dd hh:mm:ss")),a.user.expireDate&&(a.user.expireDate=new Date(t.expireDate).Format("yyyy/MM/dd hh:mm:ss")),a.user.siteTire&&(n.checkNodeByCodes("modalTree",[a.user.siteTire]),a.user.siteTireName=n.getParentName(n.getCheckedNode("modalTree"),[]))};t&&("detail"===e?i.getMaintainerDetail(t.id,function(e){$.extend(t,e.maintainer),a.user=e.maintainer,a.user.siteList=t.siteList=e.siteList,r()}):(a.user=angular.copy(t),r())),$("#addUserModal").modal("show")}},clear:function(){this.user={},this.status=null,this.form.$setPristine(),$("#addUserModal").modal("hide"),e.toggleNavTree2(!0)},execute:function(){this.user.hiredate&&(this.user.hiredate=new Date(this.user.hiredate).getTime()),this.user.expireDate&&(this.user.expireDate=new Date(this.user.expireDate).getTime()),this.user.authDate&&(this.user.authDate=new Date(this.user.authDate).getTime()),this.user.authExpireDate&&(this.user.authExpireDate=new Date(this.user.authExpireDate).getTime()),"add"===this.status?i.addMaintainer(this.user,function(){d()}):"modify"===this.status&&i.modifyMaintainer(this.user,function(){d()}),this.clear()},deleteSite:function(e){var t=this;i.deleteSite({id:this.user.id,siteCodeList:[e.code],siteNameList:[e.name]},function(){t.status=null,t.toModal("detail",t.user)})}},e.addUserBatch={toModal:function(){$("#addUserBatchModal").modal("show"),e.fileUpload=r.getFileUpload()},clear:function(){$("#addUserBatchModal").modal("hide"),e.fileUpload.files=null,e.fileUpload.info={id:null,name:null,url:null,size:null,progress:null}},select:function(){e.fileUpload.selectFile("fileUploadBtn")},execute:function(){this.loading=!0;var i=this;e.fileUpload.upload("/maintainerFunc/upload",function(e){if(i.loading=!1,i.clear(),!1===e.success)return void t.notify({type:"error",text:"导入失败<br/>"+e.info});t.notify({type:"success",text:"导入成功"}),d()},function(){i.loading=!1,i.clear(),console.log("请求失败")})}},e.deleteMaintainer={obj:{},toModal:function(e){this.obj=e,$("#deleteMaintainerModal").modal("show")},execute:function(){i.deleteMaintainer(this.obj.id,function(){d(),t.notify({type:"success",text:"删除维护人员成功"}),e.deleteMaintainer.clear()})},clear:function(){this.user={},$("#deleteMaintainerModal").modal("hide")}},e.checkUsernameTO=null,e.checkUsername=function(){window.clearTimeout(e.checkUsernameTO),e.checkUsernameTO=window.setTimeout(function(){e.addUser.failToCheckUsername=!1,i.checkMaintainerUsername(e.addUser.user.username,function(t){t.success||(e.addUser.failToCheckUsername=t.info)})},300)},e.checkPhone=function(){e.addUser.failToCheckPhone=!1,i.checkMaintainerPhone({username:e.addUser.user.username,phone:e.addUser.user.phone},function(t){t.success||(e.addUser.failToCheckPhone=t.info)})},function(){e.target2=t.util.getToggleParam(null,[".nav-tree-sm"],{left:"0"},{left:"-232px"})}(),function(){e.treeLoading=!0,n.getTierTree(null,function(t){e.treeLoading=!1,e.zTree=n.createZTree(t),n.initTree(e.zTree.zNodes,"areaTree","checkboxTierTree"),n.checkedAllNodes("areaTree",!0),e.modalTreeLoading=!1,e.modalTree=n.createZTree(t),n.initTree(e.modalTree.zNodes,"modalTree","radioTierTree",o),n.checkedAllNodes("modalTree",!0),e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",d)})}()}]);