scloudApp.controller("sceneSiteController",["$scope","$rootScope","$state","treeService","siteService","cameraService","configurationService","$q","$stateParams","fsuService","deviceService",function(e,t,n,i,o,a,r,c,d,s,l){function u(n,i,a){o.querySite(a.id,function(n){e.currentSite=n,e.currentSite.fsuState=n.fsuState,window.videoPlayerInScene.disposePlayer(),clearTimeout(window.refreshDeviceTimer),clearInterval(window.refreshDeviceInterval),m().then(function(){var t=c.defer(),n=t.promise;return e.treeLoading=!0,c.all([v(),F()]).then(h).then(S).then(g).then(M).then(I).then(function(){e.treeLoading=!1}).catch(function(){r.scene_import([{}],function(){}),e.treeLoading=!1}),c.all([k(),w(),y(),b()]).then(function(){t.resolve()}).catch(function(){e.treeLoading=!1}),n}).then(function(){L(),T(),P()}).catch(function(){e.treeLoading=!1}),e.c++,t.loadCount++})}function f(){window.scene3D||(window.scene3D=new Scene3D),e.scene3D=window.scene3D}function m(){var t=c.defer(),n=t.promise;return r.getDevicesListApi(e.currentSite.id,function(n){e.deviceList=n,t.resolve()}),n}function p(){e.treeLoading=!0,i.getSiteMapTree({},function(t){e.treeLoading=!1,e.zTree=i.createZTree(t),i.initTree(e.zTree.zNodes,"areaTree","radioSiteTree",u),i.checkNodeBySiteId("areaTree",d.siteId)})}function h(t){var n=c.defer(),i=n.promise;return r.executeModelFile(function(){e.deviceTypeList=r.sliceObjectToArray(e.devices,6,!0),e.sceneModelList=r.sliceObjectToArray(e.devices,6,!1),r.scene_import(t[0]||{},function(){r.showLoadingBar(!1,100),n.resolve()})}),i}function v(){var t=c.defer(),n=t.promise;return r.loadSceneApi(e.currentSite.id,function(n){e.devicesNeedLoad=sceneIO.getDeviceTypeFromSaveData(n),t.resolve(n)}),n}function I(){var t=c.defer(),n=t.promise,i=[];for(var o in e.devicesInScene)i.push(e.devicesInScene[o]);e.deviceIdListInScene=i.filter(function(e){return e}).map(function(e){return e.map(function(e){return e.id})}).join(",").split(",").filter(function(e){return!!e});for(var a=0;a<e.deviceAndFsu.length;a++)e.deviceAndFsu[a].infoList.map(function(t){t.isInScene=-1!==e.deviceIdListInScene.indexOf(t.deviceId||t.id)});return t.resolve(),n}function S(){var t=c.defer(),n=t.promise;return e.hasRealTimeAlarm=!1,r.getAlarmCountApi(e.currentSite.id,function(n){e.alarmList=n,e.deviceList.filter(function(e){return"FSU动环主机"===e.type}).forEach(function(e){n.forEach(function(t){t.deviceId===e.id&&n.push({deviceId:e.fsuId,alarmCount:t.alarmCount})})}),e.alarmList.forEach(function(t){t.alarmCount.forEach(function(t){if(t>0)return void(e.hasRealTimeAlarm=!0)})}),AlarmBinding.BindAlarmByDeviceId(n),t.resolve(n)},function(){t.reject()}),n}function g(t){var n=c.defer(),i=n.promise;e.allAlarmCount1=0,e.allAlarmCount2=0,e.allAlarmCount3=0,e.allAlarmCount4=0;for(var o=0;o<t.length;o++)e.allAlarmCount1+=t[o].alarmCount[0],e.allAlarmCount2+=t[o].alarmCount[1],e.allAlarmCount3+=t[o].alarmCount[2],e.allAlarmCount4+=t[o].alarmCount[3];return e.allAlarmCount=e.allAlarmCount1+e.allAlarmCount2+e.allAlarmCount3+e.allAlarmCount4,n.resolve(),i}function y(){var t=c.defer(),n=t.promise;return r.getRoomHistoryAlarm({siteId:e.currentSite.id},function(n){e.historyAlarmCounts=[{value:n.level1,name:"一级告警"},{value:n.level2,name:"二级告警"},{value:n.level3,name:"三级告警"},{value:n.level4,name:"四级告警"}],e.allHistoryAlarmCounts=n.level1+n.level2+n.level3+n.level4,t.resolve()}),n}function L(){document.getElementById(e.allAlarmCountPie)&&chart.alarmCountPie({id:e.allAlarmCountPie,name:"0个",title:" ",data:e.historyAlarmCounts})}function b(){var t=c.defer(),n=t.promise;return r.getRoomHistoryTop({siteId:e.currentSite.id},function(n){e.historyAlarmTop3=n,t.resolve()}),n}function T(){var t=c.defer(),n=t.promise;if(document.getElementById(e.top3AlarmLineForScene)){for(var i=e.historyAlarmTop3,o={alarmNames:[i.signal01?i.signal01.name:"",i.signal02?i.signal02.name:"",i.signal03?i.signal03.name:""],counts:[i.infoList?i.infoList.map(function(e){return e.time}):[],i.infoList?i.infoList.map(function(e){return e.count1}):[],i.infoList?i.infoList.map(function(e){return e.count2}):[],i.infoList?i.infoList.map(function(e){return e.count3}):[]]},a=$.extend([],o.alarmNames),r=$.extend([],o.counts),d=0;d<3;d++)a[d]?a[d]=d+1+" "+a[d]:a[d]=d+1+" 暂无";return chart.alarmLine({id:e.top3AlarmLineForScene,title:" ",color:["#7C41F5","#00B1FF","#FFB700"],seriesName:a,series:[r[1],r[2],r[3]],xAxis:{data:r[0]}}),t.resolve(),n}}function w(){var t=c.defer(),n=t.promise;return r.getSiteInfo({siteId:e.currentSite.id},function(n){e.curSiteBaseInfo=n,t.resolve()}),n}function j(t){l.getDeviceTypeList(t,function(t){e.deviceType=t;var n=e.deviceType.map(function(e){return e.code}).indexOf("038");e.deviceType.splice(n,1)})}function C(){e.deviceListInSite=[];var t=c.defer(),n=t.promise;return r.getDeviceApi({siteId:e.currentSite.id},function(n){for(var i=0;i<n.length;i++)n[i].infoList.map(function(e){e.isChecked=!!e.doValue&&!!parseInt(e.doValue)});e.deviceListInSite=n,t.resolve()},function(){t.reject()}),n}function D(){e.fsuListInSite=[];var t=c.defer(),n=t.promise;return r.getFsu(e.currentSite.id,function(n){e.fsuListInSite=n,e.fsuListForSelect2.data=n.infoList.map(function(e){return{id:e.id,text:e.name}}),t.resolve()}),n}function F(){var t=c.defer(),n=t.promise;return e.deviceAndFsu=[],D().then(C).then(function(){var n=e.deviceListInSite.filter(function(e){return"摄像头"===e.type}),i=e.deviceListInSite.map(function(e){return e.code}),o=e.deviceListInSite.splice(i.indexOf("038"),1);o[0]&&e.deviceListInSite.unshift(o[0]),e.cameraList=0===n.length?[]:n[0].infoList,e.curCameraId=!!e.cameraList.length&&e.cameraList[0].deviceId,e.deviceListInSite.unshift(e.fsuListInSite),e.deviceListInSite=e.deviceListInSite.filter(function(e){return"FSU动环主机"!==e.type}),e.selectedFsuList=e.deviceListInSite.filter(function(e){return"FSU"===e.type})[0].infoList.map(function(e){return e.id}),e.deviceAndFsu=e.deviceListInSite,e.deviceAndFsu.forEach(function(t){t=t.infoList,t.forEach(function(t){t.fsuId=(e.deviceList.filter(function(e){return e.id===t.deviceId})[0]||{}).fsuId})}),window.refreshDeviceTimer=setTimeout(function(){x(e.deviceListInSite),console.log("综合机房setTimeout: runing"),clearTimeout(refreshDeviceTimer),clearInterval(window.refreshDeviceInterval),window.refreshDeviceInterval=setInterval(function(){x(e.deviceListInSite),console.log("综合机房intervarl: runing")},3e5)},6e4),e.cameraList.length>0&&window.videoPlayerInScene.startPlay(e.curCameraId),t.resolve()}).catch(function(){t.reject()}),n}function x(e){for(var t,n=1;n<e.length;n++){var i=e[n];t=1===n?O(i)():t.then(O(i))}}function O(e){return function(){for(var t=c.defer(),n=t.promise,i=[],o=0;o<e.infoList.length;o++)i.push(function(t){var n=c.defer(),i=n.promise;return r.freshDevice({deviceId:e.infoList[t].deviceId},function(i){i?(e.infoList[t].aiValue1=i.aiValue1,e.infoList[t].aiValue2=i.aiValue2,e.infoList[t].status=i.status):e.infoList[t].status="离线",n.resolve()}),i}(o));return c.all(i).then(function(){t.resolve()}),n}}function A(e){r.freshDevice({deviceId:e.deviceId},function(t){e=t})}function M(t){var n=e.deviceList.filter(function(e){return"FSU"===e.type});fsuIdList=n.map(function(e){return e.id});var i=e.deviceList.filter(function(e){return-1!==fsuIdList.indexOf(e.fsuId)}),o=e.alarmList.filter(function(e){return e.alarmCount.reduce(function(e,t){return e+t},0)>0});e.toggleTopoGraph=chart.topologyMap({deviceList:i,fsuList:n,alarmList:o,siteName:e.currentSite.name,id:"topologyMap",curIndex:e.topoGraphIndex}).toggle,setTimeout(function(){$(window).resize()},0)}function P(t){t&&$(t.target).parents(".drop-menu").length>0||(e.curButtonIndex=null,$("body").off("click",P),!e.$$phase&&e.$apply())}function k(){var t=c.defer(),n=t.promise;return r.getConfig({siteId:e.currentSite.id},function(n){var i=e.timeList.map(function(e){return e.key});switch(e.alarmLabelIndex=i.indexOf(n.alarm)+1,e.alarmLabelTop3Index=i.indexOf(n.alarmTop)+1,n.home){case 4:e.defaultViewTypeIndex=4,e.curViewIndex=0,e.curButtonIndex=0;break;case 1:e.defaultViewTypeIndex=1,e.curViewIndex=1,e.curButtonIndex=1,e.topoGraphIndex="0";break;case 2:e.defaultViewTypeIndex=2,e.curViewIndex=1,e.curButtonIndex=1,e.topoGraphIndex="1";break;case 0:e.defaultViewTypeIndex=0,e.curViewIndex=3,e.curButtonIndex=3;break;default:e.defaultViewTypeIndex=3,e.curViewIndex=2,e.curButtonIndex=2}e.alarmStatisticCycle=n.alarm,e.alarmStatisticCycleTop3=n.alarmTop,t.resolve()}),n}function B(){var n=c.defer(),i=n.promise;return r.updateConfig({siteId:e.currentSite.id,userId:t.user.id,home:e.defaultViewTypeIndex,alarm:e.alarmStatisticCycle,alarmTop:e.alarmStatisticCycleTop3},function(e){n.resolve()}),i}function N(e){for(e=e.substring(e.length-4);e&&"0"===e[0];)e=e.substring(1);return"1"===e&&(e=""),e}function V(){l.getSystemNameList(null,function(t){e.systemList=t})}function E(){l.getSpecialDeviceTypeCode(function(t){e.specialDevice=t})}n&&(n=window.$state),d&&(d=window.$stateParams),e.fsuModelList=["ePLC-FS","ePLC-FH"];var z=Math.floor((new Date).getTime()/1e3);e.top3AlarmLineForScene="top3AlarmLineForScene"+z,e.allAlarmCountPie="allAlarmCountPie"+z,e.fsuListForSelect2={data:[]},e.shareInfoList=["移动","电信","联通","移动电信","电信联通","移动联通","移动电信联通"],e.approvalStatusList=["在建","竣工","存量","拆除"],e.towerTypeList=["插接式单管塔","外法兰单管塔","一体化","仿生树","三管塔","角钢塔","楼顶装饰塔","增高架桅杆","拉线塔","灯杆塔"],e.url={add:null,modify:null},e.alarmLabelIndex=0,e.alarmLabelTop3Index=0,e.selectedFsuList=[],e.needLoad=function(t){return e.devicesNeedLoad.indexOf(t.name.type)<0?0:scene3D.model[t.name.type]?1:2},e.searchKey={online:!0,offline:!0,keyword:""},e.getNodesByParamFuzzy=function(){setTimeout(function(){e.zTree.getNodesByParamFuzzy(e.searchKey,"areaTree","radioSiteTree",u)},10)},e.curLayout=[0,0],e.pictureList=[],e.curLayout=[0,0],e.prevImage={currentImageUrl:"",currentRotate:null,showImage:function(e,t){this.showSiteImage=!0,this.currentImageUrl=e,this.currentRotate=t,$("#imageShowModalInScene").modal("show")},hideImage:function(){this.showSiteImage=!1,$("#imageShowModalInScene").modal("hide")}},e.topoList=[{name:" 星状拓扑图",id:0},{name:" 组织拓扑图",id:1}],e.topoGraphIndex="1",e.selectType=function(t){e.currentType=t},e.selectAll=function(){if(e.allSelected){e.oneSelected=!0,angular.forEach(scene3D.devices,function(t){e.checked.push(t.type),e.ifType[t.type]=!0});for(var t in scene3D.deviceToMesh)scene3D.deviceToMesh[t].show()}else{angular.forEach(scene3D.devices,function(t){e.ifType[t.type]=!1}),e.oneSelected=!1,e.checked=[];for(var t in scene3D.deviceToMesh)scene3D.deviceToMesh[t].hide()}},e.selectOne=function(t){for(var n in scene3D.deviceToMesh)scene3D.deviceToMesh[n].device.type===t&&(e.ifType[t]?scene3D.deviceToMesh[n].show():scene3D.deviceToMesh[n].hide());angular.forEach(e.ifType,function(t,n){var i=e.checked.indexOf(n);t&&-1===i?e.checked.push(n):t||-1===i||e.checked.splice(i,1)}),Object.keys(e.devices),Object.keys(e.devices).length===e.checked.length?e.allSelected=!0:e.allSelected=!1},e.isShowAlarmCountList=!0,e.slideAlarmCountList=function(t){e.isShowAlarmCountList=!e.isShowAlarmCountList,angular.element(t).toggleClass("rotate-direction")},e.resizeCanvas=function(){var e=31;!function t(){$(window).resize(),--e>0&&window.setTimeout(t,Math.floor(1e3/60))}()},e.recoverView=function(){scene3D.resetCamera()},e.zoomOut=function(){scene3D.controller.zoomOut()},e.zoomIn=function(){scene3D.controller.zoomIn()},e.viewList=[{type:"topo",class:"flat",text:"拓",isShowMenu:"",id:1,target:"拓扑图"},{type:"video",class:"ic ic-video",text:"",isShowMenu:"",id:2,target:"视频监控"},{type:"configuration",class:"ic ic-configuration",text:"",isShowMenu:"",id:3,target:"组态"},{type:"setting",class:"ic ic-setting",text:"",isShowMenu:"",id:4,target:"默认设置"}],e.handleClickViewListItem=function(t,n,i){switch(i.stopPropagation(),e.preViewIndex=e.curViewIndex,e.preButtonIndex=e.curButtonIndex,4===t?(e.curViewIndex=e.preViewIndex,e.curButtonIndex=t):e.curButtonIndex=e.curViewIndex=t,$("body").on("click",P),n.type){case"topo":window.videoPlayerInScene.disposePlayer(),setTimeout(function(){$(window).resize()},0);break;case"video":e.cameraList.length>0&&window.videoPlayerInScene.startPlay(e.curCameraId);break;case"configuration":window.videoPlayerInScene.disposePlayer();break;default:return}},e.selectList=[{isSelected:!0,toggle:function(e){scene3D.setting.display.nameTag=e}},{isSelected:!0,toggle:function(e){scene3D.setting.display.alarm=e}},{isSelected:!1,toggle:function(t){scene3D.toggleAllCameraSE(t),e.selectList[3].isSelected=!1,e.selectList[4].isSelected=!1,e.selectList[5].isSelected=!1}},{isSelected:!1,toggle:function(t){e.selectList[2].isSelected=!1,scene3D.toggleAllCameraSE(!1),e.selectList[4].isSelected=!1,e.selectList[5].isSelected=!1}},{isSelected:!1,toggle:function(t){e.selectList[2].isSelected=!1,scene3D.toggleAllCameraSE(!1),e.selectList[3].isSelected=!1,e.selectList[5].isSelected=!1}},{isSelected:!1,toggle:function(t){e.selectList[2].isSelected=!1,scene3D.toggleAllCameraSE(!1),e.selectList[3].isSelected=!1,e.selectList[4].isSelected=!1}}],e.viewTypeList=[{name:" 组态",id:0},{name:" 星状拓扑图",id:1},{name:" 组织拓扑图",id:2},{name:" 监控视频",id:3}],e.handleViewTypeRadioClick=function(t){e.defaultViewTypeIndex=t,B()},e.timeList=[{type:"周",key:7},{type:"月",key:30},{type:"季",key:90}],e.handleClickProgressAlarm=function(t){e.alarmStatisticCycle=t.key,B().then(y).then(L)},e.handleClickProgressAlarmTop3=function(t){e.alarmStatisticCycleTop3=t.key,B().then(b).then(T)},e.is3D=!0,e.handle2d3dRadioClick=function(t){"1"===t?e.is3D&&(scene3D.changeController(),e.is3D=!e.is3D):e.is3D||(scene3D.changeController(),e.is3D=!e.is3D)},e.is3DButton=!0,e.videoPlayerInScene=window.videoPlayerInScene={startPlay:function(e){THREEx.Camera.initPlayer("videoPlayer"),a.startVideoSource(e,function(e){e.info&&THREEx.Camera.setPlayerSrc(e.info)},function(){THREEx.Camera.disposePlayer("videoPlayer")})},disposePlayer:function(){THREEx.Camera.disposePlayer("videoPlayer")}},e.simulateStateTime=new Array(30).join(" ").split(" ").map(function(e,t,n){return{key:t+1,value:t+1+"分钟"}}),e.simulateOperation={form:{},obj:{},toModal:function(t){t&&(e.simulateOperation.obj=t),this.obj.selectedFsuList=[],this.obj.operateTime=(new Date).getTime(),$("#simulateOperationModal").modal("show")},execute:function(){e.saveThreshold(),e.simulateOperation.obj={},e.signalThreshold={},$("#simulateOperationModal").modal("hide")},clear:function(){e.simulateOperation.obj={},e.signalThreshold={},$("#simulateOperationModal").modal("hide")}},e.getDeviceTypeByFsuId=function(t){r.getDeviceTypeByFsuId({fsuId:t.id},function(t){e.deviceTypeByFsuId=t;var n=e.deviceTypeByFsuId.map(function(e){return e.code}).indexOf("038");e.deviceTypeByFsuId.splice(n,1)})},e.getDeviceByCode=function(){r.getDeviceByCode({fsuId:e.simulateOperation.obj.fsu.id,typeCode:e.simulateOperation.obj.deviceTypeCode},function(t){e.deviceListByCode=t})},e.getSignalByDevice=function(){r.getSignalByDevice({deviceId:e.simulateOperation.obj.device.id},function(t){e.signalListByDevice=t})},e.getThreshold=function(){r.getThreshold({signalId:e.simulateOperation.obj.signal.id},function(t){e.signalThreshold=t,e.signalThreshold&&(-1===e.signalThreshold.result?e.simulateOperation.obj.threshold=e.signalThreshold.beThreshold:0===e.signalThreshold.result&&(e.simulateOperation.obj.threshold=e.signalThreshold.beThreshold))})},e.saveThreshold=function(){r.saveThreshold({siteId:e.currentSite.id,fsuId:e.simulateOperation.obj.fsu.id,deviceId:e.simulateOperation.obj.device.id,signalId:e.simulateOperation.obj.signal.id,beThreshold:e.simulateOperation.obj.signal.threshold,afThreshold:e.simulateOperation.obj.threshold,reMinutes:e.simulateOperation.obj.reMinutes,userId:t.user.id},function(e){})},e.updateThreshold=function(){r.updateThreshold({deviceId:e.simulateOperation.obj.device.id,signalId:e.simulateOperation.obj.signal.id,logId:e.signalThreshold.id,value:e.signalThreshold.beThreshold},function(e){})},e.operateInfo={form:{},obj:{},toModal:function(t){t&&(e.operateInfo.obj=t),e.operateInfo.obj.operateTime=(new Date).getTime(),e.operateInfo.obj.isChecked=!e.operateInfo.obj.isChecked,$("#operateInfoModal").modal("show")},execute:function(){r.setAdjustValue({signalId:e.operateInfo.obj.doSinId&&e.operateInfo.obj.doSinId,value:1&e.operateInfo.obj.isChecked},function(){A(e.operateInfo.obj),e.operateInfo.saveLog()},function(){e.operateInfo.obj.isChecked=!e.operateInfo.obj.isChecked}),$("#operateInfoModal").modal("hide")},clear:function(){$("#operateInfoModal").modal("hide"),e.operateInfo.obj.isChecked=!e.operateInfo.obj.isChecked,e.operateInfo.obj={}},saveLog:function(){r.saveLog({siteId:e.currentSite.id,tierName:e.currentSite.tierString,tierCode:e.currentSite.tierCode,userName:t.user.name,userId:t.user.id,deviceId:e.operateInfo.obj.deviceId,deviceName:e.operateInfo.obj.deviceName,operate:!0===e.operateInfo.obj.isChecked?1:0,ctime:e.operateInfo.obj.operateTime,signalName:e.operateInfo.obj.doSinName,model:"综合机房"},function(e){})}},e.addSiteInScene={form:{},obj:{tier:[]},status:"",title:"",toModal:function(t,n){if(this.status=t,this.title={add:"增加站点",modify:"修改站点",detail:"站点详情"}[t],n&&(this.obj=angular.copy(n),this.obj.platform&&this.obj.platform.forEach(function(t,n){e.addSiteInScene.obj["platform"+n]=t}),"detail"===this.status)){var i=this;o.siteDetail(this.obj.code,function(e){$.extend(n,e.site),i.obj.maintainerList=n.maintainerList=e.maintainerList})}"modify"===this.status&&(this.obj=e.currentSite),$("#addSiteInSceneModal").modal("show")},execute:function(){switch(this.obj.platform=new Array(4).join(".").split(".").map(function(t,n){return e.addSiteInScene.obj["platform"+n]}),this.status){case"add":window.getFromVue(function(e){return e.prototype.$currentUser.currentOrgId}).then(function(t){o.addSiteInScene(e.addSiteInScene.obj,t,function(){e.addSiteInScene.clear(),getTierTree()})});break;case"modify":o.modifySite(this.obj,function(){w()})}this.clear()},clear:function(){e.addSiteInScene.form.$setPristine(),e.addSiteInScene.obj={tier:[]},$("#addSiteInSceneModal").modal("hide")},deleteMaintainer:function(e){var t=this;o.deleteMaintainer({siteId:t.obj.id,maintainerIds:[e.id]},function(){t.toModal("detail",t.obj)})}},e.coordPickerInSceneModal={toModal:function(){$("#coordPickerInSceneModal").modal("show"),e.addSiteInScene.showMap=!0},execute:function(){e.coordPickerInSceneModal.clear()},clear:function(){e.addSiteInScene.showMap=!1,$("#coordPickerInSceneModal").modal("hide")}},e.addFsuInScene={form:{},obj:{},toModal:function(){e.addFsuInScene.obj.siteId=e.currentSite.id,e.addFsuInScene.obj.name=e.currentSite.name,e.addFsuInScene.obj.model=t.CONST.fsuModelList[0],e.addFsuInScene.obj.manufactory=t.CONST.fsuManufactoryList[0],e.createFsuCode(e.currentSite.id),$("#addFsuInSceneModal").modal("show")},execute:function(){$("#addFsuInSceneModal").modal("hide"),s.addFsu(e.addFsuInScene.obj,function(){e.addFsuInScene.clear(),V(),F()})},clear:function(){e.addFsuInScene.form.$setPristine(),e.addFsuInScene.obj={},$("#addFsuInSceneModal").modal("hide")}},e.createFsuCode=function(t){t&&s.createFsuCode(t,function(t){e.addFsuInScene.obj.code=t,e.addFsuInScene.obj.name=e.currentSite.name+"FSU"+N(t)})},e.modifyFsuInScene={form:{},obj:{},toModal:function(e,t){this.obj=angular.copy(e),$("#modifyFsuInSceneModal").modal("show")},execute:function(){this.obj.name=e.modifyFsuInScene.obj.name,this.obj.respName=e.modifyFsuInScene.obj.respName,this.obj.systemName=e.modifyFsuInScene.obj.systemName,this.obj.manufactory=t.util.strNull(e.modifyFsuInScene.obj.manufactory),$("#modifyFsuInSceneModal").modal("hide"),s.modifyFsu(this.obj,function(){F(),V()})},clear:function(){e.modifyFsuInScene.form.$setPristine(),$("#modifyFsuInSceneModal").modal("hide")}},e.addDeviceOnFsuInScene={form:{},obj:{},toModal:function(t,n){e.currentFsuId=t.id,this.obj.fsuId=t.id,this.obj.siteId=t.siteId,this.obj.fsuName=t.name,$("#addDeviceOnFsuInSceneModal").modal("show")},execute:function(){$("#addDeviceOnFsuInSceneModal").modal("hide"),l.addDeviceOnFsu(e.url.add,{fsuId:e.addDeviceOnFsuInScene.obj.fsuId,siteId:e.addDeviceOnFsuInScene.obj.siteId,name:e.addDeviceOnFsuInScene.obj.name,type:e.addDeviceOnFsuInScene.obj.type.typeName,typeCode:e.addDeviceOnFsuInScene.obj.type.code,code:e.addDeviceOnFsuInScene.obj.code,systemName:e.addDeviceOnFsuInScene.obj.systemName,manufactory:e.addDeviceOnFsuInScene.obj.manufactory,model:e.addDeviceOnFsuInScene.obj.model,ip:e.addDeviceOnFsuInScene.obj.ip,port:e.addDeviceOnFsuInScene.obj.port,rtspPort:e.addDeviceOnFsuInScene.obj.rtspPort,username:e.addDeviceOnFsuInScene.obj.username,password:e.addDeviceOnFsuInScene.obj.password},function(){V(),F(),e.addDeviceOnFsuInScene.clear()})},clear:function(){e.addDeviceOnFsuInScene.form.$setPristine(),e.addDeviceOnFsuInScene.obj={},$("#addDeviceOnFsuInSceneModal").modal("hide")},style:!1},e.getAddingUrl=function(t){l.getAddingUrl(t,function(t){e.url.add=t})},e.getModifyingUrl=function(t){l.getModifyingUrl(t,function(t){e.url.modify=t})},e.createDeviceCode=function(){var t=e.addDeviceOnFsuInScene.obj;l.createDeviceCode(t,function(n){t.code=n,e.getAddingUrl(t.type.code),e.addDeviceOnFsuInScene.obj.name=t.type.typeName+N(n)})},e.findDeviceInScene=function(e){r.highlightDeviceInScene(e)},e.openConfigurationPage=function(t){var i={siteId:e.currentSite.id};n.go("configuration/manager",i)},e.openDevicePage=function(i,o,a,r){if(window.videoPlayerInScene.disposePlayer(),i.typeCode===e.specialDevice.monitor)l.getDeviceInfo(i.id,function(e){window.open("http://"+e.ip+":"+e.webPort)});else{switch(o){case"摄像头":var c={dataSiteData:{deviceQuery:this.deviceQuery,paginationConf:this.paginationConf},deviceId:i.deviceId,deviceIdx:r};n.go("monitor/list",c);break;default:i.id=i.deviceId,i.typeCode=a,n.go("data/device",{dataSiteData:{deviceQuery:this.deviceQuery,paginationConf:this.paginationConf},device:i,parentPage:"scenePage"})}t.util.browserInfo.isIE&&window.location.reload()}},e.openAlarmStatistic=function(){n.go("scene/alarmStatistic",{siteId:e.currentSite.id,alarmStatisticCycle:e.alarmStatisticCycle}),t.util.browserInfo.isIE&&window.location.reload()},function(){e.target=t.util.getToggleParam("navTreeTarget",[".nav-tree",".side-bar"],{left:"250px"},{left:"0"}),e.other=t.util.getToggleParam("null",["#page-wrapper"],{left:"248px"},{left:"20px"}),e.target3=t.util.getToggleParam(null,[".top"],{top:"0"},{top:"-270px"}),e.other3=t.util.getToggleParam(null,[".bottom"],{top:"306px"},{top:"0px"}),e.target2=t.util.getToggleParam(null,[".right"],{right:"0"},{right:"-340px"}),e.other2=t.util.getToggleParam(null,[".top",".bottom"],{right:"351px"},{right:"0px"})}(),function(){e.allSelected=!0,e.oneSelected=!0,e.checked=[],e.ifType={},e.devicesNeedLoad=[],f(),THREEx.Cache.connectToDB(function(){e.SetConfiguration=r,r.getScope(e),e.scene3D.init(e,"guest")}),p(),V(),j(),E()}()}]);