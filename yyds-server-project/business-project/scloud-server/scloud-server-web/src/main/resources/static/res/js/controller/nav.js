scloudApp.controller("navController",["$scope","$rootScope","navService","enterpriseService","verifyCodeService","fileUploadService","privilegeService","noticeService","$state","reportService","$compile","$location",function(e,n,o,t,i,r,a,l,u,c,s,d){function f(){o.getUserInfo(function(o){o.password="*******",n.user=o,p(),e.currentRole=o.roleSessions?o.roleSessions.filter(function(e){return e.id===o.currentRoleId})[0]||o.currentRoleId:"admin",h(),n.getEnterprise()})}function m(){e.backMark?e.noticeHref="#/notice":e.noticeHref="#/back/notice"}function p(){l.countUnread(function(e){n.noticeCount=e<100?e:"99+"})}function h(){o.getLogoURL(function(n){e.logoSrc=n})}function g(){a.getAllPrivilegeList(function(e){n.privilegeList=e;for(var o={},t=[],i=0;i<e.length;i++)o[e[i].code]=e[i].name,t.push(e[i].code+"");n.privilegeMap=o,n.privilegeCodes=t})}function v(o){var t=new FileReader;t.onload=function(o){var t=new Image;t.src=o.target.result,e.fileUpload.info.img={width:t.width,height:t.height,src:o.target.result},e.$apply(),(t.width>400||t.height>50)&&n.notify({type:"warn",text:"图片尺寸超出 400 * 50"}),t.width/t.height>8&&n.notify({type:"warn",text:"图片宽高比超过 8"})},t.readAsDataURL(o)}function M(t,i){e.menus=null,o.getMainMenu(i||location.hash.substring(1),function(o){function i(e,n){e.forEach(function(e){e.level=n,e.nextMenuList&&i(e.nextMenuList,n+1)})}e.menus=o.nextMenuList,e.backMark=o.backMark,e.menus.forEach(function(e){e.isFirst=!0,e.expanded=!0}),i(e.menus,0),n.judgeExchange(),x(n.currentMenu),y(),e.curMenu&&w(),n.$emit("resetRouter",e.menus),t&&t()})}function y(){if(n.enterprise&&n.enterprise.uniqueCode&&"liheng"!==n.enterprise.uniqueCode){var o=-1,t=-1;e.menus&&e.menus.forEach(function(e,n){"数据监控"===e.title&&(o=n)}),o>-1&&e.menus[o].submenu.forEach(function(e,n){"在线调试"===e.title&&(t=n)}),t>-1&&e.menus[o].submenu.splice(t,1)}}function w(){e.menuHeight=e.curMenu&&e.curMenu.expanded&&e.curMenu.nextMenuList?e.curMenu.nextMenuList.reduce(function(e,n){return e+(n.expanded&&n.nextMenuList?40*n.nextMenuList.length:0)+40},0):0,n.__navbarHasTree&&e.menuHeight>480&&(e.menuHeight=480),n.__navbarTreeTop=106+e.menuHeight,n.__navbarJumpByClick=!1,setTimeout(function(){window.dispatchEvent(new Event("resize"))},250),new PerfectScrollbar(document.getElementById("menu-scroll")).update()}function x(o){var t=[];e.menus&&(e.menus.forEach(function(e){if(e.uri===o)return void(t[0]=e);!t[0]&&!t[1]&&e.nextMenuList&&e.nextMenuList.forEach(function(n){if(n.uri===o)return t[0]=e,void(t[1]=n);!t[1]&&n.nextMenuList&&n.nextMenuList.forEach(function(i){if(i.uri===o)return t[0]=e,t[1]=n,void(t[2]=i)})})}),e.curMenu=t[0],e.curMenuPath=n.currentMenu=t,e.curMenuPath.forEach(function(e){e.expanded=!0}),w())}u&&(u=window.$state),$stateParams&&($stateParams=window.$stateParams),e.$location=d,n.user={},n.enterprise={},e.isPhoneExist=!1,e.menuTool=o.getMenuTool(),e.modifyPollingInterval={form:{},obj:{},toModal:null,execute:null,clear:null,loading:!1},e.modifyRefreshInterval={form:{},obj:{},toModal:null,execute:null,clear:null},e.modifyPhone={form:{},obj:{},toModal:null,execute:null,clear:null},e.modifyEmail={form:{},obj:{},toModal:null,execute:null,clear:null},e.modifyPassword={form:{},obj:{},toModal:null,execute:null,clear:null},e.modifyLogo={form:{},obj:{},toModal:null,execute:null,select:null,clear:null},n.getEnterprise=function(t){o.getEnterprise(function(o){o?(n.enterprise=o,o.uniqueCode&&g(),"tongding"===n.enterprise.uniqueCode?e.platformName="通鼎互联云监控":"liheng"===n.enterprise.uniqueCode?e.platformName="配电智控平台":"meitainuo"===n.enterprise.uniqueCode?e.platformName="梅泰诺云监控":e.platformName="义益云监控"):e.platformName="义益云监控",y(),t&&t()},0)},n.judgeExchange=function(){var n=location.href;!e.backMark||n.match("back")?e.isExchange=!1:e.isExchange=!0,m()},e.modifyPhone.toModal=function(){$("#modifyPhoneModal").modal("show")},e.modifyPhone.execute=function(){$("#modifyPhoneModal").modal("hide"),o.modifyPhone(e.modifyPhone.obj,function(){f(),e.modifyPhone.clear()})},e.modifyPhone.clear=function(){e.modifyPhone.form.$setPristine(),e.modifyPhone.obj={},$("#modifyPhoneModal").modal("hide")},e.sendPhoneCode=function(n){e.isPhoneExist||i.sendPhoneCode(n,function(e){})},e.checkPhoneExist=function(n){i.checkPhoneExist(n,function(n){e.isPhoneExist=!n.success,e.existInfo=n.info})},e.modifyPassword.toModal=function(){$("#modifyPasswordModal").modal("show")},e.modifyPassword.execute=function(){$("#modifyPasswordModal").modal("hide"),o.modifyPassword(e.modifyPassword.obj,function(){e.modifyPassword.clear()})},e.modifyPassword.clear=function(){e.modifyPassword.form.$setPristine(),e.modifyPassword.obj={},$("#modifyPasswordModal").modal("hide")},e.modifyLogo.toModal=function(){$("#modifyLogoModal").modal("show"),e.fileUpload=r.getFileUpload(),e.fileUpload.onFileSelectCallback=function(){v(e.fileUpload.files[0])}},e.modifyLogo.select=function(){e.fileUpload.selectFile("pngUploadBtn")},e.modifyLogo.execute=function(){e.fileUpload.upload(n.currentMark+"/agencyFunc/uploadLogo",function(o){if(e.modifyLogo.clear(),!1===o.success)return void n.notify({type:"error",text:o.info});n.notify({type:"success",text:"上传成功"}),h()},function(){e.modifyLogo.clear(),n.notify({type:"error",text:"上传失败"}),console.log("请求失败")})},e.modifyLogo.clear=function(){$("#modifyLogoModal").modal("hide"),e.fileUpload.files=null,e.fileUpload.info={id:null,name:null,url:null,size:null,progress:null,img:{widht:null,height:null,src:null}},$("#preview img").attr("src",null)},e.logout=function(){o.logout(function(){location.href=ctx+"/res/index.html"})},e.selectMenu=function(o,t){var i=[o.level1,o.level2,o.level3].filter(function(e){return e});o=o.level3||o.level2||o.level1,o.level<2&&o.nextMenuList&&o.nextMenuList.length>0?o.isFirst&&!t?(e.curMenu=o,e.curMenu.expanded=!0,e.popupMenu=!0):o.expanded=!o.expanded:(u.go(o.uri.substr(1)),e.popupMenu=!1,e.curMenu=i[0],e.curMenuPath=n.currentMenu=i,n.__navbarJumpByClick=!0),document.getElementById("menu-scroll").scrollTop=0,w()},n.$on("setCurrentMenu",function(o,t){t=t.replace(/\?[\S\s]*/,""),n.__navbarJumpByClick&&n.currentMenu&&e.curMenuPath&&!e.curMenuPath.every(function(e){return t!==e.uri})||x(t),n.currentMark=e.currentMenu.last().mark?"/"+n.currentMenu.last().mark:"",n.currentPageRoute=e.currentMenu.last().pageRoute?"/"+n.currentMenu.last().pageRoute:"",n.isEndCurrentMark=!0}),n.$on("updateTreetop",function(){w()}),e.exchange=function(){n.flag=!0,n.isEndCurrentMark=!1,e.popupMenu=!1,o.saveCurrentService(function(e){n.getNavInfo(function(){setTimeout(function(){location.hash="#"+(e&&e?e.uri:"/back/center"),n.flag=!1,n.util.browserInfo.isIE&&window.location.reload()},0)})})},e.changeRole=function(){a.switchRole(e.currentRole.id,function(){window.location.reload()})},n.getNavInfo=function(e,n){f(),M(e,n)},$(document).ready(function(){n.getNavInfo(),n.judgeExchange()}),e.alarm={alarmLevelList:[],show:!1,go:function(e){u.go("alarm/list",{alarmLevel:e+""}),this.show=!1},clear:function(){this.show=!1,this.audio.pause()}};var P=function(o,t){var i=n.enterprise&&n.enterprise.alarmInterval;i>0&&o!==t&&o?e.navAlarmInterval=window.setInterval(function(){c.getAlarmCount(null,function(o){var t=[o.level1,o.level2,o.level3,o.level4],i=o.level1?1:o.level2?2:o.level3?3:o.level4?4:5;if(e.alarm.alarmLevelList=t,!(i>4)){e.alarm.show=!0,setTimeout(function(){e.alarm.show=!1,e.$apply()},1e3*n.enterprise.keepTime),e.alarm.audio=document.createElement("audio");var r=n.CONST.alarmConfigList[i-1].audio;e.alarm.audio.src="/res/audio/alarm/"+r,$("#alarm-notice")[0].appendChild(e.alarm.audio),e.alarm.audio.play(),e.alarm.audio.onended=function(){e.alarm.audio.remove()}}})},1e3*i):o===t||o||window.clearInterval(e.navAlarmInterval)};n.navAlarmIntervalFn=P,n.$watch("enterprise.name",P);var b;$("body").append(b=s('<div id="alarm-notice-mask" class="toggle" ng-show="alarm.show" style="display:none;"></div><div id = "alarm-notice" class="toggle" ng-show="alarm.show" class="card-bg card-transparent outset-shadow" style="display:none;">    <div class="page-header">        <h3>告警确认</h3>        <i class="ic ic-close cursor-point" ng-click = "alarm.clear()"></i>    </div>    <div class="page-body">        <table>            <tr>                <td>告警等级</td>                <td>告警数量</td>            </tr>            <tr ng-repeat="item in [1,2,3,4]">                <td><span ng-bind="item | alarmLevelFilter"></span></td>                <td><span ng-bind="alarm.alarmLevelList[$index]"></span></td>                <td><i class="ic ic-alarm twinkle" ng-style="{color:  CONST.alarmColorList[item - 1]}"></i></td>                <td><button class="btn btn-primary" ng-click="alarm.go(item)">告警确认</button></td>            </tr>        </table>    </div></div>')(e)),setTimeout(function(){b.css("display","block")},1e3)}]);