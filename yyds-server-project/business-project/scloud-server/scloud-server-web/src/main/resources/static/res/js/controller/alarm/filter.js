scloudApp.controller("alarmFilterController",["$scope","$rootScope","$filter","$timeout","treeService","deviceService","alarmFilterService","fileUploadService",function(e,t,a,l,r,o,i,n){function u(){e.isLoading=!0,i.getRuleList(e.paginationConf,function(t){e.isLoading=!1,e.ruleList=t.list,e.paginationConf.totalItems=t.count},function(){e.isLoading=!1})}function d(){for(var t=[],a=e.updateRule.obj.selectedAreaList,l=0;l<a.length;l++)t[l]=a[l].key;return t}function c(){for(var t=[],a=e.updateRule.obj.alarmLevels,l=0;l<a.length;l++)t.push(a[l].id);return t}function s(){for(var t=[],a=e.updateRule.obj.deviceTypes,l=0;l<a.length;l++)t.push(a[l].id);return t}function p(e,t){for(var a=0;a<t.length;a++)if(e===t[a].id)return t[a]}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.UPDATE_MODE="ADD",e.updateRule={form:{},obj:{siteBased:!0,selectedAreaList:[],areaCodes:[],alarmLevels:[],deviceTypes:[]},clearArea:function(){this.obj.selectedAreaList=[],this.obj.areaCodes=[]},toModal:null,execute:null,clear:null},e.modifyRule={form:{},obj:{},toModal:null,execute:null,clear:null},e.deleteRule={form:{},obj:{},toModal:null,execute:null,clear:null},e.importAlarmFilter={form:{},obj:{},toModal:null,execute:null,select:null,clear:null,loading:!1},e.isLoading=!1,e.paginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",u),e.openDetailTab=function(t){e.openDetailIndex===t?e.openDetailIndex=null:e.openDetailIndex=t},e.updateRule.toModal=function(l,r){r.stopPropagation(),e.UPDATE_MODE="MODIFY",e.updateRule.obj={id:l.rule.id,name:l.rule.name,siteBased:l.rule.siteBased,selectedAreaList:[],areaCodes:[],tReportStart:l.rule.tReportStart&&a("date")(new Date(l.rule.tReportStart),"yyyy/MM/dd HH:mm:ss"),tReportEnd:l.rule.tReportEnd&&a("date")(new Date(l.rule.tReportEnd),"yyyy/MM/dd HH:mm:ss"),tRecoverStart:l.rule.tRecoverStart&&a("date")(new Date(l.rule.tRecoverStart),"yyyy/MM/dd HH:mm:ss"),tRecoverEnd:l.rule.tRecoverEnd&&a("date")(new Date(l.rule.tRecoverEnd),"yyyy/MM/dd HH:mm:ss"),alarmLevels:[],deviceTypes:[],alarmName:l.rule.alarmName,remarks:l.rule.remarks};var o=l.rule.siteBased?l.site:l.tier;o&&o.forEach(function(t){e.updateRule.obj.selectedAreaList.push({key:t.strId,value:t.name})});var i=l.rule.alarmLevel;i&&i.forEach(function(a){e.updateRule.obj.alarmLevels.push(p(a,t.CONST.alarmLevelListForSelect2.data))});var n=l.rule.deviceTypeCode;n&&n.forEach(function(t){e.updateRule.obj.deviceTypes.push(p(t,e.deviceTypeList.data))})},e.updateRule.execute=function(){e.updateRule.obj.areaCodes=d(),e.updateRule.obj.alarmLevel=c(),e.updateRule.obj.deviceTypeCode=s(),"ADD"===e.UPDATE_MODE?i.addRule(e.updateRule.obj,function(){e.updateRule.clear(),u()}):"MODIFY"===e.UPDATE_MODE&&i.modifyRule(e.updateRule.obj,function(){e.updateRule.clear(),u()})},e.updateRule.clear=function(){e.updateRule.form.$setPristine(),e.updateRule.obj={siteBased:!0,selectedAreaList:[],areaCodes:[],alarmLevels:[],deviceTypes:[]},e.UPDATE_MODE="ADD"},e.siteBased="0",e.changeSiteBased=function(t){e.updateRule.obj.siteBased="0"===t},e.getNodesByParamFuzzy=function(t){e.updateRule.obj.siteBased?e.zTree.getNodesByParamFuzzy(t,"areaTree","radioSiteTree",function(){e.getCheckedNodeInSelect("areaTree")}):e.zTree2.getNodesByParamFuzzy(t,"areaTree2","radioTierTree",function(){e.getCheckedNodeInSelect2("areaTree2")})},e.getCheckedNodeInSelect=function(t){var a=r.getCheckedNode(t);a&&(e.multiNodeSelect.add({key:a.id,value:a.name},e.updateRule.obj.selectedAreaList),e.$apply())},e.getCheckedNodeInSelect2=function(t){var a=r.getCheckedNode(t);a&&(e.multiNodeSelect.add({key:r.wrapZero(r.getParentCode(a),6),value:r.getParentName(a,[])},e.updateRule.obj.selectedAreaList),e.$apply())},e.multiNodeSelect={add:function(e,t){!1===t.containsObj(e)&&(t[t.length]=e)},remove:function(e,t){!e||e.length<1||t.removeObj(e[0])}},e.deleteRule.toModal=function(t,a){a.stopPropagation(),e.deleteRule.obj=t,$("#deleteRuleModal").modal("show")},e.deleteRule.execute=function(){$("#deleteRuleModal").modal("hide"),i.deleteRule(e.deleteRule.obj.id,function(){u(),e.deleteRule.clear()})},e.deleteRule.clear=function(){e.deleteRule.obj={},$("#deleteRuleModal").modal("hide")},e.importAlarmFilter.toModal=function(){$("#importAlarmFilterModal").modal("show"),e.fileUpload=n.getFileUpload()},e.importAlarmFilter.select=function(){e.fileUpload.selectFile("fileUploadBtn")},e.importAlarmFilter.execute=function(){e.importAlarmFilter.loading=!0,e.fileUpload.upload("/alarmFilterFunc/importAlarmFilter",function(a){if(e.importAlarmFilter.loading=!1,e.importAlarmFilter.clear(),!1===a.success)return void t.notify({type:"error",text:"导入失败<br/>"+a.info});t.notify({type:"success",text:"导入成功"}),u()},function(){e.importAlarmFilter.loading=!1,e.importAlarmFilter.clear(),console.log("请求失败")})},e.importAlarmFilter.clear=function(){$("#importAlarmFilterModal").modal("hide"),e.fileUpload.files=null,e.fileUpload.info={id:null,name:null,url:null,size:null,progress:null}},e.useFilter=function(e,t){t.stopPropagation(),i.useFilter(e,function(){u()})},e.unuseFilter=function(e){e.stopPropagation(),i.unuseFilter(function(){u()})},e.exportAlarmFilter=function(){i.exportAlarmFilter()},function(){e.treeLoading=!0,r.getSiteMapTree({},function(t){e.treeLoading=!1,e.zTree=r.createZTree(t),r.initTree(e.zTree.zNodes,"areaTree","radioSiteTree",function(){e.getCheckedNodeInSelect("areaTree")})})}(),function(){e.treeLoading2=!0,r.getTierTree(null,function(t){e.treeLoading2=!1,e.zTree2=r.createZTree(t),r.initTree(e.zTree2.zNodes,"areaTree2","radioTierTree",function(){e.getCheckedNodeInSelect2("areaTree2")})})}(),function(){o.getDeviceTypeList(null,function(t){for(var a=[],l=[],r=0;r<t.length;r++)a.push({id:t[r].code,text:t[r].typeName}),l[t[r].code]=t[r].typeName;e.deviceTypeList={data:a},e.deviceTypeMap=l})}()}]);