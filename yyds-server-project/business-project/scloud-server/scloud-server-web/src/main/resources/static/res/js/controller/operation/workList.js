scloudApp.controller("operationWorkListController",["$scope","$rootScope","treeService","workService","deviceService","signalService","alarmService","$stateParams",function(e,t,r,n,o,i,a,s){function l(t){var n,o=r.getCheckedNodes(t).filter(function(e){return e.siteId});n=1===o.length?r.getParentName(o[0],[]):o.length>1?o[0].name+" 等"+o.length+"个站点":"","areaTree"===t?(e.orderQuery.siteCodeList=r.getCheckedNodes("areaTree").filter(function(e){return e.siteId}).map(function(e){return e.code}),e.orderQuery.tierName=n):"areaTree2"===t&&(e.addOrModifyWork.obj.siteCodeList=o.map(function(e){return e.code}),e.addOrModifyWork.obj.tierName=n),e.$$phase||e.$apply()}function d(){var t=e.orderQuery.__get("code","sendType","state","workerId","siteName","deviceType","deviceId","companyName","siteCodeList","alarmLevel");return t.sendType&&(t.sendType=t.sendType.substr(0,2)),t.deviceType=e.orderQuery.device&&"全部"!==e.orderQuery.device.typeName?e.orderQuery.device.typeName:void 0,e.orderQuery.alarmName&&(t.alarmNameList=[e.orderQuery.alarmName]),e.orderQuery.sentEndTime&&(t.sentEndTime=new Date(e.orderQuery.sentEndTime).getTime()),e.orderQuery.sentBeginTime&&(t.sentBeginTime=new Date(e.orderQuery.sentBeginTime).getTime()),t}function u(){e.isLoading=!0;var t=d();n.getWorkOrderList(e.paginationConf,t).then(function(t){e.orderList=t.list,e.isLoading=!1,e.paginationConf.totalItems=t.count}).catch(function(e){console.error(e)})}function c(){var t=e.workConfigQuery.__get("sendType","stationType","signalName");t.alarmLevelList=e.workConfigQuery.alarmLevelList,t.sendType&&(t.sendType=t.sendType.substr(0,2)),e.workConfigLoading=!0,n.getWorkConfigList(e.workConfigPaginationConf,t).then(function(t){e.workConfigList=t.list,e.workConfigLoading=!1,e.workConfigPaginationConf.totalItems=t.count})}$state&&($state=window.$state),s&&(s=window.$stateParams),e.tabPage=t.util.tabPage.getInstance(["工单列表","工单配置"]),e.subTabPage=t.util.tabPage.getInstance(["按典型案例","按完整信息"]),e.orderQuery={sendType:null,workOrderState:null,serialNumber:null,siteName:null,siteLevel:null,deviceType:null,alarmType:null,company:null,state:(s.query||{}).state||null,sentBeginTime:(s.query||{}).tStart?s.query.tStart.Format("yyyy/MM/dd hh:mm:ss"):null,sentEndTime:(s.query||{}).tEnd?s.query.tEnd.Format("yyyy/MM/dd hh:mm:ss"):null},e.workConfigQuery={sendType:null,stationType:null,alarmLevelList:null,signalName:null,reportBegin:null,reportEnd:null},e.addOrModifyWork={title:"增加工单配置",form:{},obj:{id:null,sendType:null,scope:null,siteType:null,alarmLevel:null,signalName:null,reportAfter:null,reportBegin:null,reportEnd:null,csjdsc:null,csjdtxjg:null,cshdsc:null,cshdtxjg:null,reportBeginInt:null,reportEndInt:null},toModal:null,execute:null,clear:null},e.ifShowSingleWork=!1,e.isLoading=!1,e.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.workConfigPaginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.$watch("workConfigPaginationConf.currentPage + workConfigPaginationConf.itemsPerPage",c),e.curWork={},e.WorkRecordList=[],e.workerList=[],e.alarmHeight=0,e.getNodesByParamFuzzy=function(t,r,n){e.zTree.getNodesByParamFuzzy(t,r,n,function(){l("areaTree")})},e.getNodesByParamFuzzy2=function(t,r,n){e.zTree2.getNodesByParamFuzzy(t,r,n,function(){l("areaTree2")})},e.needShowBtn=function(e,t){if(t){var r=["派单","接单","转单","回单","催单","撤单","回单补充"];return[[0,1,1,0,1,1,0],[0,0,1,1,1,1,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,1]][["待接单","待处理","已撤单","已回单"].indexOf(t)][r.indexOf(e)]>0}},e.query=function(){u()},e.reset=function(){e.orderQuery={device:e.deviceTypeList[0]}},e.exportWorkList=function(){var e=d();n.exportWorkOrderList(e)},e.queryWorkConfig=function(){c()},e.resetWorkConfig=function(){e.workConfigQuery={}},e.addOrModifyWork.toModal=function(t,n){t?(this.status=n||"modify",this.title="modify"===n?"修改工单配置":"工单配置详情",this.obj=angular.copy(t),this.obj.sendType+="派单",this.obj.stationType=this.obj.siteTypeList.length>1?void 0:this.obj.siteTypeList[0],this.obj.reportBegin&&(this.obj.reportBegin+=":00"),this.obj.reportEnd&&(this.obj.reportEnd+=":00"),this.obj.alarmLevelList&&(this.obj.alarmLevelList=this.obj.alarmLevelList.map(function(t){return e.alarmLevelListSelect2.data.find(function(e){return e.id===t})})),this.obj.signalNameList&&(this.obj.signalNameList=this.obj.signalNameList.map(function(t){return e.allDeviceTypeListForSelect2.data.filter(function(e){return e.text===t})[0]})),r.checkNodeBySomething("areaTree2",this.obj.siteCodeList||[],"code"),l("areaTree2")):(this.status="add",this.title="增加工单配置",this.obj.sendType="手动派单"),$("#addOrModifyWorkModal").modal("show")},e.addOrModifyWork.execute=function(){if("detail"===this.status)return void this.clear();if(this.obj.alarmLevelList&&this.obj.alarmLevelList.length>0&&this.obj.alarmNameList&&this.obj.alarmNameList.length>0)return void(this.error=!0);var r=this.obj.__get("id","sendType","siteCodeList","stationType","alarmLevelList","alarmNameList","reportAfter","reportBegin","reportEnd","csjdsc","csjdtxjg","cshdsc","cshdtxjg","reportBeginInt","reportEndInt");r.siteTypeList=r.stationType?[r.stationType]:["1","2","3","4"],r.alarmLevelList&&(r.alarmLevelList=r.alarmLevelList.map(function(e){return+e.id})),r.alarmNameList&&(r.alarmNameList=r.alarmNameList.map(function(e){return e.text})),r.reportBegin&&(r.reportBegin=r.reportBegin.substr(0,5)),r.reportEnd&&(r.reportEnd=r.reportEnd.substr(0,5)),r.sendType=r.sendType.substr(0,2);var o="add"===this.status?"addWorkConfig":"modifyWorkConfig";n[o](r,function(){c(),t.notify({type:"success",text:("add"===e.addOrModifyWork.status?"新建":"修改")+"工单配置成功"})}),this.clear()},e.addOrModifyWork.clear=function(){this.error=!1,this.obj={},this.form.$setPristine(),e.toggleNavTree2(!0),r.checkNodeByCodes("areaTree2",[]),$("#addOrModifyWorkModal").modal("hide")},e.deleteWorkConfig={toModal:function(e){this.obj=e,$("#deleteWorkConfigModal").modal("show")},clear:function(){$("#deleteWorkConfigModal").modal("hide")},execute:function(){n.deleteWorkConfig({id:this.obj.id},function(){c()}),this.clear()}},e.applyWork=function(t){n.applyWork(t.id,function(){u(),e.ifShowSingleWork&&e.showSingleWork()})},e.showSingleWork=function(){n.getWorkDetail(e.curWork.id,function(t){e.curWork=t,e.curWork.workRecordList=t.workRecordList}),e.alarmHeight=40*e.curWork.workAlarmList.length+40+52+"px",e.ifShowSingleWork=!0},e.redeploy={obj:{},toModal:function(r){r&&(e.curWork=r),this.obj.sentTime=(new Date).getTime(),$("#redeployModal").modal("show"),n.getMaintainersFromSite({pageSize:999999,currentPage:1,currentPostId:"c34d77c4-a631-45eb-8e8a-1859fdc38622",currentPositionName:"维护人员"},function(r){e.workerList=r.filter(function(e){return e.name!==t.user.name})}),this.interval=setInterval(function(){e.redeploy.obj.sentTime=(new Date).getTime(),e.$apply()},1e3)},clear:function(){$("#redeployModal").modal("hide"),clearInterval(this.interval)},execute:function(){var r={workId:e.curWork.id,worker:{strId:t.user.username,name:t.user.name},receiver:{strId:this.obj.receiver.username,name:this.obj.receiver.name},workerAccount:t.user.username,workerPhone:t.user.phone,operateDescribe:this.obj.operateDescribe};n.redeployWork(r,function(){e.showSingleWork()}),this.clear()}},e.urge={obj:{},toModal:function(t){t&&(e.curWork=t),this.obj.urgeTime=(new Date).getTime(),$("#urgeModal").modal("show"),this.interval=setInterval(function(){e.urge.obj.urgeTime=(new Date).getTime(),e.$apply()},1e3)},clear:function(){$("#urgeModal").modal("hide"),clearInterval(this.interval)},execute:function(){n.urgeWork({workId:e.curWork.id,operateDescribe:this.obj.operateDescribe},function(){e.showSingleWork()}),this.clear()}},e.response={obj:{},toModal:function(){this.obj.result="已完成",this.obj.method="远程",this.obj.responseTime=(new Date).getTime(),$("#responseModal").modal("show"),this.interval=setInterval(function(){e.response.obj.responseTime=(new Date).getTime(),e.$apply()},1e3)},clear:function(){$("#responseModal").modal("hide"),clearInterval(this.interval)},execute:function(){var r={workId:e.curWork.id,worker:{strId:t.user.id,name:t.user.name},workerAccount:t.user.username,workerPhone:t.user.phone,operateDescribe:this.obj.operateDescribe,reason:this.obj.reason,handleWay:this.obj.handleWay,handleResult:this.obj.handleResult};r.verifyWay="已完成"===this.obj.handleResult?"告警消除":"不验证",n.responseWork(r,function(){e.showSingleWork()}),this.clear()}},e.cancleWork=function(t){n.cancleWork(t.id,function(){u(),e.ifShowSingleWork&&e.showSingleWork()})},e.deployWork=function(e){n.deployWork(e.alarmList[0].alarmId,function(){u()})},e.changeHasTree=function(e){t.__navbarHasTree=0===e,t.$emit("updateTreetop")},e.getDeviceType=function(e){return((this.deviceTypeList||[]).find(function(t){return t.code===e})||{}).typeName||"-"},e.getSiteTier=function(e){var t=$.fn.zTree.getZTreeObj("areaTree").getNodeByParam("code",e);return t.getParentNode().getParentNode().getParentNode().name+"-"+t.getParentNode().getParentNode().name+"-"+t.getParentNode().name},function(){e.target2=t.util.getToggleParam(null,[".nav-tree-sm"],{left:"0"},{left:"-232px"})}(),function(){o.getDeviceTypeList(null,function(t){e.deviceTypeList=t;var r=[];e.deviceTypeList.forEach(function(e){r=r.concat(e.signalTypeList.map(function(e){return{id:e.cntbId,text:e.typeName}}))}),e.allDeviceTypeListForSelect2={data:r}})}(),function(){e.treeLoading=!0,e.treeLoading2=!0,r.getSiteMapTree({serverCode:e.user.serverCode},function(t){e.treeLoading=!1,e.treeLoading2=!1,e.zTree2=r.createZTree(t),e.zTree=r.createZTree(angular.copy(t)),r.initTree(e.zTree.zNodes,"areaTree","checkboxSiteTree",function(){l("areaTree")}),r.initTree(e.zTree2.zNodes,"areaTree2","checkboxSiteTree",function(){l("areaTree2")}),s&&(r.applyTreeParam("areaTree",s)||r.checkedAllNodes("areaTree",!0)),l("areaTree"),e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",u)},function(){e.treeLoading=!1,e.treeLoading2=!1})}(),function(){a.getAlarmLevelList({enterpriseCode:e.user.enterpriseCode,serverCode:e.user.serverCode},function(t,r){e.alarmLevelForFilter=r,e.alarmLevelList=t.map(function(e){return{levels:[e.level],name:e.levelName+"("+e.level+")"}}),e.alarmLevelListSelect2={data:e.alarmLevelList.map(function(e){return{id:e.levels[0],text:e.name}})}})}()}]);