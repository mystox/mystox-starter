scloudApp.controller("operationWorkListController",["$scope","$rootScope","treeService","workService","deviceService","signalService",function(e,r,t,i,o,n){function a(r){var i,o=t.getCheckedNodes(r).filter(function(e){return e.end});i=1===o.length?t.getParentName(o[0],[]):o.length>1?o[0].name+" 等"+(o.length-1)+"个区域":"","areaTree"===r?(e.orderQuery.tierCodeList=t.getCheckedTierCodes("areaTree"),e.orderQuery.tierName=i):"areaTree2"===r&&(e.addOrModifyWork.obj.tierCodes=t.getCheckedTierCodes("areaTree2"),e.addOrModifyWork.obj.tierName=i),e.$$phase||e.$apply()}function s(){var r=e.orderQuery.__get("code","sendType","status","workerId","siteName","deviceType","deviceId","companyName","tierCodeList");return r.sendType&&(r.sendType=r.sendType.substr(0,2)),r.deviceType=e.orderQuery.device&&"全部"!==e.orderQuery.device.typeName?e.orderQuery.device.typeName:void 0,e.orderQuery.alarmName&&(r.alarmNameList=[e.orderQuery.alarmName]),e.orderQuery.alarmLevel&&(r.alarmLevelList=[e.orderQuery.alarmLevel]),e.orderQuery.sentEndTime&&(r.sentEndTime=new Date(e.orderQuery.sentEndTime).getTime()),e.orderQuery.sentBeginTime&&(r.sentBeginTime=new Date(e.orderQuery.sentBeginTime).getTime()),r}function l(){e.isLoading=!0;var r=s();i.getWorkOrderList(e.paginationConf,r).then(function(r){e.orderList=r.list,e.isLoading=!1,e.paginationConf.totalItems=r.count}).catch(function(e){console.error(e)})}function d(){var r=e.workConfigQuery.__get("sendWorkType","stationType","signalName");r.alarmLevelList=e.workConfigQuery.alarmLevelList?[e.workConfigQuery.alarmLevelList]:null,r.sendWorkType&&(r.sendWorkType=r.sendWorkType.substr(0,2)),e.workConfigLoading=!0,i.getWorkConfigList(e.workConfigPaginationConf,r).then(function(r){e.workConfigList=r.list,e.workConfigLoading=!1,e.workConfigPaginationConf.totalItems=r.count})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.tabPage=r.util.tabPage.getInstance(["工单列表","工单配置"]),e.subTabPage=r.util.tabPage.getInstance(["按典型案例","按完整信息"]),e.orderQuery={sendWorkType:null,workOrderState:null,serialNumber:null,siteName:null,siteLevel:null,deviceType:null,alarmType:null,company:null,tStart:null,tEnd:null},e.workConfigQuery={sendWorkType:null,stationType:null,alarmLevelList:null,signalName:null,sendedWorkBeginTime:null,sendedWorkEndTime:null},e.addOrModifyWork={title:"增加工单配置",form:{},obj:{id:null,sendWorkType:null,scope:null,siteType:null,alarmLevel:null,signalName:null,alarmBeginTime:null,sendedWorkBeginTime:null,sendedWorkEndTime:null,receWorkOvertimeNotice:null,receWorkTimeNotice:null,backWorkOvertimeNotice:null,backWorkTimeNotice:null,intSendedWorkBeginTime:null,intSendedWorkEndTIme:null},toModal:null,execute:null,clear:null},e.ifShowSingleWork=!1,e.isLoading=!1,e.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.workConfigPaginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.$watch("workConfigPaginationConf.currentPage + workConfigPaginationConf.itemsPerPage",d),e.curWork={},e.WorkRecordList=[],e.workerList=[],e.alarmHeight=0,e.getNodesByParamFuzzy=function(r,t,i){e.zTree.getNodesByParamFuzzy(r,t,i,function(){a("areaTree")})},e.getNodesByParamFuzzy2=function(r,t,i){e.zTree2.getNodesByParamFuzzy(r,t,i,function(){a("areaTree2")})},e.needShowBtn=function(e,t){if(t){var i=["派单","接单","转单","回单","催单","撤单","回单补充"];return[[0,1,1,0,1,1,0],[0,0,1,1,1,1,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,1]][r.CONST.workList.status.indexOf(t)][i.indexOf(e)]>0}},e.query=function(){l()},e.reset=function(){e.orderQuery={device:e.deviceTypeList[0]}},e.exportWorkList=function(){var e=s();i.exportWorkOrderList(e)},e.queryWorkConfig=function(){d()},e.resetWorkConfig=function(){e.workConfigQuery={}},e.addOrModifyWork.toModal=function(i,o){i?(this.status=o||"modify",this.title="modify"===o?"修改工单配置":"工单配置详情",this.obj=angular.copy(i),this.obj.sendWorkType+="派单",this.obj.stationType=this.obj.stationTypeList.length>1?void 0:+this.obj.stationTypeList[0],this.obj.sendedWorkBeginTime&&(this.obj.sendedWorkBeginTime+=":00"),this.obj.sendedWorkEndTime&&(this.obj.sendedWorkEndTime+=":00"),this.obj.alarmLevelList&&(this.obj.alarmLevelList=this.obj.alarmLevelList.map(function(e){return r.CONST.alarmLevelListForSelect2.data.filter(function(r){return r.id===e})[0]})),this.obj.signalNameList&&(this.obj.signalNameList=this.obj.signalNameList.map(function(r){return e.allDeviceTypeListForSelect2.data.filter(function(e){return e.text===r})[0]})),t.checkNodeByCodes("areaTree2",this.obj.tierCodes||[])):(this.status="add",this.title="增加工单配置",this.obj.sendWorkType="手动派单"),$("#addOrModifyWorkModal").modal("show")},e.addOrModifyWork.execute=function(){if("detail"===this.status)return void this.clear();if(this.obj.alarmLevelList&&this.obj.alarmLevelList.length>0&&this.obj.signalNameList&&this.obj.signalNameList.length>0)return void(this.error=!0);var t=this.obj.__get("id","sendWorkType","tierCodes","stationType","alarmLevelList","signalNameList","alarmBeginTime","sendedWorkBeginTime","sendedWorkEndTime","receWorkOvertimeNotice","receWorkTimeNotice","backWorkOvertimeNotice","backWorkTimeNotice","intSendedWorkBeginTime","intSendedWorkEndTIme");t.stationTypeList=t.stationType?[t.stationType]:["1","2","3","4"],t.alarmLevelList&&(t.alarmLevelList=t.alarmLevelList.map(function(e){return e.id})),t.signalNameList&&(t.signalNameList=t.signalNameList.map(function(e){return e.text})),t.sendedWorkBeginTime&&(t.sendedWorkBeginTime=t.sendedWorkBeginTime.substr(0,5)),t.sendedWorkEndTime&&(t.sendedWorkEndTime=t.sendedWorkEndTime.substr(0,5)),t.sendWorkType=t.sendWorkType.substr(0,2);var o="add"===this.status?"addWorkConfig":"modifyWorkConfig";i[o](t,function(){d(),r.notify({type:"success",text:("add"===e.addOrModifyWork.status?"新建":"修改")+"工单配置成功"})}),this.clear()},e.addOrModifyWork.clear=function(){this.error=!1,this.obj={},this.form.$setPristine(),e.toggleNavTree2(!0),t.checkNodeByCodes("areaTree2",[]),$("#addOrModifyWorkModal").modal("hide")},e.deleteWorkConfig={toModal:function(e){this.obj=e,$("#deleteWorkConfigModal").modal("show")},clear:function(){$("#deleteWorkConfigModal").modal("hide")},execute:function(){i.deleteWorkConfig({id:this.obj.id},function(){d()}),this.clear()}},e.showSingleWork=function(){i.getWorkDetail(e.curWork.id,function(r){e.curWork=r.workList[0],e.curWork.workRecordList=r.workRecordList}),e.alarmHeight=40*e.curWork.alarmList.length+40+52+"px",e.ifShowSingleWork=!0},e.redeploy={obj:{},toModal:function(){this.obj.sentTime=(new Date).getTime(),$("#redeployModal").modal("show"),i.getMaintainersFromSite(e.curWork.site.strId,function(t){e.workerList=t.filter(function(e){return e.name!==r.user.name})}),this.interval=setInterval(function(){e.redeploy.obj.sentTime=(new Date).getTime(),e.$apply()},1e3)},clear:function(){$("#redeployModal").modal("hide"),clearInterval(this.interval)},execute:function(){var t={workId:e.curWork.id,worker:{strId:r.user.username,name:r.user.name},receiver:{strId:this.obj.receiver.username,name:this.obj.receiver.name},workerAccount:r.user.username,workerPhone:r.user.phone,operateDescribe:this.obj.operateDescribe};i.redeployWork(t,function(){e.showSingleWork()}),this.clear()}},e.urge={obj:{},toModal:function(){this.obj.urgeTime=(new Date).getTime(),$("#urgeModal").modal("show"),this.interval=setInterval(function(){e.urge.obj.urgeTime=(new Date).getTime(),e.$apply()},1e3)},clear:function(){$("#urgeModal").modal("hide"),clearInterval(this.interval)},execute:function(){i.urgeWork({workId:e.curWork.id,operateDescribe:this.obj.operateDescribe},function(){e.showSingleWork()}),this.clear()}},e.response={obj:{},toModal:function(){this.obj.result="已完成",this.obj.method="远程",this.obj.responseTime=(new Date).getTime(),$("#responseModal").modal("show"),this.interval=setInterval(function(){e.response.obj.responseTime=(new Date).getTime(),e.$apply()},1e3)},clear:function(){$("#responseModal").modal("hide"),clearInterval(this.interval)},execute:function(){var t={workId:e.curWork.id,worker:{strId:r.user.id,name:r.user.name},workerAccount:r.user.username,workerPhone:r.user.phone,operateDescribe:this.obj.operateDescribe,reason:this.obj.reason,handleWay:this.obj.handleWay,handleResult:this.obj.handleResult};t.verifyWay="已完成"===this.obj.handleResult?"告警消除":"不验证",i.responseWork(t,function(){e.showSingleWork()}),this.clear()}},e.cancleWork=function(r){i.cancleWork(r.id,function(){l(),e.ifShowSingleWork&&e.showSingleWork()})},e.deployWork=function(e){i.deployWork(e.alarmList[0].alarmId,function(){l()})},e.changeHasTree=function(e){r.__navbarHasTree=0===e,r.$emit("updateTreetop")},function(){e.target2=r.util.getToggleParam(null,[".nav-tree-sm"],{left:"0"},{left:"-232px"})}(),function(){o.getDeviceTypeList(null,function(r){e.deviceTypeList=r,n.getSignalListBySignalTypeAndDeviceType({signalType:0},function(r){e.deviceTypeList=e.deviceTypeList.map(function(e){return{code:e.code,typeName:e.typeName,signalTypeList:r.filter(function(r){return r.deviceCode===e.code})}}).filter(function(e){return e.signalTypeList.length>0}),e.deviceTypeList.unshift({signalTypeList:r,typeName:"全部"}),e.orderQuery.device=e.deviceTypeList[0],e.allDeviceTypeListForSelect2={data:e.deviceTypeList[0].signalTypeList.map(function(e,r){return{id:r,text:e.signalName}})}})})}(),function(){e.treeLoading=!0,e.treeLoading2=!0,t.getTierTree(null,function(r){e.treeLoading=!1,e.treeLoading2=!1,e.zTree=t.createZTree(r),e.zTree2=t.createZTree(angular.copy(r)),t.initTree(e.zTree.zNodes,"areaTree","checkboxTierTree",function(){a("areaTree")}),t.initTree(e.zTree2.zNodes,"areaTree2","checkboxTierTree",function(){a("areaTree2")}),t.checkedAllNodes("areaTree",!0),a("areaTree"),e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",l)},function(){e.treeLoading=!1,e.treeLoading2=!1})}()}]);