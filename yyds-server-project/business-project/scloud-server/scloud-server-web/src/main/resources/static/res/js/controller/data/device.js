scloudApp.controller("dataDeviceController",["$scope","$rootScope","siteService","deviceService","signalService","entranceService","alarmService","initService","$stateParams","$state",function(e,o,a,i,t,n,l,r,d,s){function c(o){e.params.code&&i.queryRoomConfigShow({deviceId:e.params.id},function(a){for(var i=a.signals,t=o,n=0;n<i.length;n++)for(var l=0;l<t.length;l++){var r=t[l];i[n].cntbId===r.cntbId&&(r.isSelected=!0)}e.selectCheckBoxList=e.signalAIList.filter(function(e){return e.isSelected})})}function m(a){e.isLoading[a]=!0;var i=null;a>0&&(i=o.CONST.signalType.list[a-1]),t.realTimeDataGetData({fsuCode:e.params.fsuCode,deviceId:e.params.id,deviceType:e.params.typeCode,deviceCode:e.params.code,gatewayServerCode:e.params.gatewayServerCode},function(t){e.communicationState=!0,e.communicationStateInfo="正常",e.isLoading[a]=!1;for(var n in t.infoList)t.infoList[n].forEach(function(e){e.tRecord=(new Date).getTime()});switch(i){case o.CONST.signalType.AI:e.signalAIList=t.infoList["遥测"]||[],c(e.signalAIList);break;case o.CONST.signalType.DI:e.signalDIList=t.infoList["遥信"]||[];break;case o.CONST.signalType.AO:e.signalAOList=t.infoList["遥调"]||[];break;case o.CONST.signalType.DO:e.signalDOList=t.infoList["遥控"]||[];for(var l=0;l<e.signalDOList.length;l++){var d=e.signalDOList[l];"远程关机"===d.name?d.isChecked=!d.downValue:d.isChecked=!!d.downValue}break;default:e.signalAIList=t.infoList["遥测"]||[],c(e.signalAIList),e.signalDIList=t.infoList["遥信"]||[],e.signalAOList=t.infoList["遥调"]||[],e.signalDOList=t.infoList["遥控"]||[];for(var l=0;l<e.signalDOList.length;l++){var d=e.signalDOList[l];"远程关机"===d.name?d.isChecked=!d.downValue:d.isChecked=!!d.downValue}}r.initTooltip()},function(){e.communicationState=!1,e.communicationStateInfo="异常",e.isLoading[a]=!1})}s&&(s=window.$state),d&&(d=window.$stateParams),e.params=JSON.parse(sessionStorage.getItem("data/device/device")||"{}"),e.params.code||s.go("data/site"),e.hasAuthorize=!1,e.currentTime="",e.modifyTeleSignal={form:{},obj:{},toModal:null,execute:null,clear:null,loading:!1},e.modifyTeleAdjust={form:{},obj:{},toModal:null,execute:null,clear:null,loading:!1},e.modifyTeleControl={form:{},obj:{},toModal:null,execute:null,clear:null,loading:!1},e.operateDevice={form:{},obj:{},toModal:null,execute:null,clear:null,loading:!1},e.doorLock={form:{},obj:{},toModal:null,execute:null,clear:null,loading:!1},e.isLoading=[!1,!1,!1,!1,!1],e.signalAIList=[],e.signalDIList=[],e.signalAOList=[],e.signalDOList=[],e.isSelectAll=!1,e.selectCheckBox=function(o,a){var i=e.signalAIList.filter(function(e){return e.isSelected});o?(i.length>=2&&(i[0].isSelected=!1,i.shift(a)),i.push(a)):i.splice(i.indexOf(a)),e.selectCheckBoxList=i},e.addSignalConfig=function(){e.selectCheckBoxList.forEach(function(e,o){e.order=o+1});var o=e.selectCheckBoxList.map(function(e){return{cntbId:e.cntbId,signalName:e.name,measurement:e.measurement,order:e.order}});e.params.code&&i.addSignalConfig({deviceId:e.params.id,signals:o},function(e){m(1)})},e.query=function(e){m(e)},e.focusAI=function(o,a){a.stopPropagation(),t.addFocus({deviceId:e.params.id,deviceType:e.params.typeCode,fsuCode:e.params.fsuCode,deviceCode:e.params.code,tierName:e.params.tierName,siteName:e.params.siteName,deviceName:e.params.name,cntbId:o.cntbId,typeName:o.name,measurement:o.measurement,type:o.type},function(){m(1)})},e.focusDI=function(o,a){a.stopPropagation(),t.addFocus({deviceId:e.params.id,deviceType:e.params.typeCode,fsuCode:e.params.fsuCode,deviceCode:e.params.code,tierName:e.params.tierName,siteName:e.params.siteName,deviceName:e.params.name,cntbId:o.cntbId,typeName:o.name,measurement:o.measurement,type:o.type},function(){m(2)})},e.removeFocusAI=function(e,o){o.stopPropagation(),t.removeFocus({id:e.focusId},function(){m(1)})},e.removeFocusDI=function(e,o){o.stopPropagation(),t.removeFocus({id:e.focusId},function(){m(2)})},e.modifyTeleSignal.toModal=function(o){e.currentTime=(new Date).getTime(),e.modifyTeleSignal.obj=angular.copy(o);var a=e.modifyTeleSignal.obj.name;a.match(/(温度过高|温度超高)/)?e.modifyTeleSignal.obj.backlash=-2:a.match(/(温度过低)/)?e.modifyTeleSignal.obj.backlash=2:a.match(/(湿度过高)/)?e.modifyTeleSignal.obj.backlash=-10:a.match(/(湿度过低)/)&&(e.modifyTeleSignal.obj.backlash=10),$("#modifyTeleSignalModal").modal("show")},e.modifyTeleSignal.execute=function(){e.modifyTeleSignal.loading=!0,t.realTimeDataSetThreshold({value:+e.modifyTeleSignal.obj.threshold,cntbId:e.modifyTeleSignal.obj.cntbId,fsuCode:e.params.fsuCode,deviceCode:e.params.code,gatewayServerCode:e.params.gatewayServerCode},function(){e.modifyTeleSignal.saveLog(),e.modifyTeleSignal.loading=!1,e.modifyTeleSignal.clear(),m(2)},function(){e.modifyTeleSignal.loading=!1})},e.modifyTeleSignal.clear=function(){e.modifyTeleSignal.form.$setPristine(),e.modifyTeleSignal.obj={},$("#modifyTeleSignalModal").modal("hide")},e.modifyTeleSignal.saveLog=function(){i.saveLog($.extend({ctime:e.currentTime,operate:e.modifyTeleSignal.obj.threshold,signalName:e.modifyTeleSignal.obj.name},e.logComParams),function(){})},e.modifyTeleAdjust.toModal=function(o){e.modifyTeleAdjust.obj=angular.copy(o),$("#modifyTeleAdjustModal").modal("show"),e.currentTime=(new Date).getTime()},e.modifyTeleAdjust.execute=function(){e.modifyTeleAdjust.loading=!0,t.realTimeDataSetPoint({value:+e.modifyTeleAdjust.obj.value,cntbId:e.modifyTeleAdjust.obj.cntbId,fsuCode:e.params.fsuCode,deviceCode:e.params.code,gatewayServerCode:e.params.gatewayServerCode},function(){e.modifyTeleAdjust.saveLog(),e.modifyTeleAdjust.loading=!1,e.modifyTeleAdjust.clear(),e.query(3)},function(){e.modifyTeleAdjust.loading=!1})},e.modifyTeleAdjust.clear=function(){e.modifyTeleAdjust.form.$setPristine(),e.modifyTeleAdjust.obj={},$("#modifyTeleAdjustModal").modal("hide")},e.modifyTeleAdjust.saveLog=function(){i.saveLog($.extend({ctime:e.currentTime,operate:e.modifyTeleAdjust.obj.value,signalName:e.modifyTeleAdjust.obj.name},e.logComParams),function(){})},e.modifyTeleControl.toModal=function(o){e.modifyTeleControl.obj=angular.copy(o),e.currentTime=(new Date).getTime(),$("#modifyTeleControlModal").modal("show")},e.modifyTeleControl.execute=function(){e.modifyTeleControl.loading=!0,t.realTimeDataSetPoint({value:+e.modifyTeleControl.obj.value,cntbId:e.modifyTeleControl.obj.cntbId,fsuCode:e.params.fsuCode,deviceCode:e.params.code,gatewayServerCode:e.params.gatewayServerCode},function(){e.modifyTeleControl.saveLog(),e.modifyTeleControl.loading=!1,e.modifyTeleControl.clear(),e.query(4)},function(){e.modifyTeleControl.loading=!1})},e.modifyTeleControl.clear=function(){e.modifyTeleControl.form.$setPristine(),e.modifyTeleControl.obj={},$("#modifyTeleControlModal").modal("hide")},e.modifyTeleControl.saveLog=function(){i.saveLog($.extend({ctime:e.currentTime,operate:e.modifyTeleControl.obj.value,signalName:e.modifyTeleControl.obj.name},e.logComParams),function(){})},e.operateDevice.toModal=function(o){e.operateDevice.obj=o,e.currentTime=(new Date).getTime(),e.operateDevice.obj.isChecked=!e.operateDevice.obj.isChecked,$("#operateDeviceModal").modal("show")},e.operateDevice.execute=function(){e.operateDevice.loading=!0,e.operateDevice.obj.value=1&("远程关机"===e.operateDevice.obj.name?!e.operateDevice.obj.isChecked:e.operateDevice.obj.isChecked),t.realTimeDataSetPoint({value:e.operateDevice.obj.value,cntbId:e.operateDevice.obj.cntbId,fsuCode:e.params.fsuCode,deviceCode:e.params.code,gatewayServerCode:e.params.gatewayServerCode},function(){e.operateDevice.saveLogForLeftControl(),e.query(4),e.operateDevice.loading=!1,e.operateDevice.obj={},$("#operateDeviceModal").modal("hide")},function(){e.operateDevice.obj.isChecked=!e.operateDevice.obj.isChecked,e.operateDevice.loading=!1})},e.operateDevice.clear=function(){e.operateDevice.form.$setPristine(),e.operateDevice.obj.isChecked=!e.operateDevice.obj.isChecked,e.operateDevice.obj={},$("#operateDeviceModal").modal("hide")},e.operateDevice.saveLogForLeftControl=function(){i.saveLog($.extend({ctime:e.currentTime,operate:e.operateDevice.obj.value,signalName:e.operateDevice.obj.name},e.logComParams),function(e){})},e.doorLock.toModal=function(o){e.doorLock.obj=o,e.currentTime=(new Date).getTime(),$("#doorLockModal").modal("show")},e.doorLock.execute=function(){t.modifyTeleControl(e.doorLock.obj,function(){e.doorLock.clear()},function(){})},e.doorLock.clear=function(){e.doorLock.form.$setPristine(),e.doorLock.obj={},$("#doorLockModal").modal("hide")},e.back=function(){"scenePage"===d.parentPage||"scenePage"===e.params.parentPage?s.go("SDGD/scene/site",{siteId:e.params.siteId,dataDeviceData:d.dataSiteData}):"deviceManage"===d.parentPage||"deviceManage"===e.params.parentPage?s.go("ZKSDGD/deviceManage"):s.go("SDGD/data/site",{siteId:e.params.siteId,dataDeviceData:d.dataSiteData})},e.go=function(e,o){s.go(e,o)},e.realTimeMonitor={obj:{},dataList:[],lastRefresh:null,chart:null,refreshList:[{name:"5秒",value:5},{name:"10秒",value:10},{name:"20秒",value:20},{name:"30秒",value:30},{name:"60秒",value:60}],toModal:function(e){this.obj.signalId=e.cntbId,this.obj.refreshInterval=this.lastRefresh||5,$("#realTimeMonitorModal").modal("show"),setTimeout(function(){this.chart=chart.realTimeMonitor({id:"realTimeMonitorChart"}),this.query()}.bind(this),200)},clear:function(){$("#realTimeMonitorModal").modal("hide"),this.lastRefresh=this.obj.refreshInterval,this.obj={},clearInterval(this.interval)},query:function(){clearInterval(this.interval),this.dataList=[];var o=e.signalAIList.filter(function(o){return o.cntbId===e.realTimeMonitor.obj.signalId})[0];this.dataList.measurement=o.measurement,this.dataList.name=o.name;var a=location.hash,i=function(){location.hash!==a&&clearInterval(n),t.realTimeDataGetDataDetail({gatewayServerCode:e.params.gatewayServerCode,cntbId:o.cntbId,fsuCode:e.params.fsuCode,deviceCode:e.params.code},function(e){this.dataList.push({timeStamp:(new Date).getTime(),value:e}),this.chart.updateChart(this.dataList)}.bind(this))}.bind(this),n=this.interval=setInterval(i,1e3*this.obj.refreshInterval);i()}},function(){t.realTimeDataFsuInfo({deviceCode:e.params.code},function(o){e.params.fsuCode=o.code,e.params.gatewayServerCode=o.gatewayServerCode,m(0)})}()}]);