scloudApp.controller("configurationManagerController",["$scope","$rootScope","treeService","configurationService","$q","$state","$stateParams",function(e,t,o,i,n,r,a){function s(){window.scene3D?e.scene3D=window.scene3D:window.scene3D=e.scene3D=new Scene3D}function c(e){l(e)&&f().then(d).then(h)}function u(t){e.treeLoading=!0,o.getSiteMapTree({serverCode:e.user.serverCode},function(i){e.treeLoading=!1,e.zTree=o.createZTree(i),o.initTree(e.zTree.zNodes,"areaTree","radioSiteTree",function(){e.cancleNextLoading?e.cancleNextLoading=!1:t&&t("areaTree")}),o.checkNodeBySiteId("areaTree",a.siteId)})}function l(i){var n=o.getCheckedNode(i);if(n){if(e.isShowBufferList=!1,e.bufferList=[],scene3D.undoList&&scene3D.undoList.dirty){if(!confirm("您有尚未保存的修改，是否要放弃修改？"))return e.cancleNextLoading=!0,void o.checkNodeBySiteId("areaTree",e.currentSite.id);scene3D.undoList.reset()}return scene3D&&scene3D.dispose(),e.c++,e.currentSite=n,!0}return t.notify({type:"warn",text:"请选择一个站点"}),!1}function f(){var o=n.defer(),r=o.promise;return i.getDevicesListApi(e.currentSite.code,function(i){e.deviceList=i,e.devicesNeedLoad=[],i.forEach(function(o){var i=t.configurationDeviceMap(o.type);Array.prototype.push.apply(e.devicesNeedLoad,i)}),e.devicesNeedLoad=e.devicesNeedLoad.unique(),e.devicesNeedLoad=e.devicesNeedLoad.concat(t.configurationDeviceMap.getList({scene:!0,subType:!1})),o.resolve()}),r}function d(t){var o=n.defer(),r=o.promise;return i.executeModelFile(function(){e.deviceTypeList=i.objectToArray(e.devices,!0),e.sceneModelList=Array.prototype.concat.apply([],i.objectToArray(e.devices,!1).map(function(e){return e.list})),o.resolve()}),r}function h(){i.loadSceneApi({siteId:e.currentSite.id},function(t){i.scene_import(t,function(){e.methods.getCurMode(t),i.showLoadingBar(!1,100)})})}r&&(r=window.$state),a&&(a=window.$stateParams),location.hash="#/configuration/manager?siteId="+a.siteId,e.tabPage=t.util.tabPage.getInstance(["快速生成","场景模型","设备类型"]),e.searchKey={online:!0,offline:!0,keyword:""},e.getNodesByParamFuzzy=function(){setTimeout(function(){e.zTree.getNodesByParamFuzzy(e.searchKey,"areaTree","radioSiteTree",function(){c("areaTree")})},10)},e.methods={selectType:function(t){e.currentType=t;for(var o=0;o<e.bufferList.length;o++)e.bufferList[o].isHide=!1;e.bufferList=[],e.isShowBufferList=!1,e.searchContent=""},createScene:function(e){Object.keys(scene3D.deviceToMesh).length>0?alert("请先点击重置按钮，重置场景"):scene3D.addPreBuild(e)},createCapsule:function(t){Object.keys(scene3D.deviceToMesh).length>0?alert("请先点击重置按钮，重置场景"):(scene3D.addPreBuild(t),e.curMode="capsule")},copyToBufferList:function(t,o){e.isShowBufferList=!0;var i=e.devices[t].list.indexOf(o);o=e.devices[t].list[i],o.isHide=!0,o.index=i,e.bufferList.push(o)},addDeviceWhetherNeedContainer:function(t,o,i,n){t?this.copyToBufferList(o,n):e.SetConfiguration.addDevices(n)},addNewDevices:function(t){e.SetConfiguration.addDevices(t),e.isShowBufferList=!1},showBufferList:function(){0===e.bufferList.length?e.isShowBufferList=!1:e.isShowBufferList=!0},moveToDeviceList:function(t,o){t.isHide=!1;var i=e.bufferList.indexOf(t);e.bufferList.splice(i,1),e.currentType=o,this.showBufferList()},moveAllToDeviceList:function(){for(var t=0;t<e.bufferList.length;t++)e.bufferList[t].isHide=!1;e.bufferList=[],e.isShowBufferList=!1},toggleModify:function(t){e.isDefaultDeviceInfo=!e.isDefaultDeviceInfo,"修改"===t.target.innerHTML?t.target.innerHTML="确定":t.target.innerHTML="修改"},saveModify:function(t){if(e.isDefaultDeviceInfo=!e.isDefaultDeviceInfo,"修改"===t.target.innerHTML)return void(t.target.innerHTML="确定");t.target.innerHTML="修改",i.saveName();var o=e.curContainer.spec.x/e.curContainer.scale.x*e.curContainer.newScale.x*e.curContainer.flipX,n=e.curContainer.spec.y/e.curContainer.scale.y*e.curContainer.newScale.x,r=e.curContainer.spec.z/e.curContainer.scale.z*e.curContainer.newScale.x*e.curContainer.flipZ;e.curContainer.position.y=e.curContainer.newScale.x/Math.abs(e.curContainer.scale.x)/2*e.curContainer.spec.y+e.curContainer.hangOver,e.curContainer.spec.set(o,n,r),scene3D.undoList.push("pro",{mesh:scene3D.deviceToMesh[e.curContainer.device.code],new:{spec:e.curContainer.spec.clone(),name:e.curContainer.device.name,positionY:e.curContainer.position.y},old:e.curContainer.originValue}),e.curContainer.originValue={spec:e.curContainer.spec.clone(),name:e.curContainer.device.name,positionY:e.curContainer.position.y},scene3D.deviceToMesh[e.curContainer.device.code].reverse((1-e.curContainer.flipX*e.curContainer.flipZ)/2)},redo:function(){if(e.canRedo){var t=i.redo();e.canUndo=t[0],e.canRedo=t[1]}},undo:function(){if(e.canUndo){var t=i.undo();e.canUndo=t[0],e.canRedo=t[1]}},showDeviceInfo:function(e){i.showDeviceInfo(e)},hideDeviceInfo:function(t){i.hideDeviceInfo(t),e.isDefaultDeviceInfo=!0,$("#propertyModal").find(".modal-footer").find("button").last().innerHTML="修改"},rotate:function(){i.rotate()},deleteObj:function(e){e?(i.deleteObj(),$("#alarmModal").modal("hide")):$("#alarmModal").modal("hide")},showAlarmModal:function(t){"selecting"===scene3D.user.state&&"delete"===t?(e.selectedButtonName="删除",$("#alarmModal").modal("show")):"reset"===t?(e.selectedButtonName="重置",$("#alarmModal").modal("show")):"save"===t&&(e.selectedButtonName="保存",$("#alarmModal").modal("show"))},sceneSave:function(t){if(t){var o=i.scene_save();o.siteId=e.currentSite.id;var n=scene3D.undoList,r=["新增","删除"],a=n.list.filter(function(e){return e.dirty&&-1!==["add","new","del"].indexOf(e.type)}).map(function(e){return{detail:{add:0,new:0,del:1}[e.type],tRecord:e.timeStamp}});a.length>0&&(n.list[n.ptr]&&n.list[n.ptr].dirty&&a.reverse().forEach(function(e){e.detail=(e.detail+1)%2}),a.forEach(function(e){e.detail=r[e.detail]})),n.list.forEach(function(e){e.dirty=!1}),i.saveSceneApi(o,null),$("#alarmModal").modal("hide")}else $("#alarmModal").modal("hide")},sceneReset:function(t){$("#alarmModal").modal("hide"),t&&(i.resetSceneApi(),e.canUndo=e.canRedo=!1,"capsule"===e.curMode&&(e.curMode="normal"))},bindingDevice:{show:!1,type:"",clear:function(){"bind"===this.type?scene3D.bindingDevice(!1):scene3D.groupingDevice(!1),this.show=!1,e.disabledAll=!1},toModal:function(t,o){"bind"===o?scene3D.bindingDevice(!0,t.device):scene3D.groupingDevice(!0,t.device),this.type=o,this.show=!0,e.disabledAll=!0}},getCurMode:function(t){var o=JSON.stringify(t);o.match(/capsule/)?e.curMode="capsule":o.match(/FOCProductionLine/)?e.curMode="FOC":e.curMode="normal"},colorConfig:{show:!1,__init:setTimeout(function(){["bgColor","floorColor"].map(function(t){$("#"+t).colpick({layout:"rgbhex",submit:1,colorScheme:"dark",color:e.methods.colorConfig[t],onSubmit:function(o,i,n,r){$(r).colpickHide(),e.methods.colorConfig[t]="#"+i,e.$apply()}})})},0),list:["bg","floor"],tabPage:t.util.tabPage.getInstance(["背景","地板"]),getStyle:function(e,t){return{backgroundColor:e,opacity:t}},bgColor:"#ffffff",bgOpacity:0,floorColor:"#ffffff",floorOpacity:1,toModal:function(){var e=localStorage.getItem("sceneColor");e&&(e=JSON.parse(e),this.bgColor=e.bgColor,this.bgOpacity=e.bgOpacity,this.floorColor=e.floorColor,this.floorOpacity=e.floorOpacity),this.show=!0},execute:function(){this.apply(),this.clear()},apply:function(){scene3D.renderer.setClearColor(this.bgColor),scene3D.renderer.setClearAlpha(this.bgOpacity),scene3D.plane.material.transparent=!(this.floorOpacity+""=="1"),scene3D.plane.material.color.set(this.floorColor),scene3D.plane.material.opacity=Number(this.floorOpacity);var e={bgColor:this.bgColor,bgOpacity:this.bgOpacity,floorColor:this.floorColor,floorOpacity:this.floorOpacity};localStorage.setItem("sceneColor",JSON.stringify(e))},clear:function(){this.setDefault(),this.show=!1},setDefault:function(){this.bgColor="#ffffff",this.bgOpacity=0,this.floorColor="#ffffff",this.floorOpacity=1}},exportToBackground:{toModal:function(){this.textList=[],this.curText=null,this.curColor="#ffffff",this.curRotation=0,this.editText=!0,this.totalFontSize=0,this.offset={},delete scene3D.smartBackgroundRoom,$("#smartControl").modal("show"),scene3D.exportToBackground($("#smartControlCanvas")[0],0),this.totalFontSize=$("#smartControlCanvas").width()/$("#smartControlCanvas")[0].width*100},textList:[],clear:function(){$("#smartControl").modal("hide"),this.textList.length=0},execute:function(){var o=$("#smartControlCanvas")[0].width/$("#smartControlCanvas").width(),n=this.textList.map(function(e){return{pos:{x:e.pos.x*o,y:e.pos.y*o},width:e.width*o,text:e.text}}),r=this;scene3D.exportToBackground($("#smartControlCanvas")[0],this.curRotation,{textList:n,textScale:r.textScale,callback:function(o){o.payload.siteId=e.currentSite.id,fd=new FormData,fd.append("file",o.blob,"image.png"),fd.append("siteId",e.currentSite.id),i.saveAppLocateBackground(o.payload,fd,function(){t.notify({type:"success",text:"组态背景图存储成功!"}),r.clear()},function(){console.log("error"),r.clear()})}})},turnLeft:function(){this.curRotation--,scene3D.exportToBackground($("#smartControlCanvas")[0],this.curRotation),this.applyRotation(-1)},turnRight:function(){this.curRotation++,scene3D.exportToBackground($("#smartControlCanvas")[0],this.curRotation),this.applyRotation(1)},startPos:{},startTime:0,isMouseDown:!1,curText:null,offset:{},totalFontSize:0,curColor:"#ffffff",curRotation:0,editText:!0,_textScale:50,textScale:1,updateTextScale:function(e){this.textScale=this._textScale<50?this._textScale/50:9*(this._textScale/50-1)+1,this.textScale=Math.round(100*this.textScale)/100},createText:function(e){var t={text:"",pos:{x:e.offsetX,y:e.offsetY},active:!0};this.textList.push(t),this.curText=t},applyRotation:function(e){var t,o,i,n,r=($("#smartControlCanvas").width(),$("#smartControlCanvas").height(),$("#smartControlCanvas")[0].width),a=$("#smartControlCanvas")[0].height;n=r/a>4/3?800/r:600/a,a/r>4/3?(i=800/a,o=800,t=r/a*800):(i=600/r,o=a/r*600,t=600),e>0?this.textList.forEach(function(e,o){e.pos={x:(t-e.pos.y)/i*n,y:e.pos.x/i*n}}):this.textList.forEach(function(e,t){e.pos={x:e.pos.y/i*n,y:(o-e.pos.x)/i*n}})},toDelete:function(e,t){this.textList.splice(this.textList.indexOf(t)),e.stopPropagation()},labelIsHide:function(e){return e===this.curText?"hide":""},mousedown:function(e,t){this.startTime=(new Date).getTime(),this.startPos={x:e.clientX,y:e.clientY},this.offset={x:e.offsetX,y:e.offsetY},this.isMouseDown=!0,this.lastText=this.curText,this.curText=t},mouseup:function(e){var t=(new Date).getTime(),o={x:e.clientX,y:e.clientY};this.isMouseDown=!1,t-this.startTime<300&&Math.pow(o.x-this.startPos.x,2)+Math.pow(o.y-this.startPos.y,2)<100&&this.click(e.target),e.stopPropagation()},mousemove:function(e){this.isMouseDown&&this.curText&&(this.curText.pos.x=e.clientX-this.offset.x+this.curText.width/2*this.textScale-$("#smartControlCanvas").offset().left,this.curText.pos.y=e.clientY-this.offset.y+this.totalFontSize/2*this.textScale-$("#smartControlCanvas").offset().top)},onBlur:function(){var e=$("#smartControlCanvas")[0],t=e.getContext("2d");t.font=this.totalFontSize+"px microsoft Yahei";var o;this.isMouseDown?(this.lastText.active=!1,o=this.lastText.text,this.lastText.width=t.measureText(o).width):(this.curText.active=!1,o=this.curText.text,this.curText.width=t.measureText(o).width)},onChange:function(){this.curText.text},click:function(e){this.curText.active=!0},canvasHover:function(e){var t=e.offsetX/$("#smartControlCanvas").width()*$("#smartControlCanvas")[0].width,o=e.offsetY/$("#smartControlCanvas").height()*$("#smartControlCanvas")[0].height;scene3D.smartBackgroundRoom.hover(t,o)},canvasLeave:function(){scene3D.smartBackgroundRoom.hover(-1,-1)},canvasClick:function(){scene3D.smartBackgroundRoom.click()},setColor:function(){scene3D.smartBackgroundRoom.setColor(Number(this.curColor.replace("#","0x")))}}},function(){e.currentType="airCon",e.currentIndex=0,e.bufferList=[],e.propertyList=[],e.modelFn=[],e.cabinetName="",e.isLoading=!0,e.c=0,e.isDefaultDeviceInfo=!0,e.curMode="normal",e.modes=["normal","capsule","FOC"],e.visibleItemList={normal:t.configurationDeviceMap.getList({mode:"normal"}),capsule:t.configurationDeviceMap.getList({mode:"capsule"}),FOC:t.configurationDeviceMap.getList({mode:"FOC"})},e.devicesNeedLoad=[],e.visibleInMode=function(t){return e.visibleItemList[e.curMode].indexOf(t.subType&&"default"!==t.subType?t.subType:t.type)>=0},e.order={byScene:function(t){return e.visibleItemList[e.curMode].indexOf("default"===t.subType?t.type:t.subType)}},e.needLoad=function(t){return e.devicesNeedLoad.indexOf(t.name.type)<0?0:scene3D.model[t.name.type]?1:2},s(),THREEx.Cache.connectToDB(function(){u(function(e){c(e)}),e.SetConfiguration=i,e.SetConfiguration.getScope(e),e.scene3D.init(e,"administrator")}),e.addPositionY=0,e.canUndo=!1,e.canRedo=!1,e.other2=t.util.getToggleParam(null,[".center"],{right:"276px"},{right:"0px"}),e.target2=t.util.getToggleParam(null,[".right"],{right:"0"},{right:"-300px"}),e.$watch("curContainer.newScale.x",function(e,t){})}()}]);