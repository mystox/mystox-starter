scloudApp.controller("dataHistoryController",["$scope","$rootScope","$stateParams","$filter","treeService","deviceService","signalService","initService",function(e,t,a,i,n,r,s,o){function g(a){var i=n.getCheckedNode(a);if(!i)return void t.notify({type:"warn",text:"请选择一个站点"});e.historyDataQuery.siteCode=i.code,e.historyDataQuery.siteName=i.name,e.getDeviceList(),e.$apply()}function d(){e.signalsTotalHistoryList=null;var t=e.signalList;if(null!==t&&0!==t.length){if(!e.historyDataQuery.tStart||!e.historyDataQuery.tEnd){var a=new Date;a.setDate(a.getDate()+1),e.historyDataQuery.tEnd=i("date")(a,"yyyy/MM/dd 00:00:00"),a.setDate(a.getDate()-30),e.historyDataQuery.tStart=i("date")(a,"yyyy/MM/dd 00:00:00")}var n=[];t.forEach(function(e){n.push(e.strId)}),e.isLoading2=!0,s.getHistoryDataForSiganls({startTime:new Date(e.historyDataQuery.tStart).getTime(),endTime:new Date(e.historyDataQuery.tEnd).getTime(),deviceCode:e.historyDataQuery.deviceId,pageSize:e.paginationConf2.itemsPerPage,currentPage:e.paginationConf2.currentPage},function(t){e.isLoading2=!1,t?(e.signalsTotalHistoryList=t.list,t.list.forEach(function(t){t.datas=e.signalList.map(function(e){return t.value[e.cntbId]})}),e.signals=e.signalList,e.units=e.signalList.map(function(e){return e.measurement}),e.paginationConf2.totalItems=t.count):(e.paginationConf2.totalItems=0,e.signalsTotalHistoryList=[]),o.initTooltip()},function(){e.isLoading2=!1})}}function l(t){if(t){if(!e.historyDataQuery.tStart||!e.historyDataQuery.tEnd){var a=new Date;a.setDate(a.getDate()+1),e.historyDataQuery.tEnd=i("date")(a,"yyyy/MM/dd 00:00:00"),a.setDate(a.getDate()-30),e.historyDataQuery.tStart=i("date")(a,"yyyy/MM/dd 00:00:00")}e.signalDataList=null,e.isLoading=!0,e.signalDetail=e.getCurrentSignal(),s.getHistoryData({startTime:new Date(e.historyDataQuery.tStart).getTime(),endTime:new Date(e.historyDataQuery.tEnd).getTime(),cntbId:t,deviceCode:e.historyDataQuery.deviceId,pageSize:999999999,currentPage:1},function(t){if(e.isLoading=!1,t.list&&t.list.length>0){for(var a=t.list,n=[],r=[],s=0;s<a.length;s++)n[s]=i("date")(a[s].time,"yyyy-MM-dd HH:mm"),r[s]=a[s].value;e.signalDataTotalList=a,e.measurement=e.signalDetail.measurement,e.paginationConf.totalItems=t.count,u(),e.dataLineChart=chart.dataLine({id:"dataLine",measurement:e.measurement,seriesName:e.signalDetail.typeName,xData:n,yData:r})}else e.dataLineChart&&(scloudCharts.splice(scloudCharts.indexOf(e.dataLineChart),1),e.dataLineChart.dispose()),e.paginationConf.totalItems=0,e.signalDataTotalList=[],e.signalDataList=[]},function(){e.isLoading=!1});var n=e.getCurrentDevice(),r=e.getCurrentSite();s.getSingleSignalListLeft({startTime:new Date(e.historyDataQuery.tStart).getTime(),endTime:new Date(e.historyDataQuery.tEnd).getTime(),cntbId:t,deviceCode:e.historyDataQuery.deviceId,pageSize:99999999,currentPage:1,tierName:r.tierName,siteName:r.siteName,deviceName:n.name,signalName:e.signalDetail.typeName,siteCode:r.siteCode},function(t){t.forEach(function(e){e.avgValue=e.avgValue.toFixed(2)}),e.signalLeftList=t,e.paginationConf3.totalItems=e.signalLeftList.length,y()})}}function u(){e.signalDataTotalList&&0!==e.signalDataTotalList.length?e.signalDataList=e.signalDataTotalList.getPaginationItems(e.paginationConf.itemsPerPage,e.paginationConf.currentPage,!0):e.signalDataList=[]}function y(){e.signalLeftList&&0!==e.signalLeftList.length?e.signalsHistoryList2=e.signalLeftList.getPaginationItems(e.paginationConf3.itemsPerPage,e.paginationConf3.currentPage,!0):e.signalsHistoryList2=[]}$state&&($state=window.$state),a&&(a=window.$stateParams),e.historyDataQuery={},e.dataLineChart=null;var c=a;e.isLoading=!1,e.isLoading2=!1,e.isLoading3=!1,e.isAirCon=!1,e.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.paginationConf2={currentPage:1,itemsPerPage:15,pagesLength:5,onChange:function(){}},e.paginationConf3={currentPage:1,itemsPerPage:15,pagesLength:5,onChange:function(){}},e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",u),e.$watch("paginationConf2.currentPage + paginationConf2.itemsPerPage",d),e.$watch("paginationConf3.currentPage + paginationConf3.itemsPerPage",y),e.tabPage=t.util.tabPage.getInstance(["历史数据统计图","历史数据统计表"]),e.getCurrentDevice=function(){return(e.deviceList||[]).filter(function(t){return t.code===e.historyDataQuery.deviceId})[0]||{}},e.getCurrentSignal=function(){return(e.signalList||[]).filter(function(t){return t.cntbId===e.historyDataQuery.signalId})[0]},e.getCurrentSite=function(){var e=n.getCheckedNode("areaTree");return{site:e,tierName:e.getParentNode().getParentNode().getParentNode().name+"-"+e.getParentNode().getParentNode().name+"-"+e.getParentNode().name,siteName:e.name,siteCode:e.code}},e.getDeviceList=function(t){r.getDeviceListOnSite({siteCodes:[e.historyDataQuery.siteCode],serverCode:e.user.serverCode,currentPage:1,pageSize:122},function(a){e.deviceList=a.list,t&&t()})},e.getSignalList=function(t,a,i){e.historyDataQuery.signalId=null;var n=e.deviceList.filter(function(e){return e.code===t})[0]||{};s.realTimeDataGetSignalInfo({deviceType:n.typeCode,type:"遥测"},function(t){e.signalList=t.signalTypeList,t.signalTypeList.some(function(e){return"回风温度1"===e.typeName})?(e.isAirCon=!0,e.historyDataQuery.signalId=t.signalTypeList[0].cntbId):(e.isAirCon=!1,e.historyDataQuery.signalId=a),i&&i()})},e.searchKey={online:!0,offline:!0,keyword:""},e.getNodesByParamFuzzy=function(t){setTimeout(function(){e.zTree.getNodesByParamFuzzy(e.searchKey,"areaTree","radioSiteTree",function(){g("areaTree")})},10),t||(e.historyDataQuery=e.historyDataQuery.__get("tStart","tEnd"),e.systemList=null,e.deviceList=null,e.signalList=null)},e.query=function(){if(!e.historyDataQuery.deviceId&&!e.historyDataQuery.signalId)return void t.notify({type:"warn",text:"请选择设备或信号"});e.historyDataQuery.signalId?l(e.historyDataQuery.signalId):e.historyDataQuery.deviceId&&d()},e.reset=function(){e.historyDataQuery={},e.searchKey.keyword="",e.getNodesByParamFuzzy(!0),e.systemList=null,e.deviceList=null,e.signalList=null},e.exportHistoryData=function(){var t=e.signalList;if(null!==t&&0!==t.length){e.isExportHistoryDataLoading=!0;var a=e.getCurrentDevice();s.exportHistoryData({startTime:new Date(e.historyDataQuery.tStart).getTime(),endTime:new Date(e.historyDataQuery.tEnd).getTime(),deviceCode:e.historyDataQuery.deviceId,deviceType:a.typeCode},function(){e.isExportHistoryDataLoading=!1,e.exportHistoryData.have=!1})}},e.exportHistoryData.have=!0,e.exportSingleSignalListLeft=function(){var t=e.getCurrentSignal(),a=e.getCurrentDevice(),i=e.getCurrentSite();s.exportSingleSignalListLeft({startTime:new Date(e.historyDataQuery.tStart).getTime(),endTime:new Date(e.historyDataQuery.tEnd).getTime(),cntbId:t.cntbId,deviceCode:e.historyDataQuery.deviceId,pageSize:99999999,currentPage:1,tierName:i.tierName,siteName:i.siteName,deviceName:a.name,signalName:t.typeName,siteCode:i.siteCode},function(){}),e.exportSingleSignalListLeft.have=!1},e.exportSingleSignalListLeft.have=!0,e.exportSingleSignalListLeftPdf=function(){s.exportSingleSignalListLeftPdf({signalId:e.historyDataQuery.signalId,tStart:new Date(e.historyDataQuery.tStart).getTime(),tEnd:new Date(e.historyDataQuery.tEnd).getTime()},function(){}),e.exportSingleSignalListLeftPdf.have=!1},e.exportSingleSignalListLeftPdf.have=!0,e.exportSingleSignalListRight=function(){s.exportSingleSignalListRight({startTime:new Date(e.historyDataQuery.tStart).getTime(),endTime:new Date(e.historyDataQuery.tEnd).getTime(),cntbId:e.signalDetail.cntbId,deviceCode:e.historyDataQuery.deviceId},function(){}),e.exportSingleSignalListRight.have=!1},e.exportSingleSignalListRight.have=!0,e.exportSingleSignalListRightPdf=function(){s.exportSingleSignalListRightPdf({signalId:e.historyDataQuery.signalId,tStart:new Date(e.historyDataQuery.tStart).getTime(),tEnd:new Date(e.historyDataQuery.tEnd).getTime()},function(){}),e.exportSingleSignalListRightPdf.have=!1},e.exportSingleSignalListRightPdf.have=!0,function(){e.treeLoading=!0,n.getSiteMapTree({serverCode:e.user.serverCode},function(t){e.treeLoading=!1,e.zTree=n.createZTree(t),n.initTree(e.zTree.zNodes,"areaTree","radioSiteTree",function(){g("areaTree")}),c.siteId&&n.checkNodeBySiteId("areaTree",c.siteId)})}(),c.signalId&&(e.historyDataQuery.siteCode=c.siteCode,e.historyDataQuery.siteName=c.siteName,e.historyDataQuery.deviceId=c.deviceCode,e.getDeviceList(function(){e.getSignalList(c.deviceCode,c.signalId,function(){l(c.signalId)})}))}]);