scloudApp.controller("dataHistoryController",["$scope","$rootScope","$stateParams","$filter","treeService","deviceService","signalService","initService",function(t,e,a,i,n,r,s,o){function g(a){var i=n.getCheckedNode(a);if(!i)return void e.notify({type:"warn",text:"请选择一个站点"});t.historyDataQuery.siteCode=i.code,t.historyDataQuery.siteName=i.name,t.getDeviceList(),t.$apply()}function d(){t.signalsTotalHistoryList=null;var e=t.signalList;if(null!==e&&0!==e.length){if(!t.historyDataQuery.tStart||!t.historyDataQuery.tEnd){var a=new Date;a.setDate(a.getDate()+1),t.historyDataQuery.tEnd=i("date")(a,"yyyy/MM/dd 00:00:00"),a.setDate(a.getDate()-30),t.historyDataQuery.tStart=i("date")(a,"yyyy/MM/dd 00:00:00")}var n=[];e.forEach(function(t){n.push(t.strId)}),t.isLoading2=!0,s.getHistoryDataForSiganls({startTime:new Date(t.historyDataQuery.tStart).getTime(),endTime:new Date(t.historyDataQuery.tEnd).getTime(),deviceCode:t.historyDataQuery.deviceId,pageSize:t.paginationConf2.itemsPerPage,currentPage:t.paginationConf2.currentPage},function(e){t.isLoading2=!1,e?(t.signalsTotalHistoryList=e.list,e.list.forEach(function(e){e.datas=t.signalList.map(function(t){return e.value[t.cntbId]})}),t.signals=t.signalList,t.units=t.signalList.map(function(t){return t.measurement}),t.paginationConf2.totalItems=e.count):(t.paginationConf2.totalItems=0,t.signalsTotalHistoryList=[]),o.initTooltip()},function(){t.isLoading2=!1})}}function l(e){if(e){if(!t.historyDataQuery.tStart||!t.historyDataQuery.tEnd){var a=new Date;a.setDate(a.getDate()+1),t.historyDataQuery.tEnd=i("date")(a,"yyyy/MM/dd 00:00:00"),a.setDate(a.getDate()-30),t.historyDataQuery.tStart=i("date")(a,"yyyy/MM/dd 00:00:00")}t.signalDataList=null,t.isLoading=!0,t.signalDetail=t.getCurrentSignal(),s.getHistoryData({startTime:new Date(t.historyDataQuery.tStart).getTime(),endTime:new Date(t.historyDataQuery.tEnd).getTime(),cntbId:e,deviceCode:t.historyDataQuery.deviceId,pageSize:999999999,currentPage:1},function(e){if(t.isLoading=!1,e.list&&e.list.length>0){for(var a=e.list,n=[],r=[],s=0;s<a.length;s++)n[s]=i("date")(a[s].time,"yyyy-MM-dd HH:mm"),r[s]=a[s].value;t.signalDataTotalList=a,t.measurement=t.signalDetail.measurement,t.paginationConf.totalItems=e.count,u(),t.dataLineChart=chart.dataLine({id:"dataLine",measurement:t.measurement,seriesName:t.signalDetail.typeName,xData:n,yData:r})}else t.dataLineChart&&(scloudCharts.splice(scloudCharts.indexOf(t.dataLineChart),1),t.dataLineChart.dispose()),t.paginationConf.totalItems=0,t.signalDataTotalList=[],t.signalDataList=[]},function(){t.isLoading=!1});var n=t.getCurrentDevice(),r=t.getCurrentSite();s.getSingleSignalListLeft({startTime:new Date(t.historyDataQuery.tStart).getTime(),endTime:new Date(t.historyDataQuery.tEnd).getTime(),cntbId:e,deviceCode:t.historyDataQuery.deviceId,pageSize:99999999,currentPage:1,tierName:r.tierName,siteName:r.siteName,deviceName:n.name,signalName:t.signalDetail.typeName,siteCode:r.siteCode},function(e){e.forEach(function(t){t.avgValue=t.avgValue.toFixed(2)}),t.signalLeftList=e,t.paginationConf3.totalItems=t.signalLeftList.length,y()})}}function u(){t.signalDataTotalList&&0!==t.signalDataTotalList.length?t.signalDataList=t.signalDataTotalList.getPaginationItems(t.paginationConf.itemsPerPage,t.paginationConf.currentPage,!0):t.signalDataList=[]}function y(){t.signalLeftList&&0!==t.signalLeftList.length?t.signalsHistoryList2=t.signalLeftList.getPaginationItems(t.paginationConf3.itemsPerPage,t.paginationConf3.currentPage,!0):t.signalsHistoryList2=[]}$state&&($state=window.$state),a&&(a=window.$stateParams),t.historyDataQuery={},t.dataLineChart=null;var c=a;t.isLoading=!1,t.isLoading2=!1,t.isLoading3=!1,t.isAirCon=!1,t.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},t.paginationConf2={currentPage:1,itemsPerPage:15,pagesLength:5,onChange:function(){}},t.paginationConf3={currentPage:1,itemsPerPage:15,pagesLength:5,onChange:function(){}},t.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",u),t.$watch("paginationConf2.currentPage + paginationConf2.itemsPerPage",d),t.$watch("paginationConf3.currentPage + paginationConf3.itemsPerPage",y),t.tabPage=e.util.tabPage.getInstance(["历史数据统计图","历史数据统计表"]),t.getCurrentDevice=function(){return(t.deviceList||[]).filter(function(e){return e.code===t.historyDataQuery.deviceId})[0]||{}},t.getCurrentSignal=function(){return(t.signalList||[]).filter(function(e){return e.cntbId===t.historyDataQuery.signalId})[0]},t.getCurrentSite=function(){var t=n.getCheckedNode("areaTree");return{site:t,tierName:t.getParentNode().getParentNode().getParentNode().name+"-"+t.getParentNode().getParentNode().name+"-"+t.getParentNode().name,siteName:t.name,siteCode:t.code}},t.getDeviceList=function(e){r.getDeviceListOnSite({siteCodes:[t.historyDataQuery.siteCode],serverCode:"TOWER_SERVER_1.0.0",currentPage:1,pageSize:122},function(a){t.deviceList=a.list,e&&e()})},t.getSignalList=function(e,a,i){t.historyDataQuery.signalId=null;var n=t.deviceList.filter(function(t){return t.code===e})[0]||{};s.realTimeDataGetSignalInfo({deviceType:n.typeCode,type:"遥测"},function(e){t.signalList=e.signalTypeList,e.signalTypeList.some(function(t){return"回风温度1"===t.typeName})?(t.isAirCon=!0,t.historyDataQuery.signalId=e.signalTypeList[0].cntbId):(t.isAirCon=!1,t.historyDataQuery.signalId=a),i&&i()})},t.searchKey={online:!0,offline:!0,keyword:""},t.getNodesByParamFuzzy=function(e){setTimeout(function(){t.zTree.getNodesByParamFuzzy(t.searchKey,"areaTree","radioSiteTree",function(){g("areaTree")})},10),e||(t.historyDataQuery=t.historyDataQuery.__get("tStart","tEnd"),t.systemList=null,t.deviceList=null,t.signalList=null)},t.query=function(){if(!t.historyDataQuery.deviceId&&!t.historyDataQuery.signalId)return void e.notify({type:"warn",text:"请选择设备或信号"});t.historyDataQuery.signalId?l(t.historyDataQuery.signalId):t.historyDataQuery.deviceId&&d()},t.reset=function(){t.historyDataQuery={},t.searchKey.keyword="",t.getNodesByParamFuzzy(!0),t.systemList=null,t.deviceList=null,t.signalList=null},t.exportHistoryData=function(){var e=t.signalList;if(null!==e&&0!==e.length){t.isExportHistoryDataLoading=!0;var a=t.getCurrentDevice();s.exportHistoryData({startTime:new Date(t.historyDataQuery.tStart).getTime(),endTime:new Date(t.historyDataQuery.tEnd).getTime(),deviceCode:t.historyDataQuery.deviceId,deviceType:a.typeCode},function(){t.isExportHistoryDataLoading=!1,t.exportHistoryData.have=!1})}},t.exportHistoryData.have=!0,t.exportSingleSignalListLeft=function(){var e=t.getCurrentSignal(),a=t.getCurrentDevice(),i=t.getCurrentSite();s.exportSingleSignalListLeft({startTime:new Date(t.historyDataQuery.tStart).getTime(),endTime:new Date(t.historyDataQuery.tEnd).getTime(),cntbId:e.cntbId,deviceCode:t.historyDataQuery.deviceId,pageSize:99999999,currentPage:1,tierName:i.tierName,siteName:i.siteName,deviceName:a.name,signalName:e.typeName,siteCode:i.siteCode},function(){}),t.exportSingleSignalListLeft.have=!1},t.exportSingleSignalListLeft.have=!0,t.exportSingleSignalListLeftPdf=function(){s.exportSingleSignalListLeftPdf({signalId:t.historyDataQuery.signalId,tStart:new Date(t.historyDataQuery.tStart).getTime(),tEnd:new Date(t.historyDataQuery.tEnd).getTime()},function(){}),t.exportSingleSignalListLeftPdf.have=!1},t.exportSingleSignalListLeftPdf.have=!0,t.exportSingleSignalListRight=function(){s.exportSingleSignalListRight({startTime:new Date(t.historyDataQuery.tStart).getTime(),endTime:new Date(t.historyDataQuery.tEnd).getTime(),cntbId:t.signalDetail.cntbId,deviceCode:t.historyDataQuery.deviceId},function(){}),t.exportSingleSignalListRight.have=!1},t.exportSingleSignalListRight.have=!0,t.exportSingleSignalListRightPdf=function(){s.exportSingleSignalListRightPdf({signalId:t.historyDataQuery.signalId,tStart:new Date(t.historyDataQuery.tStart).getTime(),tEnd:new Date(t.historyDataQuery.tEnd).getTime()},function(){}),t.exportSingleSignalListRightPdf.have=!1},t.exportSingleSignalListRightPdf.have=!0,function(){t.treeLoading=!0,n.getSiteMapTree({serverCode:"TOWER_SERVER_1.0.0"},function(e){t.treeLoading=!1,t.zTree=n.createZTree(e),n.initTree(t.zTree.zNodes,"areaTree","radioSiteTree",function(){g("areaTree")}),c.siteId&&n.checkNodeBySiteId("areaTree",c.siteId)})}(),c.signalId&&(t.historyDataQuery.siteCode=c.siteCode,t.historyDataQuery.siteName=c.siteName,t.historyDataQuery.deviceId=c.deviceCode,t.getDeviceList(function(){t.getSignalList(c.deviceCode,c.signalId,function(){l(c.signalId)})}))}]);