scloudApp.controller("reportSettingController",["$scope","$rootScope","reportService","treeService",function(e,t,i,s){function n(){var t=s.getCheckedTierCodes("areaTree"),i=s.getCheckedNodes("areaTree").filter(function(e){return e.end});e.addTemplate.curItem.tierCodes=t,1===t.length?e.addTemplate.curItem.tierString=s.getParentName(i[0],[]):t.length>0?e.addTemplate.curItem.tierString=i[0].name+" 等"+(i.length-1)+"个区域":e.addTemplate.curItem.tierString="",!e.$$phase&&e.$apply()}function a(){var t=s.getCheckedTierCodesAndSiteIds("siteTree",e.zTree.zNodes),i=s.getCheckedNodes("siteTree").filter(function(e){return!1!==e.end});e.addTemplate.curItem.codesAndSiteIds=t,1===i.length?e.addTemplate.curItem.tierString=i[0].name:i.length>0?e.addTemplate.curItem.tierString=i[0].name+" 等"+(i.length-1)+"个站点":e.addTemplate.curItem.tierString="",!e.$$phase&&e.$apply()}function o(){e.loading2=!0,i.getCustomReportList(e.paginationConf2,function(t){e.customReportList=t.list,e.isLoading2=!1,e.paginationConf2.totalItems=t.count},function(){e.isLoading2=!1})}function r(){e.isLoading=!0,i.getSubscribeList(t.user.id,e.paginationConf,function(t){e.subscribeList=t.list,e.paginationConf.totalItems=t.count,e.isLoading=!1})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.tabPage=t.util.tabPage.getInstance(["报表订阅","自定义报表"]),e.reportList=[{name:"站点停电统计表"},{name:"站点停电明细表"},{name:"市电停电断站情况统计表"},{name:"用电量统计报表"},{name:"FSU离线统计表"},{name:"告警分类统计表"},{name:"FSU运行统计表"},{name:"FSU离线明细表"}],e.filterNameList=["实时告警统计","历史告警统计","TOP告警统计"],e.statisticsDepthList=[{key:1,value:"一级"},{key:2,value:"二级"},{key:3,value:"三级"}],e.paginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.paginationConf2={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.$watch("paginationConf2.currentPage + paginationConf2.itemsPerPage",o),e.reportFilterMap=function(t,i){if(!t)return!1;var s=e.reportList.map(function(e){return e.name}),n=["站点类型","FSU厂家","FSU状态","统计深度","告警状态","告警等级"];return[[1,1,1,1,0,0],[1,1,1,0,0,0],[1,1,0,0,0,0],[1,1,1,0,0,0],[1,1,1,1,0,0],[1,1,1,1,1,1],[1,1,0,1,0,0],[1,1,1,0,0,0]][s.indexOf(t)][n.indexOf(i)]},e.checkSubscribeInvalid=function(){var t=!0;return!e.addTemplate.obj.subscribeInterval||(!e.addTemplate.obj.name||(e.addTemplate.obj.list&&e.addTemplate.obj.list.forEach(function(i){i.name&&i.tierString||(t=!1),e.reportFilterMap(i.name,"统计深度")&&!i.statisticsDepth&&(t=!1),e.reportFilterMap(i.name,"告警状态")&&!i.alarmState&&(t=!1)}),!t))},e.addTemplate={obj:{list:[{}]},toggleTree:function(t){if(t.name&&(this.showRadioTree="站点用电负荷统计表"!==t.name,e.toggleNavTree(),this.curItem=t,e.addTemplate.showToggleButton))if(this.showRadioTree)s.checkNodeByCodes("areaTree",this.curItem.tierCodes||[]);else{var i=$.extend([],this.curItem.codesAndSiteIds&&this.curItem.codesAndSiteIds.siteIds);s.checkNodeByCodes("siteTree",this.curItem.codesAndSiteIds&&this.curItem.codesAndSiteIds.codes||[]),s.checkNodeBySomething("siteTree",i||[],"id",!0)}},afterNavTreeClosed:function(t){e.addTemplate.showToggleButton=!t},remove:function(e){this.obj.list.splice(e,1)},add:function(){if(this.obj.list.length>=10)return void t.notify({type:"warning",text:"一个订阅模板不能订阅10张以上的报表"});this.obj.list.push({})},load:function(t){e.toggleNavTree(!0),this.obj=$.extend({},t),this.obj.list=t.content.map(function(e){return(e.siteIds||e.siteIds2)&&(e.codesAndSiteIds={codes:e.tierCodes||[],siteIds:e.siteIds||e.siteIds2||[]}),e}),this.status="modify"},execute:function(){var t=this.obj,s=t.list.map(function(e){return $.extend({},e)});t.content=t.list.map(function(e){return e.codesAndSiteIds&&(e.codesAndSiteIds.codes.length?(e.tierCodes=e.codesAndSiteIds.codes,e.siteIds2=e.codesAndSiteIds.siteIds,delete e.siteIds):(e.siteIds=e.codesAndSiteIds.siteIds,delete e.tierCodes,delete e.siteIds2),delete e.codesAndSiteIds),e}),delete t.list;var n="modify"===this.status?"modifySubscribe":"addSubscribe",a=this.status;delete this.status,i[n](t,function(){e.addTemplate.clear(),r(),this.obj={list:[{}]}},function(){e.addTemplate.status=a,e.addTemplate.obj.list=s})},clear:function(){this.obj={list:[{}]},delete this.status,e.toggleNavTree(!0)}},e.addDiyTemplate={status:"add",obj:{statisticsContent:"实时告警统计",filters:[],tableHeads:[]},leftList1:["站点层级","告警等级","告警名称","告警设备","确认状态","确认人","开始时间","恢复时间"],leftList2:["站点层级","FSU厂家","FSU名称","站点名称","站点类型","告警数量"],rightList1:["站点类型","FSU厂家","FSU状态","统计深度"],rightList2:["站点类型","FSU厂家","统计深度","告警状态","统计周期","TOP数量"],checkInvalid:function(){return!!e.reportList.some(function(e){return e.name===this.obj.name}.bind(this))||(!this.obj.name||!(this.obj.filters&&this.obj.filters.some(function(e){return e}))||!(this.obj.tableHeads&&this.obj.tableHeads.some(function(e){return e})))},load:function(e){this.obj=$.extend({},e),this.status="modify";var t="TOP告警统计"===this.obj.statisticsContent?2:1;this.obj.tableHeads=this["leftList"+t].map(function(e){return this.obj.tableHeads.indexOf(e)>-1}.bind(this)),this.obj.filters=this["rightList"+t].map(function(e){return this.obj.filters.indexOf(e)>-1}.bind(this))},execute:function(){var t="TOP告警统计"===this.obj.statisticsContent?2:1,s=this.obj.tableHeads,n=this.obj.filters;this.obj.tableHeads=this.obj.tableHeads.map(function(e,i){return this["leftList"+t][e?i:-1]}.bind(this)).filter(function(e){return e}),this.obj.filters=this.obj.filters.map(function(e,i){return this["rightList"+t][e?i:-1]}.bind(this)).filter(function(e){return e}),this.obj.type="告警报表";var a="modify"===this.status?"modifyCustomReportList":"addCustomReport";i[a](this.obj,function(){e.addDiyTemplate.clear(),o()},function(){e.addDiyTemplate.obj.tableHeads=s,e.addDiyTemplate.obj.filters=n})},clear:function(){this.obj={statisticsContent:"实时告警统计",filters:[],tableHeads:[]},this.status="add"}},e.deleteDiyTemplate={obj:{},toModal:function(e){$("#deleteDiyTemplateModal").modal("show"),this.obj=e},execute:function(){i.deleteCustomReport(this.obj.id,function(){e.deleteDiyTemplate.clear(),o()})},clear:function(){$("#deleteDiyTemplateModal").modal("hide")}},e.deleteSubscribe={obj:{},toModal:function(t){this.obj=t,e.toggleNavTree(!0),$("#deleteSubscribeModal").modal("show")},execute:function(){i.deleteSubscribe(this.obj.id,function(){e.deleteSubscribe.clear(),r(),e.addTemplate.clear()})},clear:function(){this.obj={},$("#deleteSubscribeModal").modal("hide")}},e.target=t.util.getToggleParam(null,[".nav-tree"],{left:"0"},{left:"-232px"}),r(),function(){e.treeLoading=!0,s.getTierTree(null,function(t){e.treeLoading=!1,e.zTree=s.createZTree(t),s.initTree(e.zTree.zNodes,"areaTree","checkboxTierTree",n)}),s.getSiteMapTree({},function(t){e.siteTree=s.createZTree(t),s.initTree(e.siteTree.zNodes,"siteTree","checkboxSiteTree",a)})}()}]);