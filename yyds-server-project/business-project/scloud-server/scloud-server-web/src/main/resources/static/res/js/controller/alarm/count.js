scloudApp.controller("alarmCountController",["$scope","$rootScope","treeService","alarmService","reportService","$stateParams","$state",function(e,t,r,a,i,n,u){u&&(u=window.$state),n&&(n=window.$stateParams),e.tabPage=t.util.tabPage.getInstance(["实时告警","告警分布","告警频发站"]),e.tabPage.currentIndex=0,e.$stateParams=n,e.realtimeQuery={},e.tierDistQuery={},e.frequentQuery={},e.realtimePagiConf={currentPage:1,itemsPerPage:15,pagesLength:9},e.isRealtimeLoading=!1,e.resetRealtimeQuery=function(){e.realtimeQuery={tEnd:(new Date).Format("yyyy/MM/dd"),tStart:new Date((new Date).getTime()-Date.oneWeek).Format("yyyy/MM/dd")}},e.resetRealtimeQuery(),e.realtimeQueryChange=function(t){var r=new Date(e.realtimeQuery.tEnd),a=new Date(e.realtimeQuery.tStart);t&&r.getTime()?e.realtimeQuery.tStart=new Date(r.getTime()-Date.oneWeek).Format("yyyy/MM/dd"):!t&&a.getTime()&&(e.realtimeQuery.tEnd=new Date(a.getTime()+Date.oneWeek).Format("yyyy/MM/dd"))},e.getRealtimeAlarmChartData=function(){var t={startTime:e.realtimeQuery.tStart?new Date(e.realtimeQuery.tStart).getTime():null,endTime:e.realtimeQuery.tEnd?new Date(e.realtimeQuery.tEnd).getTime():null};e.realtimeQueryLevel=n.realtimeParams?n.realtimeParams+"":null,e.getRealtimeALarmList(e.realtimeQueryLevel),n.realtimeParams=null,i.getAlarmCount(n.tier,t,function(t){e.totalRealtimeAlarmCount=t.level1+t.level2+t.level3+t.level4;try{chart.alarmCountPie({id:"realTimePie",name:"",title:" ",data:[{value:t.level1,name:"一级告警   "},{value:t.level2,name:"二级告警   "},{value:t.level3,name:"三级告警   "},{value:t.level4,name:"四级告警   "}]}).on("click",function(t){t.name.indexOf("一")>-1&&(e.realtimeQueryLevel="1"),t.name.indexOf("二")>-1&&(e.realtimeQueryLevel="2"),t.name.indexOf("三")>-1&&(e.realtimeQueryLevel="3"),t.name.indexOf("四")>-1&&(e.realtimeQueryLevel="4"),e.getRealtimeALarmList(e.realtimeQueryLevel)})}catch(e){}})},e._firstGetRealtimeALarmList=!0,e.$watch("realtimePagiConf.currentPage + realtimePagiConf.itemsPerPage",function(){e.getRealtimeALarmList(e.realtimeQueryLevel)}),e.getRealtimeALarmList=function(t){if(e._firstGetRealtimeALarmList)return void(e._firstGetRealtimeALarmList=!1);e.isRealtimeLoading=!0;var r={tierCode:n.tier,startTime:e.realtimeQuery.tStart?new Date(e.realtimeQuery.tStart).getTime():null,endTime:e.realtimeQuery.tEnd?new Date(e.realtimeQuery.tEnd).getTime():null,level:t,currentPage:e.realtimePagiConf.currentPage,pageSize:e.realtimePagiConf.itemsPerPage};a.getCountRealtimeAlarmList(r,function(t){$(".page1 .table-box").scrollTop(0),e.realtimeAlarmList=t.list,e.realtimePagiConf.totalItems=t.count,e.isRealtimeLoading=!1})},e.exportRealtimeAlarm=function(){e.exportRealtimeAlarm.have=!1,a.exportAlarmCountTab1({tierCode:n.tier,startTime:e.realtimeQuery.tStart?new Date(e.realtimeQuery.tStart).getTime():null,endTime:e.realtimeQuery.tEnd?new Date(e.realtimeQuery.tEnd).getTime():null,level:e.realtimeQueryLevel||void 0},function(){})},e.exportRealtimeAlarm.have=!0,e.resetTierDistQuery=function(){e.tierDistQuery={}},e.getTierDistAll=function(){e.tierDistQuery.tEnd||e.tierDistQuery.tStart||(e.tierDistQuery={tEnd:(new Date).Format("yyyy/MM/dd hh:mm:ss"),tStart:new Date((new Date).getTime()-Date.oneWeek).Format("yyyy/MM/dd hh:mm:ss")}),e.getTierDist(1)},e.getTierDist=function(t,r,i){function l(r){var a=new Array(t>1?5:10).join(".").split(".").map(function(e,t){return r.tierList[t]?r.tierList[t].key:"-"}),l=new Array(t>1?5:10).join(".").split(".").map(function(e,t){return r.tierList[t]?r.tierList[t].value:"-"});try{e["distributeChart"+t]=chart.alarmTierTop5({id:"distribute-chart"+t,xAxis:{data:a},series:{data:l,pinData:l},title:1===t?"全国":i,callback:function(r){if(e.tierChartClickable){var a=e["distributeChart"+t].data.tierList.filter(function(e){return e.key===r})[0],i=e["distributeChart"+t].data.tierList.indexOf(a),n=e["distributeChart"+t].getOption();n.series[1].data=n.series[0].data=n.series[0].data.map(function(e){return e.value||e}),n.series[1].data[i]=n.series[0].data[i]={value:n.series[0].data[i],itemStyle:s},e["distributeChart"+t].setOption(n),t>2||(e.getTierDist(t+1,a.tierlist[0].substr(0,2*t),r),e.tierChartClickable=!1)}},callback2:function(t){e.leaved||u.go("alarm/list",{commonParam:{tierName:i?i+"-"+t:t,queryTEnd:e.tierDistQuery.tEnd,queryTStart:e.tierDistQuery.tStart}}),e.leaved=!0}}),e["distributeChart"+t].data=r,n.distributeCode&&(e["distributeChart"+t].setOption(n.distributeCode[t-1].option),e["distributeChart"+t].data=n.distributeCode[t-1].data),t<3?e.getTierDist(t+1,r.tierList[0]&&r.tierList[0].tierlist[0].substr(0,2*t),r.tierList[0]&&r.tierList[0].key):(e.tierChartClickable=!0,delete n.distributeCode)}catch(e){}}var m={tierMark:(n.tier||"").substr(0,2*t),localTierCode:r,tStart:e.tierDistQuery.tStart?new Date(e.tierDistQuery.tStart).getTime():null,tEnd:e.tierDistQuery.tEnd?new Date(e.tierDistQuery.tEnd).getTime():null};m.tierMark.length<2*t&&delete m.tierMark;var s={normal:{color:{type:"linear",x:0,y:0,x2:1,y2:0,colorStops:[{offset:0,color:"#FF6D6D"},{offset:.49,color:"#FF6D6D"},{offset:.5,color:"#FF4A69"},{offset:1,color:"#FF4A69"}],globalCoord:!1},opacity:.8},emphasis:{opacity:1}};t>1&&!r?l({tierList:[]}):a.getAlarmTierList(m,l)},e.resetFrequentQuery=function(){e.frequentQuery={tEnd:(new Date).Format("yyyy/MM/dd"),tStart:new Date((new Date).getTime()-Date.oneWeek).Format("yyyy/MM/dd")}},e.resetFrequentQuery(),e.frequentQueryChange=function(t){var r=new Date(e.frequentQuery.tEnd),a=new Date(e.frequentQuery.tStart);t&&r.getTime()?e.frequentQuery.tStart=new Date(r.getTime()-Date.oneWeek).Format("yyyy/MM/dd"):!t&&a.getTime()&&(e.frequentQuery.tEnd=new Date(a.getTime()+Date.oneWeek).Format("yyyy/MM/dd"))},e.getFrequentList=function(){var t={startTime:e.frequentQuery.tStart?new Date(e.frequentQuery.tStart).getTime():null,endTime:e.frequentQuery.tEnd?new Date(e.frequentQuery.tEnd).getTime()+Date.oneDay-1:null,tierCode:n.tier};e.frequentDateList=new Array(7).join(".").split(".").map(function(e,r){return new Date(new Date(t.endTime).getTime()-r*Date.oneDay).Format("yyyy/MM/dd")}).reverse(),i.getMostAlarmSiteCount(t,function(t){e.frequentSiteList=new Array(10).join(".").split(".").map(function(e,r){return t[r]?{name:t[r].site.name,value:t[r].count}:{name:"-",value:0}});var r=t.map(function(e){return e.site.strId});e.frequentSites=t;var a={startTime:e.frequentQuery.tStart?new Date(e.frequentQuery.tStart).getTime():null,endTime:e.frequentQuery.tEnd?new Date(e.frequentQuery.tEnd).getTime()+Date.oneDay-1:null,siteIds:t.map(function(e){return e.site.strId})};i.alarmSiteHistory(a,function(t){t.sort(function(e,t){return r.indexOf(e.site.strId)-r.indexOf(t.site.strId)}),e.frequentAlarmList=t;try{chart.alarmSiteBarCount({id:"frequent-chart",xAxis:{data:t[0]?t[0].count.map(function(e){return e.time}).slice(0,7):[]},data:new Array(10).join(".").split(".").map(function(e,r){return t[r]?t[r].count.map(function(e){return e.count}).slice(0,7):[0,0,0,0,0,0,0]})})}catch(e){}$(".scroll").scrollTop(0)})})},e.exportFrequentList=function(){e.exportFrequentList.have=!1,a.exportAlarmCountTab2({startTime:e.frequentQuery.tStart?new Date(e.frequentQuery.tStart).getTime():null,endTime:e.frequentQuery.tEnd?new Date(e.frequentQuery.tEnd).getTime()+Date.oneDay-1:null,siteIds:(e.frequentSites||[]).map(function(e){return e.site.strId}),tierCode:n.tier},function(){})},e.exportFrequentList.have=!0,e.$applyParam=function(t){e.tabPage.currentIndex=t.tabPage?t.tabPage.currentIndex:0,e.tierDistQuery={tStart:t.queryTStart?new Date(t.queryTStart).Format("yyyy/MM/dd hh:mm:ss"):new Date((new Date).getTime()-Date.oneWeek).Format("yyyy/MM/dd hh:mm:ss"),tEnd:t.queryTEnd?new Date(t.queryTEnd).Format("yyyy/MM/dd hh:mm:ss"):new Date((new Date).getTime()).Format("yyyy/MM/dd hh:mm:ss")},e.realtimeQuery=t.realtimeQuery||e.realtimeQuery,e.tierDistQuery=t.tierDistQuery||e.tierDistQuery,e.frequentQuery=t.frequentQuery||e.frequentQuery,e.realtimePagiConf=t.realtimePagiConf||e.realtimePagiConf,n=t},e.$getParam=function(){return{tabPage:e.tabPage,distributeCode:e.distributeChart1&&e.distributeChart2&&e.distributeChart3&&[{option:e.distributeChart1.getOption(),data:e.distributeChart1.data},{option:e.distributeChart2.getOption(),data:e.distributeChart2.data},{option:e.distributeChart3.getOption(),data:e.distributeChart3.data}],realtimeParams:e.realtimeQueryLevel,realtimeQuery:e.realtimeQuery,tierDistQuery:e.tierDistQuery,frequentQuery:e.frequentQuery,realtimePagiConf:e.realtimePagiConf}},e.getRealtimeAlarmChartData(),e.getTierDistAll(),e.getFrequentList()}]);