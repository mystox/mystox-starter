scloudApp.controller("alarmLinkController",["$scope","$rootScope","treeService","deviceService","alarmLinkService",function(e,i,t,n,s){function o(i){return function(t,n,o){n.nextTier&&n.nextTier.length>0||s.getFsuBySiteAndLink({id:e.configSite.obj.id,siteId:n.id},function(t){var s=e[i].addNodes(n,t);o&&o(s)})}}function a(i,n,s){e.configSite.list=t.getCheckedNodes("siteTree"),e.$apply()}function c(){var i=$.extend({},e.platformQuery);i.deviceType&&(i.deviceType=i.deviceType.code),i.deviceChildType&&(i.deviceChildType=i.deviceChildType.code),i.updateBeginTime&&(i.updateBeginTime=new Date(i.updateBeginTime).getTime()),i.updateEndTime&&(i.updateEndTime=new Date(i.updateEndTime).getTime()),e.isPlatformLoading=!0,s.getLinkList(i,e.platformPaginationConf,function(i){e.platformLinkList=i.list,e.isPlatformLoading=!1,e.platformPaginationConf.totalItems=i.count})}function d(){if(!e.fsuQuery.fsu&&e.notFirstTime)return void i.notify({type:"warning",text:"请至少选择一台FSU"});if(!e.notFirstTime)return void(e.notFirstTime=!0);var t=$.extend({},e.fsuQuery);t.deviceType&&(t.deviceType=t.deviceType.code),t.deviceChildType&&(t.deviceChildType=t.deviceChildType.code),t.updateBeginTime&&(t.updateBeginTime=new Date(t.updateBeginTime).getTime()),t.updateEndTime&&(t.updateEndTime=new Date(t.updateEndTime).getTime()),t.fsuId=t.fsu&&t.fsu.id,delete t.fsu,e.isFsuLoading=!0,s.getLinkList(t,e.fsuPaginationConf,function(i){e.fsuLinkList=i.list,e.fsuPaginationConf.totalItems=i.count,e.isFsuLoading=!1})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.tabPage=i.util.tabPage.getInstance(["平台联动配置","FSU联动配置"]),e.platformQuery={orderType:1},e.fsuQuery={},e.deviceTypeList={},e.platformPaginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.fsuPaginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.linkType=[{name:"告警",value:"1"},{name:"信号",value:"2"}],e.compareLogicList=[{name:"小于",value:1},{name:"等于",value:2},{name:"大于",value:3},{name:"小于或等于",value:4},{name:"大于或等于",value:5}],e.useTypeList=[{name:"与",value:1},{name:"或",value:2}],e.doList={data:[{id:"1",text:"DO1"},{id:"2",text:"DO2"},{id:"3",text:"DO3"},{id:"4",text:"DO4"}]},e.enabledList=[{name:"启用",value:"1"},{name:"禁用",value:"0"}],e.cameraSignal=[{code:"001",typeName:"视频录制"},{code:"002",typeName:"图像抓拍"},{code:"003",typeName:"云台联动"},{code:"004",typeName:"云台巡航"}],e.$watch("platformPaginationConf.currentPage + platformPaginationConf.itemsPerPage",c),e.$watch("fsuPaginationConf.currentPage + fsuPaginationConf.itemsPerPage",d);var u=o("treeObj"),r=o("fsuSelectTreeObj");e.getDeviceListByTypeCode=function(i,t,s){if(i.deviceList)return void(t&&t());n.getDeviceByTypeCode(i.code,function(n){var s=n.map(function(e){return{device:{name:e}}}),o=e.deviceListTop1.filter(function(e){return e.code===i.code})[0],a=e.deviceListTop2.filter(function(e){return e.code===i.code})[0],c=e.deviceListBottom.filter(function(e){return e.code===i.code})[0],d=e.deviceTypeList.filter(function(e){return e.code===i.code})[0];o&&(o.deviceList=s),a&&(a.deviceList=s),c&&(c.deviceList=s),d&&(d.deviceList=s),t&&t()}),s&&(i.deviceList=s)},e.addPlatformLink={form:{},obj:{},getDeviceTypeList:function(i){switch(i){case 0:return e.deviceListTop1;case 1:return e.deviceListTop2;case 2:return e.deviceListBottom}},getSelectSignal:function(){return e.addPlatformLink.obj.signalNameList?e.addPlatformLink.obj.signalNameList.filter(function(e){return e}).map(function(e){return e.typeName}).join(" & "):""},addSignal:function(){this.obj.signalList.push((new Date).getTime()+""),this.obj.deviceTypeList.push(null),this.obj.deviceChildTypeList.push(null),this.obj.deviceNameList.push(null),this.obj.signalNameList.push(null),this.obj.compareLogicList&&this.obj.compareLogicList.push(3),this.obj.compareLogicList&&this.obj.valueList.push(null),this.obj.useTypeList.push("1")},removeSignal:function(e){this.obj.signalList.splice(e,1),this.obj.deviceTypeList.splice(e,1),this.obj.deviceChildTypeList.splice(e,1),this.obj.deviceNameList.splice(e,1),this.obj.signalNameList.splice(e,1),this.obj.compareLogicList&&this.obj.compareLogicList.splice(e,1),this.obj.valueList.splice(e,1),this.obj.useTypeList.splice(e,1)},addFeedback:function(){this.obj.linkEntityList.push({})},removeFeedback:function(e){this.obj.linkEntityList.splice(e,1)},getLinkName:function(e){s.getNextAlarmLink({type:e},function(e){this.obj.id=e.id,this.obj.name=e.name}.bind(this))},checkFormInvalid:function(){if(this.show)return!(this.obj.doList&&0!==this.obj.doList.length||!this.obj.doValue)||(!(!this.obj.doList||!this.obj.doList.length||this.obj.doValue&&i.REGEX.one2tenThousand.test(this.obj.doValue))||(!this.obj.signalList.every(function(e,t){return this.obj.deviceTypeList[t]&&this.obj.deviceChildTypeList[t]&&this.obj.deviceNameList[t]&&("告警"===this.title?this.obj.signalNameList[t]:this.obj.compareLogicList[t]&&i.REGEX.signalLinkCompareValue.test(this.obj.valueList[t]))&&this.obj.useTypeList[t]}.bind(this))||(!this.obj.linkEntityList.every(function(e){return e.deviceType&&e.deviceChildType&&e.deviceName&&e.signalName&&("100"===e.deviceType.code?"图像抓拍"===e.signalName.typeName?+e.value>0:"云台联动"===e.signalName.typeName?/^[1-9]\d{0,1}$/.test(e.value):"视频录制"===e.signalName.typeName?i.REGEX.one2tenThousand.test(e.value):/^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d{0,1})$/.test(e.value):i.REGEX.one2tenThousand.test(e.value))})||void 0)))},getNumberValidClass:function(e,t){if(t){switch(e){case"normal":return i.REGEX.one2tenThousand.test(t)?"":"error";case"link":return i.REGEX.signalLinkCompareValue.test(t)?"":"error";case"云台联动":return/^[1-9]\d{0,1}$/.test(t)?"":"error";case"云台巡航":return/^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d{0,1})$/.test(t)?"":"error"}return i.REGEX.one2tenThousand.test(t)?"":"error"}},reset:function(){this.obj.signalList=[(new Date).getTime()+""],this.obj.linkEntityList=[{}],this.obj.deviceTypeList=[null],this.obj.deviceChildTypeList=[null],this.obj.deviceNameList=[null],this.obj.signalNameList=[null],this.obj.compareLogicList=[3],this.obj.valueList=[null],this.obj.useTypeList=["1"]},toModal:function(i,t){if(i){this.status=t||"modify",this.title=["告警","信号"][i.type-1],this.obj=$.extend({},i);i.deviceTypeList.concat(i.linkEntityList.map(function(e){return e.deviceType})).unique().forEach(function(t){var n=e.deviceTypeList.filter(function(e){return e.code===t})[0],s=[];n.deviceList||(i.deviceTypeList.forEach(function(e,n){e===t&&s.push(i.deviceNameList[n])}),i.linkEntityList.forEach(function(e){e.deviceType===t&&s.push(e.deviceName)}),s=s.unique().map(function(e){return{device:{name:e}}})),e.getDeviceListByTypeCode(n,null,s)}),this.obj.signalList=i.deviceTypeList.map(function(e,i){return i}),this.obj.deviceTypeList=i.deviceTypeList.map(function(e){return this.getDeviceTypeList(i.type-1).filter(function(i){return i.code===e})[0]}.bind(this)),this.obj.deviceChildTypeList=this.obj.deviceTypeList.map(function(e){return e}),this.obj.deviceNameList=i.deviceNameList,this.obj.useTypeList=i.useTypeList,this.obj.updateTime=i.updateTime,this.obj.id=i.id,this.obj.signalNameList=i.signalNameList.map(function(e,i){return this.obj.deviceTypeList[i].signalTypeList.filter(function(i){return i.code==e})[0]}.bind(this)),this.obj.linkEntityList=i.linkEntityList.map(function(i){var t=e.deviceListBottom.filter(function(e){return e.code===i.deviceType})[0];return{deviceType:t,deviceChildType:t,deviceName:i.deviceName,signalName:("100"===i.deviceType?e.cameraSignal:t.signalTypeList).filter(function(e){return e.code==i.signalName})[0],value:i.value}}),this.obj.doList=i.doList.map(function(e){return{id:e,text:"DO"+e}}),this.obj.doValue=i.doValue,this.obj.doValue||delete this.obj.doValue}else this.getLinkName("1"),this.status="add",this.title="告警",this.obj.updateTime=(new Date).getTime(),this.reset();this.show=!0,$("#addPlatformLinkModal").modal("show")},execute:function(){this.obj.deviceTypeList=this.obj.deviceTypeList.map(function(e){return e.code}),this.obj.deviceChildTypeList=this.obj.deviceChildTypeList.map(function(e){return e.code}),this.obj.linkEntityList.forEach(function(e){e.deviceType=e.deviceType.code,e.deviceChildType=e.deviceChildType.code,e.signalName=e.signalName.code}),this.obj.type="告警"===this.title?"1":"2",this.obj.creator||(this.obj.creator={strId:i.user.id,name:i.user.name});var e=this.obj.__get("name","id","describe","type","creator","deviceTypeList","deviceChildTypeList","deviceNameList","useTypeList","doValue","linkEntityList","updateTime","enabled","timeQuantumList","dayList","fsuNameList","fsuIdList","deleted");e.doList=this.obj.doList?this.obj.doList.map(function(e){return e.id}):[],e.signalNameList=this.obj.signalNameList.map(function(e){return e.code}),"信号"===this.title&&(e.compareLogicList=this.obj.compareLogicList,e.valueList=this.obj.valueList),s[this.status+"Link"](e,function(){c()}),this.clear()},clear:function(){this.show=!1,this.obj={},this.form.$setPristine(),$("#addPlatformLinkModal").modal("hide")}},e.deletePlatformLink={obj:{},toModal:function(e){this.obj=e,$("#deletePlatformLinkModal").modal("show")},execute:function(){s.deleteLink({id:this.obj.id},function(){c(),e.deletePlatformLink.clear()})},clear:function(){$("#deletePlatformLinkModal").modal("hide")}},e.setTimeRange={obj:{},form:{},fn:{rowClick:function(i,t){e.setTimeRange.obj.isSelected[t]=i},selectAllWeek:function(i){e.setTimeRange.obj._dayList=new Array(8).join(".").split(".").map(function(){return i})},selectDay:function(i,t){e.setTimeRange.obj._dayList[t]=i},checkInvalid:function(){var i=e.setTimeRange;return!i.obj.isSelected||i.obj.isSelected.every(function(e){return!e})||i.obj._dayList.every(function(e){return!e})},timeChange:function(t,n){var s=e.setTimeRange.obj.timeRange,o=s[t][n];if(!o)return void(e.setTimeRange.form[n+t]={});delete e.setTimeRange.form[n+t];var a=i.util.time2Int(o);s.forEach(function(e,o){var c=i.util.time2Int(e.beginTime),d=i.util.time2Int(e.endTime);o!==t&&a>c&&a<d&&("beginTime"===n?(s[t][n]=e.endTime,i.util.time2Int(s[t].endTime)<d&&(s[t].endTime=e.endTime)):(s[t][n]=e.beginTime,i.util.time2Int(s[t].beginTime)>c&&(s[t].beginTime=e.beginTime)))}.bind(this)),i.util.time2Int(s[t].beginTime)>i.util.time2Int(s[t].endTime)&&("beginTime"===n?s[t].endTime=s[t].beginTime:s[t].beginTime=s[t].endTime)}},toModal:function(i,t){this.obj=$.extend({},i),this.status=t,this.obj.timeQuantumList=i.timeQuantumList?i.timeQuantumList.map(function(e){return $.extend({},e)}):[],this.obj.timeRange=[].concat(this.obj.timeQuantumList,new Array(4).join(".").split(".").map(function(){return{beginTime:"00:00:00",endTime:"00:00:00"}})).slice(0,4),this.obj._dayList=[],this.obj.isSelected=new Array(4).join(".").split(".").map(function(e,t){return i.timeQuantumList&&t<i.timeQuantumList.length}),i.dayList&&i.dayList.forEach(function(i){e.setTimeRange.obj._dayList[i]=!0}),this.obj.isSelectAllWeek=i.dayList&&7===i.dayList.length,$("#setTimeRangeModal").modal("show")},execute:function(){var i=[],t=[];this.obj.isSelected.forEach(function(e,t){e&&i.push({beginTime:this.obj.timeRange[t].beginTime,endTime:this.obj.timeRange[t].endTime})}.bind(this)),this.obj._dayList.forEach(function(e,i){e&&i&&t.push(i)}),s.updateLinkTimes({id:this.obj.id,timeQuantumList:i,dayList:t},function(){c(),e.setTimeRange.clear()})},clear:function(){this.obj={},$("#setTimeRangeModal").modal("hide")}},e.configSite={obj:{},list:[],remove:function(i){e.treeObj.checkNode(i,!1),e.configSite.list=t.getCheckedNodes("siteTree")},checkInvalid:function(){return this.list.some(function(e){return"1"!==e.matchAlarmLink})||0===this.list.length},backShow:function(){function i(){e.configSite.list=s=s.filter(function(i){return e.configSite.obj.fsuIdList.indexOf(i.id)>-1}),s.forEach(function(i){e.treeObj.checkNode(i)})}if(this.obj.siteIdList&&0!==this.obj.siteIdList.length){var t=e.treeObj.getNodesByFilter(function(e){return e.end&&this.obj.siteIdList.indexOf(e.id)>-1}.bind(this)),n=0,s=[];t.forEach(function(e){u(null,e,function(e){s=s.concat(e),++n===t.length&&i()})})}},toModal:function(e){this.obj=e,$("#configSiteModal").modal("show"),this.backShow()},execute:function(){s.updateLinkSites({id:this.obj.id,fsuIdList:this.list.map(function(e){return e.id}),fsuNameList:this.list.map(function(e){return e.name}),siteIdList:this.list.map(function(e){return e.siteId})},function(){e.configSite.clear(),e.query()})},clear:function(){this.list=[],t.initTree(e.zTree.zNodes,"siteTree","asyncFsuTree",u,a),e.treeObj=$.fn.zTree.getZTreeObj("siteTree"),$("#configSiteModal").modal("hide")}},e.fsuSelect={toModal:function(){$("#fsuSelectModal").modal("show")},execute:function(){var i=t.getCheckedNode("fsuSelectTree");e.fsuQuery.fsu=i,this.clear()},clear:function(){$("#fsuSelectModal").modal("hide")}},e.query=function(i,t){i&&(e.platformQuery.orderType=1&t),c()},e.reset=function(){e.platformQuery={}},e.fsuQueryFn=function(i,t){i&&(e.fsuQuery.orderType=1&t),d()},e.fsuReset=function(){e.fsuQuery={}},e.toggleLinkEnabled=function(e){s.toggleLinkEnabled({id:e.id,enabled:"1"===e.enabled?"0":"1"},function(){c()})},function(){e.treeLoading=!0,t.getSiteMapTree({},function(i){e.treeLoading=!1,e.zTree=t.createZTree($.extend({},i)),e.zTree.zNodes.subType="checkbox",e.fsuSelectTree=t.createZTree(i),e.fsuSelectTree.zNodes.subType="radio",t.initTree(e.zTree.zNodes,"siteTree","asyncFsuTree",u,a),t.initTree(e.fsuSelectTree.zNodes,"fsuSelectTree","asyncFsuTree",r,function(){}),e.treeObj=$.fn.zTree.getZTreeObj("siteTree"),e.fsuSelectTreeObj=$.fn.zTree.getZTreeObj("fsuSelectTree")})}(),function(){s.getDeviceListTop("1",function(i){e.deviceListTop1=i,i.forEach(function(e){e.signalTypeList=e.signalTypeList.filter(function(e){return"0"===e.code[0]})})}),s.getDeviceListTop("2",function(i){e.deviceListTop2=i,i.forEach(function(e){e.signalTypeList=e.signalTypeList.filter(function(e){return"1"===e.code[0]})})}),s.getDeviceListBottom("1",function(i){e.deviceListBottom=i,i.forEach(function(e){e.signalTypeList=e.signalTypeList.filter(function(e){return"2"===e.code[0]})})}),n.getDeviceTypeList(null,function(i){e.deviceTypeList=i})}()}]);