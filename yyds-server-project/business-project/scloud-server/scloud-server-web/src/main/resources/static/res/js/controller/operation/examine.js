scloudApp.controller("operationExamineController",["$scope","$rootScope","userService","verifyCodeService","fileUploadService","workService","treeService",function(e,i,a,t,n,o,r){function m(){var i,a=r.getCheckedNodes("addExamineTaskTree").filter(function(e){return e.end});i=1===a.length?a[0].name:a.length>1?a[0].name+" 等"+(a.length-1)+"个站点":"",e.addExamineTask.obj.siteName=i,e.addExamineTask.obj.siteCodeList=a.map(function(e){return e.code}),e.addExamineTask.obj.siteNameList=a.map(function(e){return e.name}),e.$$phase||e.$apply()}function s(){var i,a=r.getCheckedNodes("siteExamineTree").filter(function(e){return e.end});i=1===a.length?r.getParentName(a[0],[]):a.length>1?a[0].name+" 等"+(a.length-1)+"个区域":"",e.siteExamineQuery.tierString=i,e.siteExamineQuery.tierCodes=r.getCheckedTierCodes("siteExamineTree")}function l(){var i=e.examineQuery.__get("code","siteName","examStatus","examType","examBeginTime","examEndTime");i.examBeginTime&&(i.examBeginTime=new Date(i.examBeginTime).getTime()),i.examEndTime&&(i.examEndTime=new Date(i.examEndTime).getTime()),e.examineIsLoading=!0,o.getExamineList(e.examinePaginationConf,i,function(i){e.examineIsLoading=!1,e.examineList=i.list,e.examinePaginationConf.totalItems=i.count})}function d(){var i=e.repairExamineQuery.__get("examineCode","siteName","maintainerName","approStatus","handleStatus","troubleLevel","needService","beginReportTime","endReportTime");i.beginReportTime&&(i.beginReportTime=new Date(i.beginReportTime).getTime()),i.endReportTime&&(i.endReportTime=new Date(i.endReportTime).getTime()),e.repairExamineIsLoading=!0,o.getRepairsList(e.repairExaminePaginationConf,i,function(i){e.repairExamineIsLoading=!1,e.repairExamineList=i.list,e.repairExaminePaginationConf.totalItems=i.count})}function x(){var i=e.siteExamineQuery.__get("siteName","siteCode","maintainerName","examStatus","examType","realBeginTime","realEndTime","tierCodes");i.realBeginTime&&(i.realBeginTime=new Date(i.realBeginTime).getTime()),i.realEndTime&&(i.realEndTime=new Date(i.realEndTime).getTime()),e.siteExamineIsLoading=!0,o.getSiteExamineList(e.siteExaminePaginationConf,i,function(i){e.siteExamineIsLoading=!1,e.siteExamineList=i.list,e.siteExaminePaginationConf.totalItems=i.count})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.curExamine={},e.showExamineDetail=!1,e.tabPage=i.util.tabPage.getInstance(["巡检工单列表","报修列表","巡检站点明细表"]),e.examineStatusList=["未开始","巡检中","已完成"],e.examineTypeList=["应急巡检","月度巡检","季度巡检","半年度巡检"],e.approvalTypeList=["未审批","审批中","待处理","已处理","无需审批"],e.repairStatusList=["未处理","已处理","待通过"],e.needLargeRepairdList=["需要","无需"],e.malfunctionLevelList=["一般故障","严重故障","重大故障"],e.regularExamineTypeList=["月度巡检","季度巡检","半年度巡检"],e.$watch("tabPage.currentIndex",function(e,i){if(i!==e)switch(e){case 0:l();break;case 1:d();break;case 2:x()}}),e.examineIsLoading=!1,e.examinePaginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.examineQuery={},e.repairExamineIsLoading=!1,e.repairExaminePaginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.repairExamineQuery={},e.siteExamineIsLoading=!1,e.siteExaminePaginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.siteExamineQuery={},e.siteExamineExamineIsLoading=!1,e.siteExamineExaminePaginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.siteExaminerepairsIsLoading=!1,e.siteExaminerepairsPaginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.$watch("siteExaminerepairsPaginationConf.currentPage + siteExaminerepairsPaginationConf.itemsPerPage",function(){e.curExamine.id&&e.getSiteExamineDetail(e.curExamine,"repairs")}),e.$watch("siteExamineExaminePaginationConf.currentPage + siteExamineExaminePaginationConf.itemsPerPage",function(){e.curExamine.id&&e.getSiteExamineDetail(e.curExamine,"examine")}),e.$watch("repairExaminePaginationConf.currentPage + repairExaminePaginationConf.itemsPerPage",d),e.$watch("examinePaginationConf.currentPage + examinePaginationConf.itemsPerPage",l),e.addExamineTaskGetNodesByParamFuzzy=function(i,a,t){e.addExamineTaskTree.getNodesByParamFuzzy(i,a,t,m)},e.getNodesByParamFuzzy=function(i,a,t){e.siteExamineTree.getNodesByParamFuzzy(i,a,t,s)},e.doExamineQuery=function(){l()},e.clearExamineQuery=function(){e.examineQuery={}},e.exportExaminList=function(){var i=e.examineQuery.__get("code","siteName","examStatus","examType");o.exportExaminList(i)},e.getExamineDetail=function(i){e.curExamine=i,e.showExamineDetail=!0,o.getExamineDetail(e.curExamine.id,function(i){e.curExamine.recordList=i.examRecordList})},e.examineToRepairs=function(i){e.lastExamine=e.curExamine,e.curExamine={},e.examineToRepairsFlag=!0,o.getRepairsExamineDetail(i,function(i){e.curExamine=i.repairsList[0],e.curExamine.recordList=i.repairsRecordList})},e.doRepairExamineQuery=function(){d()},e.clearRepairExamineQuery=function(){e.repairExamineQuery={}},e.exportRepairExamineList=function(){var i=e.repairExamineQuery.__get("examineCode","siteName","maintainerName","approStatus","handleStatus","troubleLevel","needService");o.exportRepairExamineList(i)},e.getRepairExamineDetail=function(i,a){e.curExamine=i,e.showExamineDetail=!0,e.showExamineDetailApproval=a,o.getRepairsExamineDetail(e.curExamine.id,function(i){e.curExamine=i.repairsList[0],e.curExamine.recordList=i.repairsRecordList})},e.doSiteExamineQuery=function(){x()},e.clearSiteExamineQuery=function(){e.siteExamineQuery={},r.checkedAllNodes("siteExamineTree",!1)},e.exportSiteExamineList=function(){var i=e.siteExamineQuery.__get("siteName","siteCode","maintainerName","examStatus","examType","tierCodes");o.exportSiteExamineList(i)},e.getSiteExamineDetail=function(i,a){e.curExamine=i,e.showExamineDetail=!0,e.siteExamineDetailType=a,"repairs"===a?(e.siteExaminerepairsIsLoading=!0,o.getSiteExamineRepairsList(e.curExamine.id,e.siteExaminerepairsPaginationConf,function(i){e.curExamine.recordList=i.repairsList,e.siteExaminerepairsPaginationConf.totalItems=i.repairsCount,e.siteExaminerepairsIsLoading=!1})):(e.siteExamineExamineIsLoading=!0,o.getSiteExamineExamineList(e.curExamine.id,e.siteExamineExaminePaginationConf,function(i){e.curExamine.recordList=i.examineList,e.siteExamineExaminePaginationConf.totalItems=i.examCount,e.siteExamineExamineIsLoading=!1}))},e.addExamineTask={obj:{},toModal:function(i,a){this.type=i,this.title={regular:"增加定时巡检任务",emergency:"增加应急巡检任务"}[i],"modify"===i?(this.obj=$.extend({},a),this.type="应急巡检"===this.obj.examType?"emergency":"regular",this.title="修改巡检工单",this.obj.examBeginTime&&(this.obj.examBeginTime=new Date(this.obj.examBeginTime).Format("yyyy-MM-dd hh:mm:ss")),this.obj.examEndTime&&(this.obj.examEndTime=new Date(this.obj.examEndTime).Format("yyyy-MM-dd hh:mm:ss")),this.obj.approvaler=e.approvalerList.filter(function(i){return i.username===e.addExamineTask.obj.approvaler.strId})[0],r.checkNodeBySomething("addExamineTaskTree",this.obj.siteCodeList,"code"),m()):o.getExamineCode(function(i){e.addExamineTask.obj.code=i}),$("#addExamineTaskModal").modal("show")},execute:function(){this.obj.approvaler={strId:this.obj.approvaler.username,name:this.obj.approvaler.name},this.obj.examBeginTime&&(this.obj.examBeginTime=new Date(this.obj.examBeginTime).getTime()),this.obj.examEndTime&&(this.obj.examEndTime=new Date(this.obj.examEndTime).getTime()),this.obj.examType="regular"===this.type?this.obj.examType:"应急巡检";var e;e="修改巡检工单"===this.title?"modifyExamin":"addExamine",o[e](this.obj,function(){l()}),this.clear()},clear:function(){this.obj={},e.addExamineTaskToggleNavTree(!0),r.checkNodeByCodes("addExamineTaskTree",[]),$("#addExamineTaskModal").modal("hide")}},e.$watch("addExamineTask.obj.examBeginTime + addExamineTask.obj.examEndTime",function(i){if(e.addExamineTask.obj.timeLimit="",e.addExamineTask.obj.examBeginTime&&e.addExamineTask.obj.examEndTime){var a=new Date(e.addExamineTask.obj.examBeginTime).getTime(),t=new Date(e.addExamineTask.obj.examEndTime).getTime();t>a&&(e.addExamineTask.obj.timeLimit=Math.floor((t-a)/1e3/36)/100)}}),e.deleteExamine={obj:{},toModal:function(e){$("#deleteExamineModal").modal("show"),this.obj=e},execute:function(){o.deleteExamin({id:this.obj.id},function(){e.deleteExamine.clear(),l()})},clear:function(){$("#deleteExamineModal").modal("hide")}},e.malfunctionReport={obj:{},toModal:function(i){this.tReport=(new Date).getTime(),this.fileUpload=n.getFileUpload(),this.fileUpload.append=!0,this.fileUpload.maxFileNumber=3,this.fileUpload.onFileSelectCallback=function(){e.malfunctionReport.fileUrl=e.malfunctionReport.fileUpload.getFileUrl(),setTimeout(function(){e.$apply()},300)},this.obj=angular.copy(i),$("#malfunctionReportModal").modal("show"),this.interval=setInterval(function(){e.malfunctionReport.tReport=(new Date).getTime(),e.$apply()},1e3)},execute:function(){var a=this.obj.__get("examineId","needService","troubleLevel","money","troubleReason","troubleSolution","isPaaroval");a.examRecordId=this.obj.id,this.clear(),this.fileUpload.uploadObject("/reparisFunc/add",a,"fileList",function(a){if(e.malfunctionReport.clear(),!1===a.success)return void i.notify({type:"error",text:"上传失败<br/>"+a.info});i.notify({type:"success",text:a.info}),e.doRepairExamineQuery(),e.doExamineQuery(),e.getExamineDetail(e.curExamine)})},select:function(){this.fileUpload.selectFile("malfunctionReportFileUploadBtn")},clear:function(){this.fileUrl=[],this.obj={},this.isPaarovalDisabled=!1,$("#malfunctionReportModal").modal("hide"),clearInterval(this.interval)}},e.$watch("malfunctionReport.obj.money",function(i){var a=parseInt(i);isNaN(a)||(a>0?(e.malfunctionReport.obj.isPaaroval="是",e.malfunctionReport.isPaarovalDisabled=!0):e.malfunctionReport.isPaarovalDisabled=!1)}),e.finishExamineReport={obj:{},toModal:function(i){this.tReport=(new Date).getTime(),this.fileUpload=n.getFileUpload(),this.fileUpload.append=!0,this.fileUpload.maxFileNumber=3,this.fileUpload.onFileSelectCallback=function(){e.finishExamineReport.fileUrl=e.finishExamineReport.fileUpload.getFileUrl(),setTimeout(function(){e.$apply()},300)},this.obj=angular.copy(i),this.interval=setInterval(function(){e.finishExamineReport.tReport=(new Date).getTime(),e.$apply()},1e3),$("#finishExamineReportModal").modal("show")},select:function(){this.fileUpload.selectFile("finishExamineReportFileUploadBtn")},execute:function(){this.fileUpload.uploadObject("/examRecordFunc/finashExam",{examRecordId:this.obj.id},"fileList",function(a){if(e.finishExamineReport.clear(),!1===a.success)return void i.notify({type:"error",text:"上传失败<br/>"+a.info});i.notify({type:"success",text:a.info}),e.doExamineQuery(),e.getExamineDetail(e.curExamine)})},clear:function(){this.obj={},this.fileUrl=[],$("#finishExamineReportModal").modal("hide"),clearInterval(this.interval)}},e.examineApproval={obj:{},toModal:function(e){this.type=e,this.title={pass:"通过",reject:"驳回",cancle:"撤销",send:"上级审批"}[e],$("#examineApprovalModal").modal("show")},execute:function(){var a=this.obj;a.approResult=this.title,a.approvaler={strId:i.user.username,name:i.user.name},a.repairsId=e.curExamine.id,a.superior&&(a.superior={strId:a.superior.username,name:a.superior.name}),o.approvalRepairsExamine(a,function(){e.getRepairExamineDetail(e.curExamine),e.doRepairExamineQuery()}),this.clear()},clear:function(){this.obj={},$("#examineApprovalModal").modal("hide")}},e.reportToRepair={obj:{},toModal:function(i){this.repairs=i,this.fileUpload=n.getFileUpload(),this.fileUpload.append=!0,this.fileUpload.maxFileNumber=3,this.fileUpload.onFileSelectCallback=function(){e.reportToRepair.fileUrl=e.reportToRepair.fileUpload.getFileUrl(),setTimeout(function(){e.$apply()},300)},$("#reportToRepairModal").modal("show")},execute:function(){this.fileUpload.uploadObject("/reparisFunc/finish",{repairsId:this.repairs.id,troubleSolution:this.obj.troubleSolution},"fileList",function(a){if(!1===a.success)return void i.notify({type:"error",text:"上传失败<br/>"+a.info});i.notify({type:"success",text:a.info}),e.reportToRepair.clear(),e.getRepairExamineDetail(e.curExamine),e.doRepairExamineQuery()})},select:function(){this.fileUpload.selectFile("reportToRepairFileUploadBtn")},clear:function(){this.obj={},this.fileUrl=[],$("#reportToRepairModal").modal("hide")}},e.beginExamine=function(i){o.beginExam(i.id,function(){e.getExamineDetail(e.curExamine),e.doExamineQuery()})},e.showImage=function(i){$("#imageShowModal").modal("show"),e.showSIteimage=!0,e.curImage=i},e.hidemage=function(){e.showSIteimage=!1,$("#imageShowModal").modal("hide")},e.changeHasTree=function(e){i.__navbarHasTree=2===e,i.$emit("updateTreetop")},e.addExamineTaskTarget=i.util.getToggleParam(null,[".nav-tree-sm"],{left:"0"},{left:"-232px"}),function(){o.getApprovalerList(function(i){e.approvalerList=i})}(),function(){r.getSiteMapTree({},function(i){e.addExamineTaskTree=r.createZTree(i),r.initTree(e.addExamineTaskTree.zNodes,"addExamineTaskTree","checkboxSiteTree",m)})}(),function(){r.getTierTree(null,function(i){e.siteExamineTree=r.createZTree(i),r.initTree(e.siteExamineTree.zNodes,"siteExamineTree","checkboxTierTree",s),r.checkedAllNodes("siteExamineTree",!0),s(),e.$watch("siteExaminePaginationConf.currentPage + siteExaminePaginationConf.itemsPerPage",x)})}()}]);