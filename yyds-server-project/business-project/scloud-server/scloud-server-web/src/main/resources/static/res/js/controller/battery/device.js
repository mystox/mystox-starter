scloudApp.controller("batteryDeviceController",["$scope","$rootScope","$filter","treeService","batteryService",function(t,e,a,n,r){function i(t,e,a){var n=[{value:-1,name:"全年"}];if(t===e)for(var r=0;r<=a;r++)n.push({value:r,name:v[r]});else if(t<e)for(var r=0;r<v.length;r++)n.push({value:r,name:v[r]});else n=[];return n}function o(){t.batteryDetail=null,t.eventInfoList=null,t.currentEvent=null,t.signalList=null,t.signalDataList=null,t.isUpdateLoading=!0,r.updateSignal(t.deviceId,function(){t.isUpdateLoading=!1,s(),u()})}function s(){t.batteryDetail={},r.getBatteryInfo(t.deviceId,function(e){t.batteryDetail=e,m()})}function u(){t.isLoading1=!0,r.getBatterySignalList(t.deviceId,function(e){t.isLoading1=!1,t.paginationConf1.totalItems=e.count;for(var a=0;a<e.list.length;a++){var n=e.list[a].alarm;e.list[a].alarmSum=n[0]+n[1]+n[2]+n[3]}t.signalList=e.list,l(),e.count&&c(e)})}function l(){t.signalList&&(t.signalDataList=t.signalList.getPaginationItems(t.paginationConf1.itemsPerPage,t.paginationConf1.currentPage,!1))}function c(t){for(var e=[],a={voltage:[],resistance:[],temperature:[]},n=0;n<t.list.length;n++)e.push(t.list[n].batteryNo),a.voltage.push(t.list[n].voltage),a.resistance.push(t.list[n].resistance),a.temperature.push(t.list[n].temperature);var r=100;e.length>24&&(r=Math.ceil(2400/t.list.length)),chart.realTime({id:"voltage",xAxis:[{data:e,name:"电池编号"}],yAxis:[{name:"电压(V)"}],seriesData:[a.voltage],percent:r,tooltip:{nameTag:"电池编号",valueTag:"电压值",unit:"V"},color:["#389AFD","#38FFFD"]}),chart.realTime({id:"resistance",xAxis:[{data:e,name:"电池编号"}],yAxis:[{name:"内阻(mΩ)"}],seriesData:[a.resistance],percent:r,tooltip:{nameTag:"电池编号",valueTag:"内阻值",unit:"mΩ"},color:["#B625FF","#D281FF"]}),chart.realTime({id:"temperature",xAxis:[{data:e,name:"电池编号"}],yAxis:[{name:"温度(℃)"}],seriesData:[a.temperature],percent:r,tooltip:{nameTag:"电池编号",valueTag:"温度值",unit:"℃"},color:["#E04F8F","#E096AE"]})}function p(){t.isQueryHistoryLoading=!0,r.getHistoryDataList(t.deviceId,t.query.historyDataQuery,function(e){t.isQueryHistoryLoading=!1;for(var n=[],r={voltage:[],current:[],temperature:{bottom:[],above:[],below:[],info:[]},resistance:{bottom:[],above:[],below:[],info:[]}},i=0;i<e.length;i++)n.push(a("data")(new Date(e[i].tRecord),"MM-dd HH:mm")),r.voltage.push(e[i].voltage),r.current.push(e[i].current),e[i].tMin>=0?(r.temperature.bottom.push(e[i].tMin),r.temperature.above.push(e[i].tMax-e[i].tMin),r.temperature.below.push(0)):e[i].tMax<0?(r.temperature.bottom.push(e[i].tMax),r.temperature.above.push(0),r.temperature.below.push(e[i].tMin-e[i].tMax)):e[i].tMax>=0&&e[i].tMin<0&&(r.temperature.bottom.push(0),r.temperature.above.push(e[i].tMax),r.temperature.below.push(e[i].tMin)),r.temperature.info.push("温度最高值："+(null===e[i].tMax?"-":+e[i].tMax)+"，电池编号："+(null===e[i].tMaxNo?"-":+e[i].tMaxNo)+"<br/>温度最低值："+(null===e[i].tMin?"-":e[i].tMin)+"，电池编号："+(null===e[i].tMinNo?"-":+e[i].tMinNo)+"<br/>"),e[i].rMin>=0?(r.resistance.bottom.push(e[i].rMin),r.resistance.above.push(e[i].rMax-e[i].rMin),r.resistance.below.push(0)):e[i].rMax<0?(r.resistance.bottom.push(e[i].rMax),r.resistance.above.push(0),r.resistance.below.push(e[i].rMin-e[i].rMax)):e[i].rMax>=0&&e[i].rMin<0&&(r.resistance.bottom.push(0),r.resistance.above.push(e[i].rMax),r.resistance.below.push(e[i].rMin)),r.resistance.info.push("内阻最高值："+(null===e[i].rMax?"-":+e[i].rMax)+"，电池编号："+(null===e[i].rMaxNo?"-":+e[i].rMaxNo)+"<br/>内阻最低值："+(null===e[i].rMin?"-":e[i].rMin)+"，电池编号："+(null===e[i].rMinNo?"-":+e[i].rMinNo)+"<br/>");chart.batteryHistory({id:"batteryHistory",xAxis:[{data:n}],seriesData:[[{name:"电压值",type:"line",color:"#389AFD",yAxisIndex:0,data:r.voltage,markPoint:{data:[{type:"max",name:"最大值"},{type:"min",name:"最小值"}]}},{name:"电流值",type:"line",color:"#38FFFD",yAxisIndex:1,data:r.current,markPoint:{data:[{type:"max",name:"最大值"},{type:"min",name:"最小值"}]}}],[{name:"支撑",type:"bar",color:"rgba(0,0,0,0)",yAxisIndex:2,data:r.temperature.bottom},{name:"上方",type:"bar",color:"#38FFFD",yAxisIndex:2,barMinHeight:1,data:r.temperature.above},{name:"下方",type:"bar",color:"#38FFFD",yAxisIndex:2,barMinHeight:1,data:r.temperature.below},{name:"数据",type:"bar",color:"null",yAxisIndex:2,data:r.temperature.info}],[{name:"支撑",type:"bar",color:"rgba(0,0,0,0)",yAxisIndex:3,data:r.resistance.bottom},{name:"上方",type:"bar",color:"#389AFD",yAxisIndex:3,barMinHeight:1,data:r.resistance.above},{name:"下方",type:"bar",color:"#389AFD",yAxisIndex:3,barMinHeight:1,data:r.resistance.below},{name:"数据",type:"bar",color:"null",yAxisIndex:3,data:r.resistance.info}]]})},function(){t.isQueryHistoryLoading=!1})}function m(){t.isLoading2=!0,r.getEventInfoList(t.batteryDetail.battery.code,function(e){t.isLoading2=!1,t.eventInfoList=e,e&&e[0]&&t.selectEvent(e[0])})}function d(){r.getPDFUrl(t.deviceId,t.query.reportPdfQuery,function(t){e.util.browserInfo.isIE?window.open("http://"+t):document.getElementById("pdf").src="http://"+t})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams);var g=e.util.getParamsFromUrl();t.deviceId=g.deviceId;var y=(new Date).getFullYear(),h=(new Date).getMonth(),v=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"];t.years=[],t.months=[];for(var b=0;b<3;b++)t.years.push(y-(2-b));t.query={historyDataQuery:{year:y,month:null,confirm:function(){p()}},reportPdfQuery:{year:y,month:null,confirm:function(){d()}}},t.setHistoryDataOption=function(e){t.months=i(e,y,h),t.query.historyDataQuery.month=t.months[t.months.length-1].value},t.setReportPdfOption=function(e){t.months=i(e,y,h),t.query.reportPdfQuery.month=t.months[t.months.length-1].value},t.setHistoryDataOption(y),t.setReportPdfOption(y),t.tabPage=e.util.tabPage.getInstance(["实时数据","历史数据","充放电事件","数据报表"]),t.tabPage2=e.util.tabPage.getInstance(["电压","内阻","温度","列表"]),t.isLoading1=!1,t.isLoading2=!1,t.paginationConf1={currentPage:1,itemsPerPage:15,pagesLength:9},t.$watch("paginationConf1.currentPage + paginationConf1.itemsPerPage",l),t.refresh=function(){o()},t.exportHistoryExcel=function(){t.isExportHistoryLoading=!0,r.exportHistoryDataList(t.deviceId,t.query.historyDataQuery,function(e){null!==e&&(window.open("http://"+e),t.isExportHistoryLoading=!1)})},t.selectEvent=function(e){t.currentEvent=e,e.url?document.getElementById("eventImg").src="http://"+e.url[0]:document.getElementById("eventImg").src=""},t.exportEventExcel=function(){t.isExportEventLoading=!0,r.exportEventExcel(t.batteryDetail.battery.code,t.currentEvent.eventId,function(e){null!==e&&(window.open("http://"+e),t.isExportEventLoading=!1)})},t.drawEventDatas=function(){r.drawEventDatas(t.batteryDetail.battery.code,t.currentEvent.eventId,function(){m()})},t.createPngAndReport=function(){r.createPngAndReport(t.deviceId,t.query.reportPdfQuery)},o(),p(),!e.util.browserInfo.isIE&&d()}]);