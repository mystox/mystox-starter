scloudApp.controller("operationProjectController",["$scope","$rootScope","treeService","projectService","deviceService",function(e,r,t,d,n){function o(n){if("areaTree"===n){e.$apply();var o=t.getCheckedNodes("areaTree").filter(function(e){return!e.nextTier});e.orderQuery.siteCodes=o.map(function(e){return e.code}),e.zTree.needUpdate=!0}else if("areaTree2"===n){var a=t.getCheckedNode(n);if(!a)return void r.notify({type:"warn",text:"请选择一个站点"});e.addOrder.obj.siteCode=a.code,e.addOrder.obj.siteName=a.name,e.addOrder.obj.coordinate=a.coordinate,e.addOrder.obj.siteRespName=a.respName,e.addOrder.obj.siteRespPhone=a.respPhone,e.addOrder.obj.fsu=null,d.getFSUList({siteCodes:[a.code],serverCode:e.user.serverCode},function(r){e.fsuList=r}),e.toggleNavTree2(),e.$apply()}}function a(){e.isLoading=!0,e.orderQuery.serverCode=e.user.serverCode,d.getOrderList(e.paginationConf,e.orderQuery).then(function(r){e.orderList=r.list,e.isLoading=!1,e.paginationConf.totalItems=r.count}).catch(function(e){console.log(e)})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.orderQuery={},e.addOrder={form:{},obj:{},toModal:null,execute:null,clear:null},e.showOrder={obj:{},toModal:null,clear:null},e.testOrder={form:{},obj:{},toModal:null,execute:null,clear:null},e.isLoading=!1,e.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.searchKey={online:!0,offline:!0,keyword:""},e.getNodesByParamFuzzy=function(r,t,d){setTimeout(function(){e.zTree.getNodesByParamFuzzy(r,t,d,function(){o("areaTree")}),e.zTree.needUpdate=!0,e.orderQuery.siteCodes=[]},10)},e.getNodesByParamFuzzy2=function(r,t,d){e.zTree2.getNodesByParamFuzzy(r,t,d,function(){o("areaTree2")})},e.query=function(){a()},e.reset=function(){e.orderQuery={}},e.addOrder.toModal=function(){$("#addOrderModal").modal("show")},e.addOrder.execute=function(){$("#addOrderModal").modal("hide");var r=Object.assign({},e.addOrder.obj);r.fsuCode=r.fsu.deviceCode,r.applyTime=(new Date).getTime(),delete r.fsu,d.addOrder(r,function(){a(),e.addOrder.clear()})},e.addOrder.clear=function(){e.addOrder.form.$setPristine(),e.addOrder.obj={},$("#addOrderModal").modal("hide")},e.showOrder.toModal=function(r){$("#showOrderModal").modal("show"),e.currentOrder=r,d.getOrderLogList(r.id,function(r){e.currentOrder.logList=r})},e.showOrder.clear=function(){e.currentOrder={},$("#showOrderModal").modal("hide")},e.showOrder.hide=function(){$("#showOrderModal").modal("hide")},e.testOrder.toModal=function(){$("#testOrderModal").modal("show"),d.getDeviceList({serverCode:e.user.serverCode,siteCode:e.currentOrder.siteCode,deviceCode:e.currentOrder.fsuCode},function(r){e.currentOrder.deviceList=r,r=r.filter(function(e){return"监控设备"!=e.type});var t={};r.forEach(function(e){return t[e.deviceCode]=e.deviceName}),e.currentOrder.deviceMap=t,d.getOrderTestList({orderId:e.currentOrder.id},function(r){e.currentOrder.orderTestList=r})})},e.testOrder.execute=function(t){if($("#testOrderModal").modal("hide"),e.currentOrder.state===r.CONST.orderState.SUBMIT){var n=Object.assign([],e.currentOrder.orderTestList);n.forEach(function(e){e._id=e.id,e.remark=r.util.strNull(e.remark)}),d.submitProjectOrder(n,function(){e.currentOrder=null,a()})}else e.currentOrder.state===r.CONST.orderState.CHECK&&d.updateProjectOrderState({orderId:e.currentOrder.id,fsuCode:e.currentOrder.fsuCode,state:t,suggestion:e.testOrder.obj.suggestion||"",remark:e.testOrder.obj.remark||""},function(){e.currentOrder=null,e.testOrder.obj={},e.testOrder.form.$setPristine(),a()})},e.testOrder.clear=function(){e.currentOrder.deviceList=null,e.currentOrder.orderTestList=null,e.currentOrder.suggestion=null,e.currentOrder.remark=null,$("#testOrderModal").modal("hide"),$("#showOrderModal").modal("show")},e.createOrderTest=function(){d.createOrderTestList({orderId:e.currentOrder.id,deviceMap:e.currentOrder.deviceMap},function(r){d.getOrderTestList({orderId:e.currentOrder.id},function(r){e.currentOrder.orderTestList=r})})},e.getOrderTestHistoryAndCurrent=function(){var t=e.currentOrder.orderTestList;e.isLoading2=!0;for(var n=0;n<t.length;n++)t[n].history=null,t[n].current=null,t[n].result=!1;d.getOrderTestHistoryAlarm(e.currentOrder.id,function(n){d.getOrderTestCurrentValue(e.currentOrder.id,function(d){e.isLoading2=!1;for(var o=0;o<t.length;o++)t[o].history=(n.find(function(e){return e.cntbId===t[o].cntbId})||{}).history,t[o].history?t[o].current=(n.find(function(e){return e.cntbId===t[o].cntbId})||{}).current:t[o].current=(d.find(function(e){return e.cntbId===t[o].cntbId})||{}).current,t[o].signalType===r.CONST.signalType.DI?t[o].result=null!=t[o].history&&0===t[o].current:t[o].signalType===r.CONST.signalType.AI&&(t[o].result=null!=t[o].current)},function(){e.isLoading2=!1})})},e.getSiteFromTree=function(e){var r=$.fn.zTree.getZTreeObj("areaTree");if(!r)return{};var t=r.getNodeByParam("code",e);return t?{tierName:t.getParentNode().getParentNode().getParentNode().name+"-"+t.getParentNode().getParentNode().name+"-"+t.getParentNode().name,name:t.name,coordinate:t.coordinate}:{}},function(){e.target2=r.util.getToggleParam(null,[".nav-tree-sm"],{left:"0"},{left:"-232px"})}(),function(){e.treeLoading=!0,e.treeLoading3=!0,t.getSiteMapTree({serverCode:e.user.serverCode,keys:["respName","coordinate","respPhone"]},function(r){e.treeLoading=!1,e.treeLoading2=!1,e.zTree=t.createZTree(r),e.zTree2=t.createZTree(angular.copy(r)),t.initTree(e.zTree.zNodes,"areaTree","checkboxSiteTree",function(){o("areaTree")}),t.initTree(e.zTree2.zNodes,"areaTree2","radioSiteTree",function(){o("areaTree2")}),t.checkedAllNodes("areaTree",!0);var d=t.getCheckedNodes("areaTree").filter(function(e){return!e.nextTier});e.orderQuery.siteCodes=d.map(function(e){return e.code}),e.zTree.needUpdate=!0,e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",a)})}()}]);