scloudApp.controller("operationProjectController",["$scope","$rootScope","treeService","projectService","fsuService",function(e,r,t,d,n){function o(d){if("areaTree"===d){e.$apply();var o=t.getCheckedNodes("areaTree").filter(function(e){return!e.nextTier});e.orderQuery.siteIds=o.map(function(e){return e.id}),e.zTree.needUpdate=!0}else if("areaTree2"===d){var a=t.getCheckedNode(d);if(!a)return void r.notify({type:"warn",text:"请选择一个站点"});e.addOrder.obj.siteId=a.id,e.addOrder.obj.siteName=a.name,e.addOrder.obj.coordinate=a.coordinate,e.addOrder.obj.siteRespName=a.respName,e.addOrder.obj.siteRespPhone=a.respPhone,e.addOrder.obj.fsu=null,n.getFsuInSiteList(a.id,null,function(r){e.fsuList=r}),e.toggleNavTree2(),e.$apply()}}function a(){e.isLoading=!0,d.getOrderList(e.paginationConf,e.orderQuery).then(function(r){e.orderList=r.list,e.isLoading=!1,e.paginationConf.totalItems=r.count}).catch(function(e){console.log(e)})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.orderQuery={},e.addOrder={form:{},obj:{},toModal:null,execute:null,clear:null},e.showOrder={obj:{},toModal:null,clear:null},e.testOrder={form:{},obj:{},toModal:null,execute:null,clear:null},e.isLoading=!1,e.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:5,onChange:function(){}},e.searchKey={online:!0,offline:!0,keyword:""},e.getNodesByParamFuzzy=function(r,t,d){setTimeout(function(){e.zTree.getNodesByParamFuzzy(r,t,d,function(){o("areaTree")})},10)},e.getNodesByParamFuzzy2=function(r,t,d){e.zTree2.getNodesByParamFuzzy(r,t,d,function(){o("areaTree2")})},e.query=function(){a()},e.reset=function(){e.orderQuery={}},e.addOrder.toModal=function(){$("#addOrderModal").modal("show")},e.addOrder.execute=function(){$("#addOrderModal").modal("hide"),d.addOrder(e.addOrder.obj,function(){a(),e.addOrder.clear()})},e.addOrder.clear=function(){e.addOrder.form.$setPristine(),e.addOrder.obj={},$("#addOrderModal").modal("hide")},e.showOrder.toModal=function(r){$("#showOrderModal").modal("show"),e.currentOrder=r,d.getOrderLogList(r.order.id,function(r){e.currentOrder.logList=r})},e.showOrder.clear=function(){e.currentOrder={},$("#showOrderModal").modal("hide")},e.showOrder.hide=function(){$("#showOrderModal").modal("hide")},e.testOrder.toModal=function(){$("#testOrderModal").modal("show"),d.getDeviceList(e.currentOrder.order.id,function(r){e.currentOrder.deviceList=r}),d.getOrderTestList(e.currentOrder.order.id,function(r){e.currentOrder.orderTestList=r})},e.testOrder.execute=function(t){$("#testOrderModal").modal("hide"),e.currentOrder.order.state===r.CONST.orderState.SUBMIT?d.submitProjectOrder(e.currentOrder.order.id,e.currentOrder.orderTestList,function(){e.currentOrder=null,a()}):e.currentOrder.order.state===r.CONST.orderState.CHECK&&d.updateProjectOrderState({id:e.currentOrder.order.id,fsuId:e.currentOrder.fsu.id,state:t,suggestion:e.testOrder.obj.suggestion,remark:e.testOrder.obj.remark},function(){e.currentOrder=null,e.testOrder.obj={},e.testOrder.form.$setPristine(),a()})},e.testOrder.clear=function(){e.currentOrder.deviceList=null,e.currentOrder.orderTestList=null,e.currentOrder.order.suggestion=null,e.currentOrder.order.remark=null,$("#testOrderModal").modal("hide"),$("#showOrderModal").modal("show")},e.createOrderTest=function(){d.createOrderTestList(e.currentOrder.order.id,function(r){e.currentOrder.orderTestList=r})},e.getOrderTestHistoryAndCurrent=function(){var t=e.currentOrder.orderTestList;e.isLoading2=!0;for(var n=0;n<t.length;n++)t[n].history=null,t[n].current=null,t[n].result=!1;d.getOrderTestHistoryAlarm(e.currentOrder.order.id,function(n){d.getOrderTestCurrentValue(e.currentOrder.order.id,function(d){e.isLoading2=!1;for(var o=0;o<t.length;o++)t[o].history=n[t[o].signalId],t[o].current=d[t[o].signalId],t[o].signalType===r.CONST.signalType.DI?t[o].result=null!=t[o].history&&0===t[o].current:t[o].signalType===r.CONST.signalType.AI&&(t[o].result=null!=t[o].current)},function(){e.isLoading2=!1})})},function(){e.target2=r.util.getToggleParam(null,[".nav-tree-sm"],{left:"0"},{left:"-232px"})}(),function(){e.treeLoading=!0,e.treeLoading3=!0,t.getSiteMapTree({},function(r){e.treeLoading=!1,e.treeLoading2=!1,e.zTree=t.createZTree(r),e.zTree2=t.createZTree(angular.copy(r)),t.initTree(e.zTree.zNodes,"areaTree","checkboxSiteTree",function(){o("areaTree")}),t.initTree(e.zTree2.zNodes,"areaTree2","radioSiteTree",function(){o("areaTree2")}),t.checkedAllNodes("areaTree",!0);var d=t.getCheckedNodes("areaTree").filter(function(e){return!e.nextTier});e.orderQuery.siteIds=d.map(function(e){return e.id}),e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",a)})}()}]);