scloudApp.controller("alarmPriorityController",["$scope","$rootScope","$timeout","treeService","alarmRedefineService","alarmPriorityService",function(t,e,i,r,o,n){$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),function(){t.treeLoading=!0,r.getSiteTree(function(e){t.treeLoading=!1,t.zTree=r.createZTree(e),r.initTree(t.zTree.zNodes,"siteTree","radioSiteTree",function(){t.getCheckedNodeInSelect("siteTree")}),t.siteList=function t(e){if(!e.nextTier)return e;var i=e.nextTier.map(function(e){return t(e)});return Array.prototype.concat.apply([],i)}(t.zTree.zNodes)})}(),t.getCheckedNodeInSelect=function(e){var i=r.getCheckedNode(e);!i||t.priority.editItem.model.site.filter(function(t){return t.id===i.id}).length>0||(t.priority.editItem.model.site.push(i),t.$apply())},t.priority={list:[],loading:!1,pageConf:{currentPage:1,itemsPerPage:15,pagesLength:9},removeSite:function(e){var i=t.priority.editItem.model.site;i.splice(i.indexOf(e[0]),1),t.priority.editItem.model.remove=[]},getList:function(){this.loading=!0,this.list=[];var t=this;n.getAlarmPriorityList(this.pageConf,function(e){t.list=e.list,t.pageConf.totalItems=e.count,t.loading=!1})},editItem:{model:{ruleName:"",pAlarm:"",sAlarm:[],site:[],reason:""},add:function(){n.addAlarmPriority({majorName:t.priority.editItem.model.ruleName,majorAlarm:t.priority.editItem.model.pAlarm,minorAlarmList:t.priority.editItem.model.sAlarm.map(function(t){return t.id}),siteIdList:t.priority.editItem.model.site.map(function(t){return t.id}),remarks:t.priority.editItem.model.reason},function(i){e.notify({type:"success",text:"添加规则成功。"}),t.priority.getList(),t.priority.editItem.model={ruleName:"",pAlarm:"",sAlarm:[],site:[],reason:""},t.priority.editItem.cancel()})},toUpdate:function(e){this.updating=!0,this.model={ruleName:e.majorName,pAlarm:e.majorAlarm,sAlarm:e.minorAlarmList.map(function(e){return t.getSignalName(e)}),site:e.siteIdList.map(function(e){return t.getSiteById(e)}),reason:e.remarks,id:e.id}},update:function(){n.modifyAlarmPriority({majorName:this.model.ruleName,majorAlarm:this.model.pAlarm,minorAlarmList:this.model.sAlarm.map(function(t){return t.id}),siteIdList:this.model.site.map(function(t){return t.id}),remarks:this.model.reason,id:this.model.id},function(){e.notify({type:"success",text:"修改规则成功！"}),t.priority.editItem.cancel(),t.priority.getList()})},cancel:function(){this.model={name:"",pAlarm:"",sAlarm:[],site:[]},this.updating=!1,this.form.$setPristine()},toggleEnable:function(e){n.toggleAlarmPriorityEnableState(e,function(){t.priority.getList()})}},showItem:{},deleteItemModal:{toModal:function(t){$("#deleteRuleModal").modal(),this.item=t},execute:function(){n.deleteAlarmPriority(this.item.id,function(){t.priority.getList(),e.notify({type:"success",text:"删除规则成功。"})}),this.clear()},clear:function(){this.item=null,$("#deleteRuleModal").modal("hide")}},expo:function(){n.exportAlarmMajor(this.pageConf,function(t){console.log(t)})}},t.signalList={data:[]},t.getSignalName=function(e){return t.signalList.data.filter(function(t){return t.id===e})[0]||{text:"无信号"}},t.getSiteById=function(e){return t.siteList.filter(function(t){return t.id===e})[0]||{}},t.checkAlarmOverlap=function(){return t.priority.editItem.model.sAlarm.filter(function(e){return e.id===t.priority.editItem.model.pAlarm}).length>0},function(){o.getDISignalTypeList(function(e){t.signalList={data:e.map(function(t){return{id:t.strId,text:t.name}})},t.$watch("priority.pageConf.currentPage + priority.pageConf.itemsPerPage",t.priority.getList())})}()}]);