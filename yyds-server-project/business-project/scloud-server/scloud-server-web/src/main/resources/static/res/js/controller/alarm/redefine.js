scloudApp.controller("alarmRedefineController",["$scope","$rootScope","$timeout","treeService","alarmRedefineService","deviceService","alarmService",function(e,t,n,i,a,d,o){function l(){e.isLoading=!0,a.getRuleList(e.paginationConf,e.ruleQuery,function(t){e.isLoading=!1,e.ruleList=t.list,e.paginationConf.totalItems=t.count},function(){e.isLoading=!1})}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.ruleQuery={enabled:null},e.addRule={form:{},obj:{selectedSiteList:[],siteIds:[],selectedSignalList:[],signalCodes:[]},toModal:null,execute:null,clear:null},e.deleteRule={form:{},obj:{},toModal:null,execute:null,clear:null},e.signalList={data:[]},e.isLoading=!1,e.isLoading2=!1,e.paginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",l),e.paginationConf2={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.query=function(){l()},e.reGetSignalList=function(t){t.id&&(e.isLoading2=!0,a.listRedefineAlarm({ruleId:t.id,paginationConf:e.paginationConf2},function(t){e.isLoading2=!1,e.redefinedList=t.list,e.paginationConf2.totalItems=t.count},function(){e.isLoading2=!1}))},e.$watch("paginationConf2.currentPage + paginationConf2.itemsPerPage",e.reGetSignalList),e.addRule.toModal=function(t){var n=$.fn.zTree.getZTreeObj("areaTree");e.addRule.obj=Object.assign({},t),e.addRule.obj.originOrb=t,e.addRule.obj.device=e.deviceList.find(function(t){return t.code===e.addRule.obj.deviceType}),e.changDevice(),e.addRule.obj.signalCodeList=t.cntbIdList.map(function(t){return e.signalList.data.find(function(e){return e.id===t})}),e.addRule.obj.selectedSiteList=t.siteCodeList.map(function(e){return n.getNodeByParam("code",e)}),e.addRule.obj.__type="modify"},e.addRule.execute=function(){var t=e.addRule.obj.__get("name","alarmLevel","reason","deviceType","id");t.enterpriseCode=e.user.enterpriseCode,t.serverCode=e.user.serverCode,t.siteCodeList=e.addRule.obj.selectedSiteList.map(function(e){return e.code}),t.cntbIdList=e.addRule.obj.signalCodeList.map(function(e){return e.id}),t.siteInfoList=e.addRule.obj.selectedSiteList.map(function(e){return e.getParentNode().getParentNode().getParentNode().name+"-"+e.getParentNode().getParentNode().name+"-"+e.getParentNode().name+":"+e.name}),t.signalInfoList=e.addRule.obj.signalCodeList.map(function(t){return e.addRule.obj.device.typeName+":"+t.text});var n="modify"===e.addRule.obj.__type?"updateRule":"addRule";a[n](t,function(){e.addRule.clear(),l()})},e.addRule.clear=function(){e.addRule.form.$setPristine(),delete t.failToCheckRuleName,e.addRule.obj={selectedSiteList:[],siteIds:[],selectedSignalList:[],signalCodeList:[],device:null}},e.getRuleDetail=function(t,n){e.ruleDetail=t,e.openDetailTab(n),t.targetLevel=e.alarmLevelList.find(function(e){return e.key===t.alarmLevel}).value},e.openDetailTab=function(t){e.openDetailIndex===t?e.openDetailIndex=null:e.openDetailIndex=t},e.getNodesByParamFuzzy=function(t,n,i){e.zTree.getNodesByParamFuzzy(t,n,i,function(){e.getCheckedNodeInSelect("areaTree")})},e.getCheckedNodeInSelect=function(t){var n=i.getCheckedNode(t);n&&(e.multiNodeSelect.add(n,e.addRule.obj.selectedSiteList),e.$apply())},e.changDevice=function(){e.addRule.obj.deviceType=e.addRule.obj.device.code,e.addRule.obj.signalCodeList=[],e.signalList={data:e.addRule.obj.device.signalTypeList.map(function(e){return{id:e.cntbId,text:e.typeName}})}},e.multiNodeSelect={add:function(e,t){!1===t.containsObj(e)&&(t[t.length]=e)},remove:function(e,t){!e||e.length<1||(t.removeObj(e[0]),e=[])}},e.deleteRule.toModal=function(t){e.deleteRule.obj=t,$("#deleteRuleModal").modal("show")},e.deleteRule.execute=function(){$("#deleteRuleModal").modal("hide"),a.deleteRule(e.deleteRule.obj.id,function(){l(),e.deleteRule.clear()})},e.deleteRule.clear=function(){e.deleteRule.obj={},$("#deleteRuleModal").modal("hide")},e.changeState=function(t){e.isLoading=!0,a.changeState({id:t.id,enabled:!t.enabled},function(){e.isLoading=!1,l()})},e.checkRuleNameTO=null,e.checkRuleName=function(){if(window.clearTimeout(e.checkRuleNameTO),e.addRule.obj.originOrb&&e.addRule.obj.originOrb.name===e.addRule.obj.name)return void(e.addRule.failToCheckRuleName=!1);e.checkRuleNameTO=window.setTimeout(function(){e.addRule.failToCheckRuleName=!1,a.checkRuleNameUnique(e.addRule.obj.name,function(t){e.addRule.failToCheckRuleName=!t.success})},300)},function(){e.treeLoading=!0,i.getSiteMapTree({serverCode:e.user.serverCode},function(t){e.treeLoading=!1,e.zTree=i.createZTree(t),i.initTree(e.zTree.zNodes,"areaTree","radioSiteTree",function(){e.getCheckedNodeInSelect("areaTree")})})}(),function(){d.getDeviceTypeList(0,function(t){e.deviceList=t})}(),function(){o.getAlarmLevelList({pageSize:9999,curPage:1,enterpriseCode:e.user.enterpriseCode,serverCode:e.user.serverCode},function(t){var n=t.list.find(function(e){return"启用"===e.state});e.alarmLevelList=n?n.levelNames.map(function(e,t){return{key:n.levels[t],value:e+"("+n.levels[t]+")"}}):[]})}()}]);