scloudApp.controller("homeController",["$scope","$rootScope","$filter","reportService","siteService","fsuService","alarmService","$state","treeService",function(e,t,n,a,i,r,o,l,s){function u(t,n){function a(t){e.siteCount=t.total,e.maintenanceSiteCount=t.intersectionState}n.homeSite?a(n.homeSite):C.send(i,"homeSite",t,function(e){a(e),n.homeSite=e})}function m(n,i){function r(n){var a=[n.level1,n.level2,n.level3,n.level4],i=t.CONST.alarmColorList;e.checkedCounts=n.confirm,e.uncheckedCounts=n.unConfirm;var r=Math.max.apply(0,a);e.alarmLevelList=a.map(function(e,t){return{key:t+1+"",value:r>0?e:0,percent:(100*e/r).toFixed(2),color:i[t]}})}i.getAlarmCount?r(i.getAlarmCount):C.send(a,"getAlarmCount",n,{},function(e){i.getAlarmCount=e,r(e)})}function c(t){C.send(o,"getHomeAlarmList",t,function(t){e.alarmList=t})}function d(t,n){function a(t){e.fsu=t,document.getElementById(e.fsuPieId)&&chart.fsuPie({id:e.fsuPieId,onlineCount:t.onlineCount||0,offlineCount:t.offlineCount||0})}n.getFsuStat?a(n.getFsuStat):C.send(r,"getFsuStat",t,function(e){n.getFsuStat=e,a(e)})}function f(t,n){function a(t){if(document.getElementById(e.fsuStatId)){var n=[],a=[],i=[];if(t.forEach(function(e){var t=new Date(e.recordTime).Format("MM-dd hh:mm"),r=e.onlineCount+e.offlineCount?(100*e.onlineCount/(e.onlineCount+e.offlineCount)).toFixed(2):0;a.push(t),n.push(r),i.push("时间："+t+"<br/>在线率："+r+"%<br/>在线数："+e.onlineCount+"<br/>离线数："+e.offlineCount+"<br/>")}),0===t.length){var r=1e3*Math.floor((new Date).getTime()/36e5)*60*60;a=new Array(72).join(".").split(".").map(function(e,t){return new Date(r-1e3*(71-t)*60*60).Format("MM-dd hh:mm")}),n=new Array(72).join(".").split(".").map(function(e,t){return 0}),i=a.map(function(e){return"时间："+e+"<br/>在线率：0%<br/>在线数：0<br/>离线数：0<br/>"})}chart.fsuLine({id:e.fsuStatId,xAxis:{data:a},data:n,info:i})}}n.getFsuStatList?a(n.getFsuStatList):C.send(r,"getFsuStatList",t,function(e){n.getFsuStatList=e,a(e)})}function p(t,n){function i(t){e.alarmSiteList=new Array(5).join(".").split(".").map(function(e,n){return{key:t[n]?t[n].site.name:"暂无",value:t[n]?t[n].count:0,id:t[n]?t[n].site.strId:""}})}function r(t){if(document.getElementById(e.alarmSiteBarId)){var n=t&&t[0]?t[0].count.map(function(e){return e.time}):["","","","",""],a=new Array(3).join(".").split(".").map(function(e,n){return t&&t[n]?t[n].count.map(function(e){return e.count}):[0,0,0,0,0,0,0]});chart.alarmSiteBar({id:e.alarmSiteBarId,xAxis:{data:n},data:[a[0],a[1],a[2]]})}}n.getMostAlarmSiteCount?(i(n.getMostAlarmSiteCount),r(n.alarmSiteHistory)):C.send(a,"getMostAlarmSiteCount",{tier:t},function(e){if(n.getMostAlarmSiteCount=e,i(e),e.length>0){var t=e.slice(0,3).map(function(e){return e.site.strId});C.send(a,"alarmSiteHistory",{siteIds:t},function(e){e.sort(function(e,n){return t.indexOf(e.site.strId)-t.indexOf(n.site.strId)}),n.alarmSiteHistory=e,r(e)})}else r([])})}function h(n,i){function r(n){document.getElementById(e.alarmLineId)&&chart.alarmLine({id:e.alarmLineId,title:"近7天历史告警",color:t.CONST.alarmColorList,seriesName:["一级告警","二级告警","三级告警","四级告警"],series:[n[1],n[2],n[3],n[4]],xAxis:{data:n[0]}})}function o(t){if(document.getElementById(e.alarmTop3LineId)){for(var n=$.extend([],t.alarmNames),a=$.extend([],t.counts),i=0;i<3;i++)n[i]?n[i]=i+1+" "+n[i]:(n[i]=i+1+" 暂无",a[i+1]=[0,0,0,0,0,0,0]);chart.alarmLine({id:e.alarmTop3LineId,title:"近7天历史告警Top3",color:["#7C41F5","#00B1FF","#FFB700"],seriesName:n,series:[a[1],a[2],a[3]],xAxis:{data:a[0]}})}}i.getAlarmCountInWeek?r(i.getAlarmCountInWeek):C.send(a,"getAlarmCountInWeek",n,function(e){i.getAlarmCountInWeek=e,r(e)}),i.getMostAlarmNameCount?o(i.getMostAlarmNameCount):C.send(a,"getMostAlarmNameCount",n,function(e){i.getMostAlarmNameCount=e,o(e)})}function v(t){var n;e.caches[t||"all"]&&(new Date).getTime()<e.caches[t||"all"].timestamp+3e5?n=e.caches[t||"all"]:(n={timestamp:(new Date).getTime()},e.caches[t||"all"]=n),u(t,e.caches[t||"all"]),m(t,e.caches[t||"all"]),d(t,e.caches[t||"all"]),f(t,e.caches[t||"all"]),p(t,e.caches[t||"all"]),h(t,e.caches[t||"all"]),"none"!==t&&c(t)}l&&(l=window.$state),$stateParams&&($stateParams=window.$stateParams);var g=Math.floor((new Date).getTime()/1e3);e.alarmMapId="alarmMap"+g,e.fsuStatId="fsuStat"+g,e.alarmSiteBarId="alarmSiteBar"+g,e.alarmLineId="alarmLine"+g,e.alarmTop3LineId="alarmTop3Line"+g,e.fsuPieId="fsuPie"+g,e.curTier=void 0,e.caches={none:{timestamp:(new Date).getTime(),getFsuStatList:[],homeSite:{intersectionState:0,total:0},getFsuStat:{onlineCount:0,offlineCount:0},getMostAlarmNameCount:{alarmNames:[],counts:[["","","","","","",""]]},getMostAlarmSiteCount:[],getAlarmCount:{level1:0,level2:0,level3:0,level4:0,confirm:0,unConfirm:0},getAlarmCountInWeek:[["","","","","","",""],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]]}},e.mapFilter={alarm:[1,1,1,1,1]},e.getFontSize=function(e,t){var n={l:[60,60,60,60,44,33,22],r:[44,44,44,44,44,33,22]},a={l:[1,1,1,1,3,2,4],r:[3,3,3,3,3,2,4]};return{fontSize:(n[e][(t+"").length]||33)+"px",marginTop:(a[e][(t+"").length]||0)+"px"}};var C=function(){function e(e,r){var o=[].map.call(arguments,function(e){return e}).slice(2),l=o.pop();a<n?t(e,r,o,l):i.push([e,r,o,l]),a++}function t(e,n,r,o){r.push(function(e){if("#/home"===location.hash&&(o(e),a--,i.length)){var n=i.shift();t.apply(null,n)}}),e[n].apply(null,r)}var n=5,a=0,i=[];return{send:e}}();e.renderMap=function(){function t(e,t,n,a){this._point=e,this._overText=t,this.site=a,this.topAlarm=n}var n=e.alarmData,a=e.mapFilter;t.prototype=$.extend(new BMap.Overlay,{getPosition:function(){return this._point},getMap:function(){return this._map},initialize:function(e){this._map=e;var t=$('<div style="position:absolute;width:10px;height:10px;" class="sigle-site"><div style="pointer-events:none" class="alarm-icon level'+this.topAlarm+'"></div></div>'),n=this,a=this._div=t[0];return a.addEventListener("mouseenter",function(e){function t(){$("#site-detail").html("站点编号："+r.code+" <br/>站点名称："+r.name+" <br/>站点状态：FUS "+r.fsuState+" <br/>告警数量："+r.alarmNum+" <br/>经纬度："+(r.coordinate||"-")+" <br/>站点地址："+(r.address||"-")),a.isHide||$("#site-detail").show(),$("#site-detail").css({left:e.offsetX+e.pageX+"px",top:e.offsetY+e.pageY-30-$("#site-detail").height()+"px"})}a.isHide=!1;var r=n.detail;n.detail?t():C.send(i,"getSiteDetail",n.site.site.strId,function(e){n.detail=r=e,t()})}),a.addEventListener("mouseleave",function(){a.isHide=!0,$("#site-detail").hide()}),a.addEventListener("click",function(){l.go("scene/site",{siteId:n.site.site.strId})}),e.getPanes().labelPane.appendChild(a),a},draw:function(){var e=this._map,t=e.pointToOverlayPixel(this._point);this._div.style.top=t.y-5+"px",this._div.style.left=t.x-5+"px"}}),e.points&&e.points.dispose();var r=[],o=null;n.filter(function(e){return e.longitude&&e.latitude&&(a.alarm[0]||a.alarm[1]&&e.level1||a.alarm[2]&&e.level2||a.alarm[3]&&e.level3||a.alarm[4]&&e.level4)}).forEach(function(e){o=new BMap.Point(e.longitude,e.latitude);var n=new t(o,e.site.name,e.level1&&a.alarm[1]?1:e.level2&&a.alarm[2]?2:e.level3&&a.alarm[3]?3:e.level4&&a.alarm[4]?4:0,e);n._domElement=document.createElement("div"),n._domElement.className="alarm-icon level3",r.push(n)}),e.points=new BMapLib.MarkerClusterer(e.map,{markers:r,minClusterSize:6,isAverageCenter:!0,styles:new Array(20).join(".").split(".").map(function(e,t){var n=[70,90,110,130,150][t%5];return{size:new BMap.Size(n,n),textColor:"#051d4c"}})})},e.$watch("enterprise.refreshInterval",function(){if(void 0!==t.enterprise&&null!==t.enterprise){var n=t.enterprise.refreshInterval;void 0!==n&&null!==n&&(window.timerTaskManager.clearAll(!1),n<=0||window.timerTaskManager.create(function(){v(e.curTier)},1e3*n,!1))}}),setTimeout(function(){v("none"),v(e.curTier)},10),function(){C.send(a,"getCoordinateList",function(t){e.alarmData=t,document.getElementById(e.alarmMapId)&&setTimeout(function(){e.renderMap()},300)});var t=null;setTimeout(function(){e.map=createHomeMap({alarmMapId:e.alarmMapId,locateCallback:function(n){t&&clearTimeout(t),t=setTimeout(function(){e.curTier=n,v(e.curTier),t=null},50)}})},0)}()}]);