scloudApp.controller("homeController",["$scope","$rootScope","$filter","reportService","siteService","fsuService","alarmService","workService","$state","treeService",function(e,t,a,n,i,r,o,l,s,u){function c(t,a){function n(t){e.siteCount=t.total,e.maintenanceSiteCount=t.intersectionState}a.homeSite?n(a.homeSite):C.send(i,"homeSite",t,function(e){n(e),a.homeSite=e})}function m(a,i){function r(a){var n=[a.levelMap[1]||0,a.levelMap[2]||0,a.levelMap[3]||0,a.levelMap[4]||0],i=t.CONST.alarmColorList;e.checkedCounts=a.confirm,e.uncheckedCounts=a.unConfirm;var r=Math.max.apply(0,n);e.alarmLevelList=n.map(function(e,t){return{key:t+1+"",value:r>0?e:0,percent:(100*e/r).toFixed(2),color:i[t]}})}i.getAlarmCount?r(i.getAlarmCount):C.send(n,"getAlarmCount",a,{},function(e){i.getAlarmCount=e,r(e)})}function d(t,a){function n(t){e.fsu=t,document.getElementById(e.fsuPieId)&&chart.fsuPie({id:e.fsuPieId,onlineCount:t[0]&&t[0].count||0,offlineCount:t[1]&&t[1].count||0})}a.getFsuStat?n(a.getFsuStat):C.send(r,"getFsuStat",t,function(e){a.getFsuStat=e,n(e)})}function p(a,n){function i(a){e.workInfoCounts=a;var n=t.CONST.alarmColorList,i={};if(a&&0!==a.length){var r=Math.max(a[0],a[5]);i={list:[{name:"未接工单",counts:[{type:"告警工单",count:a[1],url:"operation/workList",state:"待接单"},{type:"巡检工单",count:a[6],url:"operation/examine",state:"未开始"}],colors:[n[0],n[1]],searchObj:{state:["待接单","未开始"]}},{name:"在途工单",counts:[{type:"告警工单",count:a[2],url:"operation/workList",state:"待办工单"},{type:"巡检工单",count:a[7],url:"operation/examine",state:"巡检中"}],colors:[n[0],n[1]],searchObj:{state:["待处理","巡检中"]}},{name:"历史工单",counts:[{type:"告警工单",count:a[3],url:"operation/workList",state:"历史工单"},{type:"巡检工单",count:a[8],url:"operation/examine",state:"已完成"}],colors:[n[0],n[1]],searchObj:{state:["历史工单","已完成"]}},{name:"超时工单",counts:[{type:"告警工单",count:a[4],url:"operation/workList",state:"未完成",isOverTime:"是"},{type:"巡检工单",count:a[9],url:"operation/examine",state:"未完成",isOverTime:"是"}],colors:[n[0],n[1]],searchObj:{state:[""]}}],allInfoList:[{name:"告警工单",value:a[0],percent:parseInt(100*a[0]/r),color:n[0],url:"operation/workList"},{name:"巡检工单",value:a[5],percent:parseInt(100*a[5]/r),color:n[1],url:"operation/examine"}]}}document.getElementById(e.alarmWorkBarId)&&chart.workBar({id:e.alarmWorkBarId,xAxis:{data:["未接工单","在途工单","超时工单","历史工单"]},data:[a[1],a[2],a[4],a[3]],LinearGradientColors:[{offset:0,color:"#FF5050"},{offset:1,color:"#FF003C"}],handleClickBar:function(t){e.goPage&&e.goPage(i.list.filter(function(e){return e.name===t.name})[0].counts[0])}})}n.getWorkerInfo?i(n.getWorkerInfo):C.send(l,"getWorkStatic",{tierCode:a},function(e){n.getWorkerInfo=[e.noReceive,e.onRoad,e.overTime,e.history],i(n.getWorkerInfo)})}function f(t,a){function i(t){t=JSON.parse(t.dataResult).data,e.alarmSiteList=new Array(10).join(".").split(".").map(function(e,a){return{key:t[a]?t[a][0]:"暂无",value:t[a]?t[a][1]:0}})}if(a.getMostAlarmSiteCount)i(a.getMostAlarmSiteCount);else{var r={dataType:"json",operaCode:"report_homeAlarmCount",reportServerCode:"REPORTS_SERVER_1.0.0",enterpriseCode:e.user.enterpriseCode,serverCode:e.user.serverCode,executorType:"query",condition:{stationList:[],statisticLevel:"站点级",timePeriod:{startTime:Date.today.getTime()-Date.oneMonth,endTime:Date.today.getTime()}}},o=function(){r.condition.stationList=e.alarmData.filter(function(e){return 0===e.tierCode.indexOf(t)}).map(function(e){return e.code}),C.send(n,"getMostAlarmSiteCount",r,function(e){if(a.getMostAlarmSiteCount=e,i(e),e.length>0){var t=e.slice(0,3).map(function(e){return e.site.strId});C.send(n,"alarmSiteHistory",{siteIds:t},function(e){e.sort(function(e,a){return t.indexOf(e.site.strId)-t.indexOf(a.site.strId)}),a.alarmSiteHistory=e})}})};!function t(){e.alarmData?o():setTimeout(function(){t()},50)}()}}function v(t,a){function i(t){if(document.getElementById(e.alarmDistributionId)){t=JSON.parse(t.dataResult).data;var a=new Array(8).join(".").split(".").map(function(e,a){return t[a]?t[a][1]:"-"}),n={id:e.alarmDistributionId,xAxis:{data:new Array(8).join(".").split(".").map(function(e,a){return t[a]?t[a][0]:"-"})},series:{data:a,pinData:a},callback:function(e){}};chart.alarmTierTop5ForHome(n)}}if(a.getAlarmDistributionWeek)i(a.getAlarmDistributionWeek);else{var r={dataType:"json",operaCode:"report_homeAlarmCount",reportServerCode:"REPORTS_SERVER_1.0.0",enterpriseCode:e.user.enterpriseCode,serverCode:e.user.serverCode,executorType:"query",condition:{stationList:[],statisticLevel:"省级",timePeriod:{startTime:Date.today.getTime()-Date.oneMonth,endTime:Date.today.getTime()}}},o=function(){r.condition.stationList=e.alarmData.filter(function(e){return 0===e.tierCode.indexOf(t)}).map(function(e){return e.code}),r.condition.statisticLevel="none"===t?"省级":2===(t||"").length?"市级":4===(t||"").length?"区县级":"站点级",C.send(n,"getMostAlarmSiteCount",r,function(e){a.getMostAlarmSiteCount=e,i(e)})};!function t(){e.alarmData?o():setTimeout(function(){t()},50)}()}}function h(t){var a;e.caches[t||"all"]&&(new Date).getTime()<e.caches[t||"all"].timestamp+3e5?a=e.caches[t||"all"]:(a={timestamp:(new Date).getTime()},e.caches[t||"all"]=a),c(t,e.caches[t||"all"]),m(t,e.caches[t||"all"]),d(t,e.caches[t||"all"]),p(t,e.caches[t||"all"]),f(t,e.caches[t||"all"]),v(t,e.caches[t||"all"])}s&&(s=window.$state),$stateParams&&($stateParams=window.$stateParams);var g=Math.floor((new Date).getTime()/1e3);e.alarmMapId="alarmMap"+g,e.fsuStatId="fsuStat"+g,e.alarmSiteBarId="alarmSiteBar"+g,e.alarmLineId="alarmLine"+g,e.alarmDistributionId="alarmDistribution"+g,e.fsuPieId="fsuPie"+g,e.alarmWorkBarId="alarmWorkBarId"+g,e.curTier="37",e.caches={none:{timestamp:(new Date).getTime(),getWorkerInfo:[],homeSite:{intersectionState:0,total:0},getFsuStat:[{count:0},{count:0}],getMostAlarmNameCount:{alarmNames:[],counts:[["","","","","","",""]]},getMostAlarmSiteCount:{dataResult:'{"data": []}'},getAlarmDistributionWeek:{dataResult:'{"data": []}'},getAlarmCount:{levelMap:{},confirm:0,unConfirm:0},getAlarmCountInWeek:[["","","","","","",""],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]]}},e.mapFilter={alarm:[1,1,1,1,1]},e.getFontSize=function(e,t){var a={l:[60,60,60,60,44,33,22],r:[44,44,44,44,44,33,22]},n={l:[1,1,1,1,3,2,4],r:[3,3,3,3,3,2,4]};return{fontSize:(a[e][(t+"").length]||33)+"px",marginTop:(n[e][(t+"").length]||0)+"px"}};var C=function(){function e(e,r){var o=[].map.call(arguments,function(e){return e}).slice(2),l=o.pop();n<a?t(e,r,o,l):i.push([e,r,o,l]),n++}function t(e,a,r,o){r.push(function(e){if(o(e),n--,i.length){var a=i.shift();t.apply(null,a)}}),e[a].apply(null,r)}var a=5,n=0,i=[];return{send:e}}();e.go7days=function(t,a){a.query||(a.query={}),a.query.tStart=new Date(Date.today.getTime()-Date.oneWeek),a.query.tEnd=Date.today,e.go(t,a)},window.homeJumpDelay=500,e.go=function(e,t){$(".fullscreen-wrapper")[0]&&Fullscreen.clear(),setTimeout(function(){s.go(e,t)},window.homeJumpDelay)},e.renderMap=function(){function t(e,t,a,n){this._point=e,this._overText=t,this.site=n,this.topAlarm=a}var a=e.alarmData,n=e.mapFilter;t.prototype=$.extend(new BMap.Overlay,{getPosition:function(){return this._point},getMap:function(){return this._map},initialize:function(e){this._map=e;var t=$('<div style="position:absolute;width:10px;height:10px;" class="sigle-site"><div style="pointer-events:none" class="alarm-icon level'+this.topAlarm+'"></div></div>'),a=this,n=this._div=t[0];return n.addEventListener("mouseenter",function(e){n.isHide=!1;a.detail;!function(){$("#site-detail").html("站点编号："+a.site.code+" <br/>站点名称："+a.site.name+" <br/>站点状态：FUS "+a.site.fsuState+" <br/>告警数量："+(a.site.level1+a.site.level2+a.site.level3+a.site.level4)+" <br/>经纬度："+(a.site.coordinate||"-")+" <br/>站点地址："+(a.site.address||"-")),n.isHide||$("#site-detail").show(),$("#site-detail").css({left:e.offsetX+e.pageX+"px",top:e.offsetY+e.pageY-30-$("#site-detail").height()+"px"})}()}),n.addEventListener("mouseleave",function(){n.isHide=!0,$("#site-detail").hide()}),n.addEventListener("click",function(){s.go("scene/site",{siteId:a.site.code})}),e.getPanes().labelPane.appendChild(n),n},draw:function(){var e=this._map,t=e.pointToOverlayPixel(this._point);this._div.style.top=t.y-5+"px",this._div.style.left=t.x-5+"px"}}),e.points&&e.points.dispose();var i=[],r=null;a.filter(function(e){return e.longitude&&e.latitude&&(n.alarm[0]||n.alarm[1]&&e.level1||n.alarm[2]&&e.level2||n.alarm[3]&&e.level3||n.alarm[4]&&e.level4)}).forEach(function(e){r=new BMap.Point(e.longitude,e.latitude);var a=new t(r,e.siteName,e.level1&&n.alarm[1]?1:e.level2&&n.alarm[2]?2:e.level3&&n.alarm[3]?3:e.level4&&n.alarm[4]?4:0,e);a._domElement=document.createElement("div"),a._domElement.className="alarm-icon level3",i.push(a)}),e.points=new BMapLib.MarkerClusterer(e.map,{markers:i,minClusterSize:6,isAverageCenter:!0,styles:new Array(20).join(".").split(".").map(function(e,t){var a=[70,90,110,130,150][t%5];return{size:new BMap.Size(a,a),textColor:"#051d4c"}})})},e.$watch("enterprise.refreshInterval",function(){if(void 0!==t.enterprise&&null!==t.enterprise){var a=t.enterprise.refreshInterval;void 0!==a&&null!==a&&(window.timerTaskManager.clearAll(!1),a<=0||window.timerTaskManager.create(function(){h(e.curTier)},1e3*a,!1))}}),setTimeout(function(){h("none")},10),function(){C.send(n,"getCoordinateList",function(t){e.alarmData=t,t.forEach(function(e){e.longitude=e.coordinate.split(",")[0],e.latitude=e.coordinate.split(",")[1],e.levelMap=e.levelMap||[],e.level1=e.levelMap[1]||0,e.level2=e.levelMap[2]||0,e.level3=e.levelMap[3]||0,e.level4=e.levelMap[4]||0}),document.getElementById(e.alarmMapId)&&setTimeout(function(){e.renderMap()},300)});var t=null;setTimeout(function(){e.map=createHomeMap({alarmMapId:e.alarmMapId,locateCallback:function(a){t&&clearTimeout(t),t=setTimeout(function(){e.curTier=a,h(e.curTier),t=null},50)}})},0)}()}]);