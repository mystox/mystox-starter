scloudApp.controller("homeController",["$scope","$rootScope","$filter","reportService","siteService","fsuService","alarmService","workService","$state","treeService",function(e,t,a,n,r,o,i,l,s,u){function c(t,a){function n(t){e.siteCount=t.total,e.maintenanceSiteCount=t.intersectionState}a.homeSite?n(a.homeSite):C.send(r,"homeSite",t,function(e){n(e),a.homeSite=e})}function m(){C.send(n,"getCoordinateList",function(t){e.alarmData=t,t.forEach(function(t){t.longitude=t.coordinate.split(",")[0],t.latitude=t.coordinate.split(",")[1],t.levelMap=t.levelMap||[],e.alarmLevelList.forEach(function(e,a){t["level"+(a+1)]=e.levels.reduce(function(e,a){return e+(t.levelMap[a]||0)},0)});for(var a=e.alarmLevelList;a<8;a++)t["level"+(a+1)]=0}),document.getElementById(e.alarmMapId)&&setTimeout(function(){e.renderMap()},300)});var t=null;setTimeout(function(){e.map=createHomeMap({alarmMapId:e.alarmMapId,locateCallback:function(a){t&&clearTimeout(t),t=setTimeout(function(){e.curTier=a,g(e.curTier),t=null},50)}})},0)}function d(t,a){function r(t){if(e.checkedCounts=t.confirm,e.uncheckedCounts=t.unConfirm,e.alarmLevelList){e.alarmLevelList.forEach(function(e){e.value=e.levels.reduce(function(e,a){return e+(t.levelMap[a]||0)},0)});var a=Math.max.apply(0,e.alarmLevelList.map(function(e){return e.value}));e.alarmLevelList.forEach(function(e){e.value=a>0?e.value:0,e.percent=(100*e.value/a).toFixed(2)})}}a.getAlarmCount?r(a.getAlarmCount):C.send(n,"getAlarmCount",t,{},function(e){a.getAlarmCount=e,r(e)})}function p(t,a){function n(t){e.fsu=t,document.getElementById(e.fsuPieId)&&chart.fsuPie({id:e.fsuPieId,onlineCount:t[0]&&t[0].count||0,offlineCount:t[1]&&t[1].count||0})}a.getFsuStat?n(a.getFsuStat):C.send(o,"getFsuStat",t,function(e){a.getFsuStat=e,n(e)})}function f(a,n){function r(a){e.workInfoCounts=a;var n=t.CONST.alarmColorList;if(a&&0!==a.length){var r=Math.max(a[0],a[5]);({list:[{name:"未接工单",counts:[{type:"告警工单",count:a[1],url:"operation/workList",state:"待接单"},{type:"巡检工单",count:a[6],url:"operation/examine",state:"未开始"}],colors:[n[0],n[1]],searchObj:{state:["待接单","未开始"]}},{name:"在途工单",counts:[{type:"告警工单",count:a[2],url:"operation/workList",state:"待办工单"},{type:"巡检工单",count:a[7],url:"operation/examine",state:"巡检中"}],colors:[n[0],n[1]],searchObj:{state:["待处理","巡检中"]}},{name:"历史工单",counts:[{type:"告警工单",count:a[3],url:"operation/workList",state:"历史工单"},{type:"巡检工单",count:a[8],url:"operation/examine",state:"已完成"}],colors:[n[0],n[1]],searchObj:{state:["历史工单","已完成"]}},{name:"超时工单",counts:[{type:"告警工单",count:a[4],url:"operation/workList",state:"未完成",isOverTime:"是"},{type:"巡检工单",count:a[9],url:"operation/examine",state:"未完成",isOverTime:"是"}],colors:[n[0],n[1]],searchObj:{state:[""]}}],allInfoList:[{name:"告警工单",value:a[0],percent:parseInt(100*a[0]/r),color:n[0],url:"operation/workList"},{name:"巡检工单",value:a[5],percent:parseInt(100*a[5]/r),color:n[1],url:"operation/examine"}]})}document.getElementById(e.alarmWorkBarId)&&chart.workBar({id:e.alarmWorkBarId,xAxis:{data:["未接工单","在途工单","超时工单","历史工单"]},data:[a[1],a[2],a[4],a[3]],LinearGradientColors:[{offset:0,color:"#FF5050"},{offset:1,color:"#FF003C"}],handleClickBar:function(t){e.goOneMonth&&e.goOneMonth("SDGD/operation/workList",{query:{state:t.name}})}})}n.getWorkerInfo?r(n.getWorkerInfo):C.send(l,"getWorkStatic",{tierCode:a},function(e){n.getWorkerInfo=[e.noReceive,e.onRoad,e.overTime,e.history],r(n.getWorkerInfo)})}function v(t,a){function r(t){t=JSON.parse(t.dataResult).data,e.alarmSiteList=new Array(10).join(".").split(".").map(function(e,a){return{key:t[a]?t[a][0]:"暂无",value:t[a]?t[a][1]:0}})}if(a.getMostAlarmSiteCount)r(a.getMostAlarmSiteCount);else{var o={dataType:"json",operaCode:"report_homeAlarmCount",reportServerCode:"REPORTS_SERVER_1.0.0",enterpriseCode:e.user.enterpriseCode,serverCode:e.user.serverCode,executorType:"query",condition:{stationList:[],statisticLevel:"站点级",timePeriod:{startTime:Date.today.getTime()-Date.oneMonth,endTime:Date.today.getTime()}}},i=function(){o.condition.stationList=e.alarmData.filter(function(e){return 0===e.tierCode.indexOf(t)}).map(function(e){return e.code}),C.send(n,"getMostAlarmSiteCount",o,function(e){if(a.getMostAlarmSiteCount=e,r(e),e.length>0){var t=e.slice(0,3).map(function(e){return e.site.strId});C.send(n,"alarmSiteHistory",{siteIds:t},function(e){e.sort(function(e,a){return t.indexOf(e.site.strId)-t.indexOf(a.site.strId)}),a.alarmSiteHistory=e})}})};!function t(){e.alarmData?i():setTimeout(function(){t()},50)}()}}function h(t,a){function r(t){if(document.getElementById(e.alarmDistributionId)){t=JSON.parse(t.dataResult).data;var a=new Array(8).join(".").split(".").map(function(e,a){return t[a]?t[a][1]:"-"}),n={id:e.alarmDistributionId,xAxis:{data:new Array(8).join(".").split(".").map(function(e,a){return t[a]?t[a][0]:"-"})},series:{data:a,pinData:a},callback:function(e){s.go("ZKSDGD/SDGD_alarmList",{tierName:document.getElementById("location").innerText.replace("中国,","").replace(",","-")+"-"+e.replace(/\s*/g,""),startView:"history",tStart:new Date(Date.today.getTime()-Date.oneMonth),tEnd:Date.today})}};chart.alarmTierTop5ForHome(n)}}if(a.getAlarmDistributionWeek)r(a.getAlarmDistributionWeek);else{var o={dataType:"json",operaCode:"report_homeAlarmCount",reportServerCode:"REPORTS_SERVER_1.0.0",enterpriseCode:e.user.enterpriseCode,serverCode:e.user.serverCode,executorType:"query",condition:{stationList:[],statisticLevel:"省级",timePeriod:{startTime:Date.today.getTime()-Date.oneMonth,endTime:Date.today.getTime()}}},i=function(){o.condition.stationList=e.alarmData.filter(function(e){return 0===e.tierCode.indexOf(t)}).map(function(e){return e.code}),o.condition.statisticLevel="none"===t?"省级":2===(t||"").length?"市级":4===(t||"").length?"区县级":"站点级",C.send(n,"getMostAlarmSiteCount",o,function(e){a.getMostAlarmSiteCount=e,r(e)})};!function t(){e.alarmData?i():setTimeout(function(){t()},50)}()}}function g(t){var a;e.caches[t||"all"]&&(new Date).getTime()<e.caches[t||"all"].timestamp+3e5?a=e.caches[t||"all"]:(a={timestamp:(new Date).getTime()},e.caches[t||"all"]=a),c(t,e.caches[t||"all"]),d(t,e.caches[t||"all"]),p(t,e.caches[t||"all"]),f(t,e.caches[t||"all"]),v(t,e.caches[t||"all"]),h(t,e.caches[t||"all"])}s&&(s=window.$state),$stateParams&&($stateParams=window.$stateParams);var y=Math.floor((new Date).getTime()/1e3);e.alarmMapId="alarmMap"+y,e.fsuStatId="fsuStat"+y,e.alarmSiteBarId="alarmSiteBar"+y,e.alarmLineId="alarmLine"+y,e.alarmDistributionId="alarmDistribution"+y,e.fsuPieId="fsuPie"+y,e.alarmWorkBarId="alarmWorkBarId"+y,e.curTier="37",e.caches={none:{timestamp:(new Date).getTime(),getWorkerInfo:[],homeSite:{intersectionState:0,total:0},getFsuStat:[{count:0},{count:0}],getMostAlarmNameCount:{alarmNames:[],counts:[["","","","","","",""]]},getMostAlarmSiteCount:{dataResult:'{"data": []}'},getAlarmDistributionWeek:{dataResult:'{"data": []}'},getAlarmCount:{levelMap:{},confirm:0,unConfirm:0},getAlarmCountInWeek:[["","","","","","",""],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]]}},e.mapFilter={alarm:[1,1,1,1,1,1,1,1,1]},e.getFontSize=function(e,t){var a={l:[60,60,60,60,44,33,22],r:[44,44,44,44,44,33,22]},n={l:[1,1,1,1,3,2,4],r:[3,3,3,3,3,2,4]};return{fontSize:(a[e][(t+"").length]||33)+"px",marginTop:(n[e][(t+"").length]||0)+"px"}};var C=function(){function e(e,o){var i=[].map.call(arguments,function(e){return e}).slice(2),l=i.pop();n<a?t(e,o,i,l):r.push([e,o,i,l]),n++}function t(e,a,o,i){o.push(function(e){if(i(e),n--,r.length){var a=r.shift();t.apply(null,a)}}),e[a].apply(null,o)}var a=5,n=0,r=[];return{send:e}}();e.goOneMonth=function(t,a){a.query||(a.query={}),a.query.tStart=new Date(Date.today.getTime()-Date.oneMonth),a.query.tEnd=Date.today,e.go(t,a)},e.go7days=function(t,a){a.query||(a.query={}),a.query.tStart=new Date(Date.today.getTime()-Date.oneWeek),a.query.tEnd=Date.today,e.go(t,a)},window.homeJumpDelay=500,e.go=function(t,a){$(".fullscreen-wrapper")[0]&&Fullscreen.clear(),setTimeout(function(){a.tier=e.curTier,s.go(t,a)},window.homeJumpDelay)},e.renderMap=function(){function t(e,t,a,n){this._point=e,this._overText=t,this.site=n,this.topAlarm=a}var a=e.alarmData,n=e.mapFilter;t.prototype=$.extend(new BMap.Overlay,{getPosition:function(){return this._point},getMap:function(){return this._map},initialize:function(e){this._map=e;var t=$('<div style="position:absolute;width:10px;height:10px;" class="sigle-site"><div style="pointer-events:none" class="alarm-icon level'+this.topAlarm+'"></div></div>'),a=this,n=this._div=t[0];return n.addEventListener("mouseenter",function(e){n.isHide=!1;a.detail;!function(){$("#site-detail").html("站点编号："+a.site.code+" <br/>站点名称："+a.site.name+" <br/>站点状态：FUS "+a.site.fsuState+" <br/>告警数量："+Object.keys(a.site.levelMap).reduce(function(e,t){return(a.site.levelMap[t]||0)+e},0)+" <br/>经纬度："+(a.site.coordinate||"-")+" <br/>站点地址："+(a.site.address||"-")),n.isHide||$("#site-detail").show(),$("#site-detail").css({left:e.offsetX+e.pageX+"px",top:e.offsetY+e.pageY-30-$("#site-detail").height()+"px"})}()}),n.addEventListener("mouseleave",function(){n.isHide=!0,$("#site-detail").hide()}),n.addEventListener("click",function(){s.go("scene/site",{siteId:a.site.code})}),e.getPanes().labelPane.appendChild(n),n},draw:function(){var e=this._map,t=e.pointToOverlayPixel(this._point);this._div.style.top=t.y-5+"px",this._div.style.left=t.x-5+"px"}}),e.points&&e.points.dispose();var r=[],o=null;a.filter(function(e){return e.longitude&&e.latitude&&(n.alarm[0]||n.alarm[1]&&e.level1||n.alarm[2]&&e.level2||n.alarm[3]&&e.level3||n.alarm[4]&&e.level4||n.alarm[5]&&e.level5||n.alarm[6]&&e.level6||n.alarm[7]&&e.level7||n.alarm[8]&&e.level8)}).forEach(function(e){o=new BMap.Point(e.longitude,e.latitude);var a=new t(o,e.siteName,e.level1&&n.alarm[1]?1:e.level2&&n.alarm[2]?2:e.level3&&n.alarm[3]?3:e.level4&&n.alarm[4]?4:e.level4&&n.alarm[5]?5:e.level4&&n.alarm[6]?6:e.level4&&n.alarm[7]?7:e.level4&&n.alarm[8]?8:0,e);a._domElement=document.createElement("div"),a._domElement.className="alarm-icon level3",r.push(a)}),e.points=new BMapLib.MarkerClusterer(e.map,{markers:r,minClusterSize:6,isAverageCenter:!0,styles:new Array(40).join(".").split(".").map(function(e,t){var a=[70,90,110,130,150][t%5];return{size:new BMap.Size(a,a),textColor:"#051d4c"}})})},e.$watch("enterprise.refreshInterval",function(){if(void 0!==t.enterprise&&null!==t.enterprise){var a=t.enterprise.refreshInterval;void 0!==a&&null!==a&&(window.timerTaskManager.clearAll(!1),a<=0||window.timerTaskManager.create(function(){g(e.curTier)},1e3*a,!1))}}),setTimeout(function(){g("none")},10),function(){i.getAlarmLevelList({enterpriseCode:e.user.enterpriseCode,serverCode:e.user.serverCode},function(t,a){if(a){e.alarmLevelList=a,d("none",e.caches.none),m();var n="";e.alarmLevelList.forEach(function(e,t){n+="\n                    .alarm-icon.level"+(t+1)+":before{background-color: "+e.color+";}\n                    .alarm-icon.level"+(t+1)+":after{background-color: "+e.color+";}\n                    "});var r=document.createElement("style");r.innerHTML=n,document.head.append(r)}})}()}]);