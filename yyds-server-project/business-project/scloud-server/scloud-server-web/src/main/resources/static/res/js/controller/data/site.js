scloudApp.controller("dataSiteController",["$scope","$rootScope","$stateParams","treeService","signalService","deviceService","$state",function(e,i,n,t,a,s,r){function o(n){var a=t.getCheckedNode(n);if(!a)return i.notify({type:"warn",text:"请选择一个站点"}),void(e.currentSite=null);e.currentSite=a,g(),e.$apply()}function c(){a.getSignalListBySignalTypeAndDeviceType({signalType:1},function(i){e.signalList=i,e.signalQuery.signal=i[0],e.deviceSignalList={},e.deviceTypeList.forEach(function(n){e.deviceSignalList["device"+n.code]=i.filter(function(e){return e.deviceCode===n.code})}),e.deviceSignalList=e.deviceSignalList.__filter(function(e){return e.length}),e.deviceTypeList=e.deviceTypeList.filter(function(i){return e.deviceSignalList["device"+i.code]&&e.deviceSignalList["device"+i.code].length>0})})}function g(){e.currentSite&&(e.isLoading=!0,s.getDeviceListOnSite({siteCodes:[e.currentSite.code],serverCode:"TOWER_SERVER_1.0.0",deviceCode:e.deviceQuery.code||void 0,deviceName:e.deviceQuery.name||void 0,currentPage:1,pageSize:999999},function(i){e.isLoading=!1,e.deviceListAll=i.list,e.paginationConf.totalItems=i.list.length;var n=t.getCheckedNode("areaTree").name;i.list.forEach(function(e){e.siteName=n}),l()},function(){e.isLoading=!1}))}function l(){var i=e.paginationConf.currentPage,n=e.paginationConf.itemsPerPage;e.deviceList=(e.deviceListAll||[]).slice((i-1)*n,i*n)}function d(){e.signalQuery.tierCodes=e.signalQuery.siteIds=e.signalQuery.siteIds2=void 0;var n=t.getCheckedTierCodesAndSiteIds("checkboxTree",e.zTree.zNodes);if(n.siteIds.length>0&&(e.signalQuery.siteIds2=n.siteIds),e.signalQuery.tierCodes=n.codes,0===e.signalQuery.tierCodes.length&&(e.signalQuery.siteIds=e.signalQuery.siteIds2,e.signalQuery.siteIds2=void 0),!(e.signalQuery.siteIds&&0!==e.signalQuery.siteIds.length||e.signalQuery.tierCodes&&0!==e.signalQuery.tierCodes.length||e.signalQuery.siteIds2&&0!==e.signalQuery.siteIds2.length))return void i.notify({type:"warn",text:"请选择站点"});var a=e.signalQuery.__get("siteIds","tierCodes","siteIds2","deviceCode","deviceName");return a.signalCode=e.signalQuery.signal.signalCode,a.pageSize=999999,a.currentPage=1,a.serverCode="TOWER_SERVER_1.0.0",a}function u(){var i=e.signalQuery.signal.signalName,n=d();n&&(e.singleIsLoading=!0,a.realTimeDataGetSignalDiInfo(n,function(n){e.signalValueListAll=n.list,e.signalPaginationConf.totalItems=n.list.length,e.singleIsLoading=!1,e.lastSignalName=i,f()}))}function f(){var i=e.signalPaginationConf.itemsPerPage,n=e.signalPaginationConf.currentPage;e.signalValueList=e.signalValueListAll.slice((n-1)*i,n*i)}r&&(r=window.$state),n&&(n=window.$stateParams),e.deviceQuery=n.dataDeviceData&&n.dataDeviceData.deviceQuery||{},e.signalQuery={},e.systemList={},e.currentSelectedDevice=null,e.isLoading=!1,e.paginationConf=n.dataDeviceData&&n.dataDeviceData.paginationConf||{currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.singleIsLoading=!1,e.signalPaginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.tabPage=i.util.tabPage.getInstance(["设备列表","遥测信号点统计表"]),e.searchKey={online:!0,offline:!0,keyword:""},e.getNodesByParamFuzzy=function(){setTimeout(function(){e.checkboxTree.getNodesByParamFuzzy(e.searchKey,"checkboxTree","checkboxSiteTree"),e.zTree.getNodesByParamFuzzy(e.searchKey,"areaTree","radioSiteTree",function(){o("areaTree")})},10)},e.query=function(){g()},e.reset=function(){e.deviceQuery={}},e.exportSignalValueList=function(){var i=d();i&&(a.exportSignalDiInfo(i,function(){}),e.exportSignalValueList.have=!1)},e.exportSignalValueList.have=!0,e.exportSignalValuePdf=function(){var i=d();i&&(a.exportSignalDiInfoPdf(i,function(){}),e.exportSignalValuePdf.have=!1)},e.exportSignalValuePdf.have=!0,e.doSignalValueQuery=function(){u()},e.signalValueReset=function(){e.signalQuery={signal:e.signalList[0]}},e.onDeviceTypeChange=function(){e.signalQuery.signal=e.signalQuery.deviceType?e.deviceSignalList["device"+e.signalQuery.deviceType.code][0]:e.signalList[0]},e.openDevice=function(e){sessionStorage.setItem("data/device/device",JSON.stringify(e)),r.go("SDGD/data/device",{dataSiteData:{deviceQuery:this.deviceQuery,paginationConf:this.paginationConf},parentPage:"dataSite"}),i.util.browserInfo.isIE&&window.location.reload()},function(){e.treeLoading=!0,t.getSiteMapTree({serverCode:"TOWER_SERVER_1.0.0"},function(i){e.treeLoading=!1;var a=angular.copy(i);e.zTree=t.createZTree(i),e.checkboxTree=t.createZTree(a),t.initTree(e.zTree.zNodes,"areaTree","radioSiteTree",function(){o("areaTree")}),t.initTree(e.checkboxTree.zNodes,"checkboxTree","checkboxSiteTree"),t.checkedAllNodes("checkboxTree",!0),t.checkNodeBySiteId("areaTree",n.siteId),e.$watch("signalPaginationConf.currentPage + signalPaginationConf.itemsPerPage",f),e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",l),u()})}(),function(){s.getSystemNameList(null,function(i){e.systemList=i})}(),function(){s.getSpecialDeviceTypeCode(function(i){e.specialDevice=i})}(),function(i){s.getDeviceTypeList(i,function(i){e.deviceTypeList=i,c()})}()}]);