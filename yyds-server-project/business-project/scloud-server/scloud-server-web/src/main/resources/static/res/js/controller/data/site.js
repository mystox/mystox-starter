scloudApp.controller("dataSiteController",["$scope","$rootScope","$stateParams","treeService","signalService","deviceService","$state",function(e,i,n,t,a,r,o){function s(n){var a=t.getCheckedNode(n);if(!a)return i.notify({type:"warn",text:"请选择一个站点"}),void(e.currentSite=null);e.currentSite=a,c(),e.$apply()}function c(){e.currentSite&&(e.isLoading=!0,r.getDeviceListOnSite({siteCodes:[e.currentSite.code],serverCode:e.user.serverCode,deviceCode:e.deviceQuery.code||void 0,deviceName:e.deviceQuery.name||void 0,deviceTypeCode:e.deviceQuery.deviceTypeCode,currentPage:1,pageSize:999999},function(i){e.isLoading=!1,e.deviceListAll=i.list,e.paginationConf.totalItems=i.list.length;var n=t.getCheckedNode("areaTree").name;i.list.forEach(function(e){e.siteName=n}),d()},function(){e.isLoading=!1}))}function d(){var i=e.paginationConf.currentPage,n=e.paginationConf.itemsPerPage;e.deviceList=(e.deviceListAll||[]).slice((i-1)*n,i*n)}function g(){e.signalQuery.tierCodes=e.signalQuery.siteIds=e.signalQuery.siteIds2=void 0;var n=t.getCheckedTierCodesAndSiteIds("checkboxTree",e.zTree.zNodes);if(n.siteIds.length>0&&(e.signalQuery.siteIds2=n.siteIds),e.signalQuery.tierCodes=n.codes,0===e.signalQuery.tierCodes.length&&(e.signalQuery.siteIds=e.signalQuery.siteIds2,e.signalQuery.siteIds2=void 0),!(e.signalQuery.siteIds&&0!==e.signalQuery.siteIds.length||e.signalQuery.tierCodes&&0!==e.signalQuery.tierCodes.length||e.signalQuery.siteIds2&&0!==e.signalQuery.siteIds2.length))return void i.notify({type:"warn",text:"请选择站点"});var a=e.signalQuery.__get("siteIds","tierCodes","siteIds2","deviceCode","deviceName");return a.signalCode=e.signalQuery.signal,a.pageSize=999999,a.currentPage=1,a.deviceTypeCode=e.signalQuery.deviceTypeCode?e.signalQuery.deviceTypeCode.code:void 0,a.serverCode=e.user.serverCode,a}function l(){var i=g();i&&(e.singleIsLoading=!0,a.realTimeDataGetSignalDiInfo(i,function(i){e.signalValueListAll=i.list,e.signalPaginationConf.totalItems=i.list.length,e.singleIsLoading=!1,u()}))}function u(){var i=e.signalPaginationConf.itemsPerPage,n=e.signalPaginationConf.currentPage;e.signalValueList=e.signalValueListAll.slice((n-1)*i,n*i)}o&&(o=window.$state),n&&(n=window.$stateParams),e.deviceQuery=n.dataDeviceData&&n.dataDeviceData.deviceQuery||{},e.signalQuery={},e.systemList={},e.currentSelectedDevice=null,e.isLoading=!1,e.paginationConf=n.dataDeviceData&&n.dataDeviceData.paginationConf||{currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.singleIsLoading=!1,e.signalPaginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.tabPage=i.util.tabPage.getInstance(["设备列表","遥测信号点统计表"]),e.searchKey={online:!0,offline:!0,keyword:""},e.getNodesByParamFuzzy=function(){setTimeout(function(){e.checkboxTree.getNodesByParamFuzzy(e.searchKey,"checkboxTree","checkboxSiteTree"),e.zTree.getNodesByParamFuzzy(e.searchKey,"areaTree","radioSiteTree",function(){s("areaTree")})},10)},e.query=function(){c()},e.reset=function(){e.deviceQuery={}},e.exportSignalValueList=function(){var i=g();i&&(a.exportSignalDiInfo(i,function(){}),e.exportSignalValueList.have=!1)},e.exportSignalValueList.have=!0,e.exportSignalValuePdf=function(){var i=g();i&&(a.exportSignalDiInfoPdf(i,function(){}),e.exportSignalValuePdf.have=!1)},e.exportSignalValuePdf.have=!0,e.doSignalValueQuery=function(){l()},e.signalValueReset=function(){e.signalQuery={signal:e.signalList[0]}},e.openDevice=function(e){sessionStorage.setItem("data/device/device",JSON.stringify(e)),o.go("SDGD/data/device",{dataSiteData:{deviceQuery:this.deviceQuery,paginationConf:this.paginationConf},parentPage:"dataSite"}),i.util.browserInfo.isIE&&window.location.reload()},function(){r.getDeviceTypeList(null,function(i){e.deviceTypeList=i})}(),function(){e.treeLoading=!0,t.getSiteMapTree({serverCode:e.user.serverCode},function(i){e.treeLoading=!1;var a=angular.copy(i);e.zTree=t.createZTree(i),e.checkboxTree=t.createZTree(a),t.initTree(e.zTree.zNodes,"areaTree","radioSiteTree",function(){s("areaTree")}),t.initTree(e.checkboxTree.zNodes,"checkboxTree","checkboxSiteTree"),t.checkedAllNodes("checkboxTree",!0),t.checkNodeBySiteId("areaTree",n.siteId),e.$watch("signalPaginationConf.currentPage + signalPaginationConf.itemsPerPage",u),e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",d),l()})}()}]);