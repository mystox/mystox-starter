scloudApp.controller("configSiteController",["$scope","$rootScope","treeService","siteService","fileUploadService","userService",function(e,t,i,o,a,n){function r(){e.treeLoading=!0,i.getTierTree(null,function(t){e.treeLoading=!1,e.zTree=i.createZTree(t),i.initTree(e.zTree.zNodes,"areaTree","checkboxTierTree"),i.checkedAllNodes("areaTree",!0),e.query()})}function d(){null!==e.siteQuery.tierCodes&&0!==e.siteQuery.tierCodes.length&&(e.isLoading=!0,o.getSiteList(e.paginationConf,e.siteQuery,function(t){e.isLoading=!1,e.siteList=t.list,e.paginationConf.totalItems=t.count},function(){e.isLoading=!1}))}function l(o){var a=i.getCheckedNode(o);if(!a)return void t.notify({type:"warn",text:"请选择一个站点分级"});e.addSite.obj.tierCode=i.getParentCode(a);var n=[];e.addSite.obj.tierString=i.getParentName(a,n),e.addSite.obj.tier=n,e.toggleNavTree(),e.$apply()}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.siteQuery={tierCodes:[]},e.currentModifySiteObj={},e.addResources={form:{},obj:{},toModal:null,execute:null,select:null,clear:null,loading:!1},e.deleteSite={form:{},obj:{},toModal:null,execute:null,clear:null},e.isLoading=!1,e.paginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.shareInfoList=["移动","电信","联通","移动电信","电信联通","移动联通","移动电信联通"],e.approvalStatusList=["在建","竣工","存量"],e.towerTypeList=["插接式单管塔","外法兰单管塔","一体化","仿生树","三管塔","角钢塔","楼顶装饰塔","增高架桅杆","拉线塔","灯杆塔"],e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",d),e.isSelectAll=!1,e.selectAll=function(t){e.siteList.forEach(function(e){e.isSelected=t})},e.getNodesByParamFuzzy2=function(t,i,o){e.zTree2.getNodesByParamFuzzy(t,i,o,function(){l("areaTree2")})},e.query=function(){e.siteQuery.tierCodes=i.getCheckedTierCodes("areaTree"),d()},e.reset=function(){e.siteQuery={tierCodes:e.siteQuery.tierCodes}},e.addSite={form:{},obj:{tier:[]},status:"",title:"",toModal:function(t,i){if(this.status=t,this.title={add:"增加站点",modify:"修改站点",detail:"站点详情"}[t],i&&(this.obj=angular.copy(i),this.obj.platform&&this.obj.platform.forEach(function(t,i){e.addSite.obj["platform"+i]=t}),"detail"===this.status)){var a=this;o.siteDetail(this.obj.code,function(e){var t=i.fsuState;$.extend(i,e.site),i.fsuState=t,a.obj.maintainerList=i.maintainerList=e.maintainerList})}$("#addSiteModal").modal("show")},execute:function(){switch(this.obj.platform=new Array(4).join(".").split(".").map(function(t,i){return e.addSite.obj["platform"+i]}),this.status){case"add":o.addSite(e.addSite.obj,t.enterprise.id,function(){e.addSite.clear(),r()});break;case"modify":o.modifySite(this.obj,function(){d()})}this.clear()},clear:function(){e.addSite.form.$setPristine(),e.addSite.obj={tier:[]},$("#addSiteModal").modal("hide")},deleteMaintainer:function(e){var t=this;o.deleteMaintainer({siteId:t.obj.id,maintainerIds:[e.id]},function(){t.toModal("detail",t.obj)})}},e.uploadImage={toModal:function(t){e.uploadImageModalMaskShow=!0,this.fileUpload=a.getFileUpload(),this.fileUpload.onFileSelectCallback=function(){e.uploadImage.fileUrl=e.uploadImage.fileUpload.getFileUrl(),setTimeout(function(){e.$apply()},300)},$("#uploadImageModal").modal("show")},execute:function(){this.fileUpload.upload("/siteFunc/importSiteImage/"+e.addSite.obj.id,function(i){if(e.uploadImage.clear(),!1===i.success)return void t.notify({type:"error",text:"上传失败<br/>"+i.info});t.notify({type:"success",text:"上传成功"})})},select:function(){this.fileUpload.selectFile("uploadImageFileUploadBtn")},clear:function(){e.uploadImageModalMaskShow=!1,this.fileUpload.clear(),this.fileUrl=[],$("#uploadImageModal").modal("hide")}},e.coordPickerModal={toModal:function(){$("#coordPickerModal").modal("show"),e.addSite.showMap=!0},execute:function(){e.coordPickerModal.clear()},clear:function(){e.addSite.showMap=!1,$("#coordPickerModal").modal("hide")}},e.userBind={toModal:function(){if(0===e.siteList.filter(function(e){return e.isSelected}).length)return void t.notify({type:"warn",text:"请至少选择一个战点"});$("#userBindModal").modal("show")},clear:function(){$("#userBindModal").modal("hide")},execute:function(){var t=e.siteList.filter(function(e){return e.isSelected}),a=i.getCheckedNodes("userBindTree").filter(function(e){return"username"in e}),n={siteCodeList:t.map(function(e){return e.code}),siteNameList:t.map(function(e){return e.name}),maintainerIds:a.map(function(e){return e.id})};o.setMaintainers(n,function(){e.selected=!1,e.siteList.forEach(function(e){e.isSelected=!1}),i.checkedAllNodes("userBindTree",!1)}),this.clear()}},e.showImage=function(){e.showSIteimage=!0,$("#imageShowModal").modal("show")},e.hidemage=function(){e.showSIteimage=!1,$("#imageShowModal").modal("hide")},e.deleteSite.toModal=function(t){e.deleteSite.obj=t,$("#deleteSiteModal").modal("show")},e.deleteSite.execute=function(){$("#deleteSiteModal").modal("hide"),o.deleteSite(e.deleteSite.obj.id,function(){d(),r(),e.deleteSite.clear()})},e.deleteSite.clear=function(){e.deleteSite.form.$setPristine(),$("#deleteSiteModal").modal("hide")},e.addResources.toModal=function(){$("#addResourcesModal").modal("show"),e.fileUpload=a.getFileUpload()},e.addResources.select=function(){e.fileUpload.selectFile("fileUploadBtn")},e.addResources.execute=function(){e.addResources.loading=!0,e.fileUpload.upload("/siteFunc/addMultiResource",function(i){if(e.addResources.loading=!1,e.addResources.clear(),!1===i.success)return void t.notify({type:"error",text:"导入失败<br/>"+i.info});t.notify({type:"success",text:"导入成功"}),d(),r()},function(){e.addResources.loading=!1,e.addResources.clear(),console.error("请求失败")})},e.addResources.clear=function(){$("#addResourcesModal").modal("hide"),e.fileUpload.files=null,e.fileUpload.info={id:null,name:null,url:null,size:null,progress:null}},e.exportSiteList=function(){e.exportSiteList.have=!1,null!==e.siteQuery.tierCodes&&0!==e.siteQuery.tierCodes.length&&o.exportSiteList(e.paginationConf,e.siteQuery)},e.exportSiteList.have=!0,e.exportSiteListPdf=function(){e.exportSiteListPdf.have=!1,null!==e.siteQuery.tierCodes&&0!==e.siteQuery.tierCodes.length&&o.exportSiteListPdf(e.paginationConf,e.siteQuery)},e.exportSiteListPdf.have=!0,function(){e.target2=t.util.getToggleParam(null,[".nav-tree-sm"],{left:"0"},{left:"-232px"})}(),r(),function(){e.treeLoading2=!0,i.getUserTierTree(null,function(t){e.treeLoading2=!1,e.zTree2=i.createZTree(t),i.initTree(e.zTree2.zNodes,"areaTree2","radioTierTree",function(){l("areaTree2")})})}(),function(){i.getMaintainerTree(function(t){e.userBindTree=i.createZTree(t),i.initTree(e.userBindTree.zNodes,"userBindTree","checkboxSiteTree")})}()}]);