scloudApp.controller("alarmShieldController",["$scope","$rootScope","treeService","alarmShieldService","deviceService","alarmService",function(e,t,n,a,i,o){function l(){e.isLoading=!0,a.getRuleList(e.paginationConf,e.ruleQuery,function(t){e.isLoading=!1,e.ruleList=t.list,e.paginationConf.totalItems=t.count,e.ruleList&&e.ruleList[0]&&(e.currentRuleId=e.ruleList[0].id,d()),e.openDetailIndex=null},function(){e.isLoading=!1})}function d(){e.currentRuleId&&(e.isLoading2=!0,a.getShieldAlarmList(e.paginationConf2,e.currentRuleId,function(t){e.isLoading2=!1,e.shieldList=t.list,e.paginationConf2.totalItems=t.count},function(){e.isLoading2=!1}))}function r(){for(var t=[],n=e.addRule.obj.alarmLevels,a=0;a<n.length;a++)t.push(n[a].id);return t}function u(t,n){i.getDeviceListOnSite({siteCodes:[t.code],serverCode:e.user.serverCode,currentPage:1,pageSize:999999},function(a){for(var i=0;i<a.list.length;i++)a.list[i].siteName=t.name;e.addRule.obj.deviceList=a.list,n&&n(a.list)})}function c(){for(var t=[],n=e.addRule.obj.selectedDeviceList,a=0;a<n.length;a++)t[a]=n[a].code;return t}$state&&($state=window.$state),$stateParams&&($stateParams=window.$stateParams),e.ruleQuery={enabled:null},e.addRule={form:{},obj:{alarmLevels:[],deviceList:[],addDevice:[],removeDevice:[],selectedDeviceList:[],deviceIds:[]},toModal:null,execute:null,clear:null},e.addTimeRange={form:{},obj:{},toModal:null,execute:null,clear:null},e.deleteRule={form:{},obj:{},toModal:null,execute:null,clear:null},e.isLoading=!1,e.isLoading2=!1,e.paginationConf={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.$watch("paginationConf.currentPage + paginationConf.itemsPerPage",l),e.paginationConf2={currentPage:1,itemsPerPage:15,pagesLength:9,onChange:function(){}},e.$watch("paginationConf2.currentPage + paginationConf2.itemsPerPage",d),e.query=function(){l()},e.getShieldAlarmList=function(t){e.currentRuleId=t,d()},e.addRule.toModal=function(t,n){n.stopPropagation(),e.addRule.obj=Object.assign({},t),e.addRule.obj.alarmLevels=e.alarmLevelList.data.filter(function(e){return t.alarmlevelList.indexOf(e.id)>-1});var a=t.deviceInfoList.map(function(e){return e.split(":")[0]+"-"+e.split(":")[1]}).unique(),i=$.fn.zTree.getZTreeObj("areaTree");a.forEach(function(n){var a=i.getNodeByParam("level",0);n.split("-").forEach(function(e){a=a.nextTier.find(function(t){return t.name===e})}),a&&u(a,function(n){e.addRule.obj.selectedDeviceList=(e.addRule.obj.selectedDeviceList||[]).concat(n.filter(function(e){return t.deviceCodeList.indexOf(e.code)>-1}))})}),e.UPDATE_MODE="MODIFY"},e.addRule.execute=function(){var t={id:e.addRule.obj.id,name:e.addRule.obj.name,deviceCodeList:c(),serverCode:e.user.serverCode,alarmlevelList:r(),reason:e.addRule.obj.reason,deviceInfoList:e.addRule.obj.selectedDeviceList.map(function(e){return e.tierName+":"+e.siteName+":"+e.name})},n="MODIFY"===e.UPDATE_MODE?"updateRule":"addRule";a[n](t,function(){e.addRule.clear(),l()})},e.addRule.clear=function(){e.addRule.form.$setPristine(),e.UPDATE_MODE="ADD",e.addRule.obj={alarmLevels:[],deviceList:[],addDevice:[],removeDevice:[],selectedDeviceList:[],deviceIds:[]}},e.addTimeRange.toModal=function(t,n){n.stopPropagation(),e.getTimeRanges(t.id),e.aaa=t.id,e.addTimeRange.obj.ruleName=t.name,e.addTimeRange.obj.ruleId=t.id,$("#addTimeRangeModal").modal("show")},e.addTimeRange.execute=function(){a.addTimer(e.addTimeRange.obj.ruleId,e.addTimeRange.obj.tStart,e.addTimeRange.obj.tEnd,function(){e.getTimeRanges(e.addTimeRange.obj.ruleId)})},e.addTimeRange.clear=function(){e.addTimeRange.form.$setPristine(),e.addTimeRange.obj={},$("#addTimeRangeModal").modal("hide")},e.getTimeRanges=function(t){a.getTimerForRule(t,function(t){e.addTimeRange.obj.timeRanges=t})},e.deleteTimeRange=function(t){a.deleteTimer(t,function(){e.getTimeRanges(e.addTimeRange.obj.ruleId)})},e.getRuleDetail=function(t,n,a){a.stopPropagation(),e.openDetailTab(n),e.ruleDetail={device:t.deviceInfoList,reason:t.reason,alarmlevelList:t.alarmlevelList}},e.openDetailTab=function(t){e.openDetailIndex===t?e.openDetailIndex=null:e.openDetailIndex=t},e.getNodesByParamFuzzy=function(t,n,a){e.zTree.getNodesByParamFuzzy(t,n,a,function(){e.getCheckedNodeInSelect("areaTree")})},e.getCheckedNodeInSelect=function(t){var a=n.getCheckedNode(t);if(!a)return e.addRule.obj.deviceList=[],void e.$apply();u(a)},e.multiSelect={add:function(e,t){!e||e.length<1||(!1===t.containsObj(e[0])&&(t[t.length]=e[0]),e=[])},remove:function(e,t){!e||e.length<1||(t.removeObj(e[0]),e=[])}},e.deleteRule.toModal=function(t,n){n.stopPropagation(),e.deleteRule.obj=t,$("#deleteRuleModal").modal("show")},e.deleteRule.execute=function(){$("#deleteRuleModal").modal("hide"),a.deleteRule(e.deleteRule.obj.id,function(){e.deleteRule.clear(),l(),d()})},e.deleteRule.clear=function(){e.deleteRule.obj={},e.openDetailIndex=null,e.ruleDetail=null,$("#deleteRuleModal").modal("hide")},e.changeState=function(e,t){t.stopPropagation(),a.changeState({id:e.id,state:!e.enabled},function(){l(),d()})},function(){e.treeLoading=!0,n.getSiteMapTree({serverCode:e.user.serverCode},function(t){e.treeLoading=!1,e.zTree=n.createZTree(t),n.initTree(e.zTree.zNodes,"areaTree","radioSiteTree",function(){e.getCheckedNodeInSelect("areaTree")})})}(),function(){o.getAlarmLevelList({pageSize:9999,curPage:1,enterpriseCode:e.user.enterpriseCode,serverCode:e.user.serverCode},function(t){t?(e.alarmLevelList={data:t.map(function(e){return{id:e.level,text:e.levelName+"("+e.level+")"}})},e.alarmLevelListForFilter=t.map(function(e){return{levels:[e.level],name:e.levelName+"("+e.level+")"}})):e.alarmLevelList=[]})}()}]);