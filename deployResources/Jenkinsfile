pipeline {
     agent {
            docker {
                image 'maven:3-alpine'
                args '-v /home/mystox/respository:/root/.m2'
            }
        }
    parameters {
        string(name: 'host', defaultValue: '172.16.5.60', description: '')
        string(name: 'user', defaultValue: 'root', description: '')
        string(name: 'password', defaultValue: 'yytd1234', description: '')
        string(name: 'deployServer', defaultValue: 'all', description: '')
    }
    environment {
        def remote =''
    }
    stages {
        //编译
        stage ('Build') {
            steps {
                sh 'mvn -B -DskipTests clean package --settings /root/.m2/settings.xml'
            }
        }
         stage ('init-ssh') {
            steps {
                script {
                    remote = [:]
                    remote.name = 'remote-server'
                    remote.user = "${params.user}"
                    remote.password = "${params.password}"
                    remote.host = "${params.host}"
                    remote.allowAnyHosts = true
                }
            }
        }
        //告警-页面服务
        def serverCode = 'ALARM_SERVER_WEB_1.0.0'
        stage (serverCode) {
            when {
                expression {
                    def deployServer = params.deployServer
                    return (deployServer == 'all' || deployServer == serverCode || deployServer =~ serverCode+',' || deployServer =~ ','+serverCode)
                }
            }
            steps {
                script {
                        remoteExecutor('yyds-server-project/alarm-server/alarm-server-web/target/alarm-server-web-1.0.0.jar', \
                        '/home/yyds/alarm','alarm-server-web-1.0.0.jar',20,'deployResources/alarm-web.ini','alarm-web')
                }
            }
        }
         //报表-页面服务
        serverCode= 'REPORTS_SERVER_1.0.0'
        stage (serverCode) {
            when {
                expression {
                    def deployServer = params.deployServer
                    return (deployServer == 'all' || deployServer == serverCode || deployServer =~ serverCode+',' || deployServer =~ ','+serverCode)
                }
            }
            steps {
                script {
                        remoteExecutor('yyds-server-project/alarm-server/alarm-server-web/target/alarm-server-web-1.0.0.jar', \
                        '/home/yyds/alarm','alarm-server-web-1.0.0.jar',20,'deployResources/alarm-web.ini','alarm-web')
                }
            }
        }

    }

}


//远程部署方法
def remoteExecutor(sourcePath, path, jarName, time, initFile){
    sshCommand remote: remote, command: 'mkdir -p ' + path
    sshPut remote: remote, from: sourcePath, into: path + '/' + jarName
    sshPut remote: remote, from: initFile, into: '/etc/supervisord.d'
    sshCommand remote: remote, command: 'for i in {1..'+ time +'}; do echo -n \"Loop \$i \"; date ; sleep 1; done'
    sshCommand remote: remote, command: 'supervisorctl update'
    sshCommand remote: remote, command: 'supervisorctl restart '+ initFile
}